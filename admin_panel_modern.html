<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููุญุฉ ุงูุชุญูู - ุฒูุฒู ูุจูุงู (Modern)</title>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Modern Admin CSS -->
    <link rel="stylesheet" href="admin-modern.css">
</head>

<body>

    <!-- Main Layout -->
    <div class="admin-layout">

        <!-- Sidebar (Collapsible) -->
        <aside class="sidebar" id="sidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <div class="sidebar-logo">ุฒูุฒู ูุจูุงู</div>
            </div>

            <!-- Sidebar Navigation -->
            <nav class="sidebar-nav">
                <a href="#" class="sidebar-item active" data-tab="dashboard" data-tooltip="ููุญุฉ ุงูุชุญูู">
                    <i class="fa-solid fa-house"></i>
                    <span class="sidebar-item-label">ููุญุฉ ุงูุชุญูู</span>
                </a>

                <a href="#" class="sidebar-item" data-tab="lessons" data-tooltip="ุงูุฏุฑูุณ">
                    <i class="fa-solid fa-book"></i>
                    <span class="sidebar-item-label">ุงูุฏุฑูุณ</span>
                </a>

                <a href="#" class="sidebar-item" data-tab="categories" data-tooltip="ุงูุฃูุณุงู ุงูุฑุฆูุณูุฉ">
                    <i class="fa-solid fa-sitemap"></i>
                    <span class="sidebar-item-label">ุงูุฃูุณุงู ุงูุฑุฆูุณูุฉ</span>
                </a>

                <a href="#" class="sidebar-item" data-tab="sheikhs" data-tooltip="ุงูุดููุฎ">
                    <i class="fa-solid fa-user-tie"></i>
                    <span class="sidebar-item-label">ุงูุดููุฎ</span>
                </a>

                <a href="#" class="sidebar-item" data-tab="settings" data-tooltip="ุงูุฅุนุฏุงุฏุงุช">
                    <i class="fa-solid fa-gear"></i>
                    <span class="sidebar-item-label">ุงูุฅุนุฏุงุฏุงุช</span>
                </a>

                <a href="#" class="sidebar-item" data-tab="preview" data-tooltip="ูุนุงููุฉ">
                    <i class="fa-solid fa-eye"></i>
                    <span class="sidebar-item-label">ูุนุงููุฉ</span>
                </a>
            </nav>

            <!-- Sidebar Footer (Toggle Button) -->
            <div class="sidebar-footer">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fa-solid fa-angles-right"></i>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="topbar">
                <!-- Top Tabs (Optional) -->
                <div class="top-tabs">
                    <button class="top-tab active" data-tab="dashboard">Dashboard</button>
                    <button class="top-tab" data-tab="lessons">Lessons</button>
                    <button class="top-tab" data-tab="categories">Categories</button>
                </div>

                <!-- Command Palette Trigger -->
                <div class="command-trigger" id="commandTrigger">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <span>ุงุจุญุซ ุนู ุฃู ุดูุก...</span>
                    <kbd>Ctrl+K</kbd>
                </div>

                <!-- User Menu -->
                <div class="user-menu">
                    <div class="user-avatar">A</div>
                    <span class="user-name">Admin</span>
                    <i class="fa-solid fa-chevron-down"></i>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area" id="contentArea">

                <!-- Dashboard View -->
                <div class="view active" id="dashboardView">
                    <h1 class="mb-6" style="font-size: var(--text-3xl); font-weight: 700;">๐ ููุญุฉ ุงูุชุญูู</h1>

                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">๐</div>
                            <div class="stat-value" id="lessonsCount">0</div>
                            <div class="stat-label">ุงูุฏุฑูุณ</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">๐</div>
                            <div class="stat-value" id="categoriesCount">0</div>
                            <div class="stat-label">ุงูุฃูุณุงู</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">๐ฅ</div>
                            <div class="stat-value" id="sheikhsCount">0</div>
                            <div class="stat-label">ุงูุดููุฎ</div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">๐ ุขุฎุฑ ุงููุดุงุทุงุช</h2>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">ูุง ุชูุฌุฏ ูุดุงุทุงุช ุญุฏูุซุฉ.</p>
                        </div>
                    </div>
                </div>

                <!-- Categories View -->
                <div class="view" id="categoriesView" style="display:none;">
                    <h1 class="mb-6" style="font-size: var(--text-3xl); font-weight: 700;">๐ ุงูุฃูุณุงู ุงูุฑุฆูุณูุฉ</h1>

                    <!-- Breadcrumb -->
                    <div class="card mb-6" style="padding: var(--space-4);">
                        <div id="catBreadcrumb"
                            style="display: flex; align-items: center; gap: var(--space-2); color: var(--text-secondary);">
                            <i class="fa-solid fa-house" style="color: var(--accent-gold);"></i>
                            <span>ุงูุฑุฆูุณูุฉ</span>
                        </div>
                    </div>

                    <!-- Add Category Form -->
                    <div class="card mb-6">
                        <div class="card-header">
                            <h2 class="card-title">โ ุฅุถุงูุฉ ูุณู ุฌุฏูุฏ</h2>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; gap: var(--space-4);">
                                <div>
                                    <label
                                        style="display: block; margin-bottom: var(--space-2); color: var(--text-secondary);">ุงุณู
                                        ุงููุณู</label>
                                    <input type="text" id="catName" placeholder="ูุซุงู: ุงููุฑุขู ุงููุฑูู"
                                        style="width: 100%; padding: var(--space-3); background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-primary); font-size: var(--text-base);">
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-4);">
                                    <div>
                                        <label
                                            style="display: block; margin-bottom: var(--space-2); color: var(--text-secondary);">ุงูุฃููููุฉ
                                            (Font Awesome)</label>
                                        <input type="text" id="catIcon" placeholder="fa-solid fa-book"
                                            value="fa-solid fa-folder"
                                            style="width: 100%; padding: var(--space-3); background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-primary); font-size: var(--text-base);">
                                    </div>

                                    <div>
                                        <label
                                            style="display: block; margin-bottom: var(--space-2); color: var(--text-secondary);">ุงูููู</label>
                                        <input type="color" id="catColor" value="#DAA520"
                                            style="width: 100%; padding: var(--space-2); background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: 6px; height: 48px; cursor: pointer;">
                                    </div>
                                </div>

                                <div>
                                    <label
                                        style="display: block; margin-bottom: var(--space-2); color: var(--text-secondary);">ุงููุตู</label>
                                    <textarea id="catDesc" placeholder="ูุตู ุงููุณู..." rows="3"
                                        style="width: 100%; padding: var(--space-3); background: var(--bg-elevated); border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-primary); font-size: var(--text-base); resize: vertical;"></textarea>
                                </div>

                                <button onclick="addCategory()" class="btn btn-primary">
                                    <i class="fa-solid fa-plus"></i>
                                    ุฅุถุงูุฉ ุงููุณู
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Categories List -->
                    <div id="categoriesList"></div>
                </div>

                <!-- Other Views (Lessons, Sheikhs, etc.) -->
                <div class="view" id="lessonsView" style="display:none;">
                    <h1 class="mb-6" style="font-size: var(--text-3xl); font-weight: 700;">๐ ุงูุฏุฑูุณ</h1>
                    <div class="card">
                        <div class="card-body">
                            <p class="text-muted">ูุฑูุจุงู...</p>
                        </div>
                    </div>
                </div>

                <div class="view" id="sheikhsView" style="display:none;">
                    <h1 class="mb-6" style="font-size: var(--text-3xl); font-weight: 700;">๐ฅ ุงูุดููุฎ</h1>
                    <div class="card">
                        <div class="card-body">
                            <p class="text-muted">ูุฑูุจุงู...</p>
                        </div>
                    </div>
                </div>

                <div class="view" id="settingsView" style="display:none;">
                    <h1 class="mb-6" style="font-size: var(--text-3xl); font-weight: 700;">โ๏ธ ุงูุฅุนุฏุงุฏุงุช</h1>
                    <div class="card">
                        <div class="card-body">
                            <p class="text-muted">ูุฑูุจุงู...</p>
                        </div>
                    </div>
                </div>

                <div class="view" id="previewView" style="display:none;">
                    <h1 class="mb-6" style="font-size: var(--text-3xl); font-weight: 700;">๐๏ธ ุงููุนุงููุฉ</h1>
                    <div class="card">
                        <div class="card-body">
                            <p class="text-muted">ูุฑูุจุงู...</p>
                        </div>
                    </div>
                </div>

            </div>
        </main>

    </div>

    <!-- Command Palette Modal -->
    <div class="command-palette" id="commandPalette">
        <div class="command-palette-content">
            <input type="text" class="command-palette-input" id="commandInput" placeholder="ุงุจุญุซ ุนู ุฃู shูุก...">
            <div class="command-palette-results" id="commandResults">
                <div class="command-item">
                    <i class="fa-solid fa-plus"></i>
                    <span class="command-item-label">ุฅุถุงูุฉ ุฏุฑุณ ุฌุฏูุฏ</span>
                </div>
                <div class="command-item">
                    <i class="fa-solid fa-folder-plus"></i>
                    <span class="command-item-label">ุฅูุดุงุก ูุณู ุฌุฏูุฏ</span>
                </div>
                <div class="command-item">
                    <i class="fa-solid fa-user-plus"></i>
                    <span class="command-item-label">ุฅุถุงูุฉ ุดูุฎ</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===================================
        // State Management
        // ===================================
        let currentParentId = null;
        let allCategories = [];

        // ===================================
        // Sidebar Toggle
        // ===================================
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');

        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('expanded');
        });

        // ===================================
        // Tab/View Switching
        // ===================================
        const sidebarItems = document.querySelectorAll('.sidebar-item');
        const topTabs = document.querySelectorAll('.top-tab');
        const views = document.querySelectorAll('.view');

        function switchView(tabName) {
            // Update sidebar
            sidebarItems.forEach(item => {
                if (item.dataset.tab === tabName) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // Update top tabs
            topTabs.forEach(tab => {
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // Update views
            views.forEach(view => {
                if (view.id === tabName + 'View') {
                    view.style.display = 'block';
                } else {
                    view.style.display = 'none';
                }
            });

            // Load data for specific views
            if (tabName === 'categories') {
                loadCategories(null);
            }
        }

        sidebarItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                switchView(item.dataset.tab);
            });
        });

        topTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                switchView(tab.dataset.tab);
            });
        });

        // ===================================
        // Command Palette
        // ===================================
        const commandPalette = document.getElementById('commandPalette');
        const commandTrigger = document.getElementById('commandTrigger');

        commandTrigger.addEventListener('click', () => {
            commandPalette.classList.add('active');
            document.getElementById('commandInput').focus();
        });

        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                commandPalette.classList.add('active');
                document.getElementById('commandInput').focus();
            }

            if (e.key === 'Escape') {
                commandPalette.classList.remove('active');
            }
        });

        commandPalette.addEventListener('click', (e) => {
            if (e.target === commandPalette) {
                commandPalette.classList.remove('active');
            }
        });

        // ===================================
        // Categories API Functions
        // ===================================
        async function loadStats() {
            try {
                // Load counts
                const categoriesRes = await fetch('/api/categories/all');
                const categories = await categoriesRes.json();
                document.getElementById('categoriesCount').textContent = categories.length;

                // TODO: Load lessons and sheikhs count when APIs are ready
            } catch (err) {
                console.error('Load stats error:', err);
            }
        }

        async function loadCategories(parentId) {
            currentParentId = parentId;

            try {
                const url = parentId
                    ? `/api/categories/children/${parentId}`
                    : '/api/categories/all';
                const res = await fetch(url);
                let categories = await res.json();

                if (!parentId) {
                    categories = categories.filter(c => !c.parentId);
                }

                allCategories = categories;
                renderCategories(categories);
                renderBreadcrumb();

            } catch (error) {
                console.error('Load categories error:', error);
                document.getElementById('categoriesList').innerHTML = `
                    <div class="card" style="background: rgba(231,76,60,0.1); border-color: #e74c3c;">
                        <div class="card-body">โ ูุดู ุชุญููู ุงูุฃูุณุงู</div>
                    </div>
                `;
            }
        }

        function renderCategories(categories) {
            const container = document.getElementById('categoriesList');

            if (categories.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="card-body text-muted">
                            ${currentParentId ? 'ูุง ุชูุฌุฏ ุฃูุณุงู ูุฑุนูุฉ.' : 'ูุง ุชูุฌุฏ ุฃูุณุงู ุฑุฆูุณูุฉ. ุงุจุฏุฃ ุจุฅุถุงูุฉ ูุณู ุฌุฏูุฏ!'}
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: var(--space-6);">
                    ${categories.map(cat => `
                        <div class="card" style="cursor: pointer;">
                            <div class="card-header">
                                <div style="display: flex; align-items: center; gap: var(--space-3);">
                                    <i class="${cat.icon}" style="color: ${cat.color}; font-size: var(--icon-lg);"></i>
                                    <span class="card-title">${cat.name}</span>
                                </div>
                            </div>
                            <div class="card-body">
                                <p class="text-secondary" style="margin-bottom: var(--space-4);">${cat.description || 'ูุง ููุฌุฏ ูุตู'}</p>
                                <div style="display: flex; gap: var(--space-2);">
                                    <button onclick="loadCategories('${cat._id}')" class="btn btn-secondary btn-icon" title="ูุชุญ">
                                        <i class="fa-solid fa-folder-open"></i>
                                    </button>
                                    <button onclick="deleteCategory('${cat._id}')" class="btn btn-secondary btn-icon" title="ุญุฐู">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderBreadcrumb() {
            const breadcrumb = document.getElementById('catBreadcrumb');
            breadcrumb.innerHTML = `
                <i class="fa-solid fa-house" style="color: var(--accent-gold);"></i>
                <a href="#" onclick="loadCategories(null); return false;" style="color: var(--text-secondary); text-decoration: none;">ุงูุฑุฆูุณูุฉ</a>
                ${currentParentId ? '<i class="fa-solid fa-chevron-left" style="font-size: var(--text-xs);"></i>' : ''}
                ${currentParentId ? '<span style="color: var(--text-primary);">...</span>' : ''}
            `;
        }

        async function addCategory() {
            const name = document.getElementById('catName').value.trim();
            const icon = document.getElementById('catIcon').value.trim() || 'fa-solid fa-folder';
            const color = document.getElementById('catColor').value || '#DAA520';
            const description = document.getElementById('catDesc').value.trim();

            if (!name) {
                alert('ุฃุฏุฎู ุงุณู ุงููุณู!');
                return;
            }

            try {
                const res = await fetch('/api/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        icon,
                        color,
                        description,
                        parentId: currentParentId
                    })
                });

                if (res.ok) {
                    // Clear form
                    document.getElementById('catName').value = '';
                    document.getElementById('catDesc').value = '';
                    document.getElementById('catIcon').value = 'fa-solid fa-folder';
                    document.getElementById('catColor').value = '#DAA520';

                    // Reload
                    loadCategories(currentParentId);
                    loadStats();
                } else {
                    alert('ูุดูุช ุงูุฅุถุงูุฉ!');
                }
            } catch (err) {
                console.error('Add category error:', err);
                alert('ุญุฏุซ ุฎุทุฃ!');
            }
        }

        async function deleteCategory(id) {
            if (!confirm('ูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงููุณู ููู ุฃูุณุงูู ุงููุฑุนูุฉุ')) return;

            try {
                const res = await fetch(`/api/categories/${id}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    loadCategories(currentParentId);
                    loadStats();
                } else {
                    alert('ูุดู ุงูุญุฐู!');
                }
            } catch (err) {
                console.error('Delete error:', err);
                alert('ุญุฏุซ ุฎุทุฃ!');
            }
        }

        // ===================================
        // Initialize
        // ===================================
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadCategories(null);
        });
    </script>

</body>

</html>