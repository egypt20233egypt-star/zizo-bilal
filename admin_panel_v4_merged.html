<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Admin Panel v4</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap 5 RTL -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        :root {
            /* ğŸ¨ Modern Color System */
            --bg-primary: #0a0a0f;
            --bg-secondary: #111116;
            --bg-elevated: #1a1a22;
            --bg-hover: #202029;

            --border: rgba(255, 255, 255, 0.08);
            --border-hover: rgba(255, 255, 255, 0.15);
            --border-focus: rgba(108, 92, 231, 0.4);

            --accent: #6C5CE7;
            --accent-soft: rgba(108, 92, 231, 0.12);
            --accent-hover: #5847D0;

            --success: #00D68F;
            --success-soft: rgba(0, 214, 143, 0.12);

            --warning: #FFB800;
            --warning-soft: rgba(255, 184, 0, 0.12);

            --danger: #FF3B5C;
            --danger-soft: rgba(255, 59, 92, 0.12);

            --text-primary: #EDEDF0;
            --text-secondary: #8B8B9E;
            --text-muted: #5A5A6B;

            /* Legacy (for compatibility) */
            --gold: var(--accent);
            --dark: var(--bg-primary);
            --darker: var(--bg-secondary);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ============ Bootstrap 5 Overrides (Dark Theme) ============ */
        .form-control,
        .form-select {
            background-color: var(--bg-elevated) !important;
            border-color: var(--border) !important;
            color: var(--text-primary) !important;
            font-family: 'Cairo', sans-serif;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--accent) !important;
            box-shadow: 0 0 0 0.2rem var(--accent-soft) !important;
            background-color: var(--bg-elevated) !important;
        }

        .form-control::placeholder {
            color: var(--text-muted) !important;
        }

        .card {
            background: var(--bg-secondary);
            border-color: var(--border);
        }

        .modal-content {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .dropdown-menu {
            background: var(--bg-elevated);
            border-color: var(--border);
        }

        .dropdown-item {
            color: var(--text-primary);
        }

        .dropdown-item:hover {
            background: var(--bg-hover);
            color: var(--accent);
        }

        /* Bootstrap badge overrides */
        .badge.bg-success-soft {
            background: var(--success-soft) !important;
            color: var(--success) !important;
        }

        .badge.bg-warning-soft {
            background: var(--warning-soft) !important;
            color: var(--warning) !important;
        }

        .badge.bg-danger-soft {
            background: var(--danger-soft) !important;
            color: var(--danger) !important;
        }

        .badge.bg-accent-soft {
            background: var(--accent-soft) !important;
            color: var(--accent) !important;
        }

        /* ============ Floating Action Button (FAB) ============ */
        .fab-container {
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 9999;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            gap: 12px;
        }

        .fab-main {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), var(--accent-hover));
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(108, 92, 231, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .fab-main:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 8px 30px rgba(108, 92, 231, 0.6);
        }

        .fab-main.active {
            transform: rotate(45deg);
            background: linear-gradient(135deg, var(--danger), #ff5577);
        }

        .fab-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .fab-actions.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .fab-action {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
            position: relative;
        }

        .fab-action:hover {
            transform: scale(1.15);
        }

        .fab-action .fab-tooltip {
            position: absolute;
            right: 60px;
            background: var(--bg-elevated);
            color: var(--text-primary);
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 13px;
            white-space: nowrap;
            border: 1px solid var(--border);
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .fab-action:hover .fab-tooltip {
            opacity: 1;
        }

        .fab-lesson {
            background: linear-gradient(135deg, var(--success), #00e6a0);
        }

        .fab-ai {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
        }

        .fab-import {
            background: linear-gradient(135deg, #e67e22, #f39c12);
        }

        .fab-top {
            background: linear-gradient(135deg, var(--text-muted), var(--text-secondary));
        }

        /* ============ Panel Entry Animations ============ */
        .panel {
            animation: none;
        }

        .panel.active {
            animation: panelFadeIn 0.4s ease-out;
        }

        @keyframes panelFadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Stat cards stagger animation */
        .stat-card {
            animation: statBounceIn 0.5s ease-out both;
        }

        .stat-card:nth-child(1) {
            animation-delay: 0.1s;
        }

        .stat-card:nth-child(2) {
            animation-delay: 0.2s;
        }

        .stat-card:nth-child(3) {
            animation-delay: 0.3s;
        }

        @keyframes statBounceIn {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(20px);
            }

            60% {
                transform: scale(1.05) translateY(-5px);
            }

            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        /* Tab hover ripple effect */
        .tab {
            position: relative;
            overflow: hidden;
        }

        .tab::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(108, 92, 231, 0.15);
            border-radius: 50%;
            transition: width 0.4s, height 0.4s, top 0.4s, left 0.4s;
        }

        .tab:hover::after {
            width: 200px;
            height: 200px;
            top: calc(50% - 100px);
            left: calc(50% - 100px);
        }

        /* List item hover animation */
        .list-item {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .list-item:hover {
            transform: translateX(-4px);
            box-shadow: 4px 0 0 var(--accent);
        }

        /* Pulse animation for active stats */
        @keyframes gentlePulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 var(--accent-soft);
            }

            50% {
                box-shadow: 0 0 0 8px transparent;
            }
        }


        body {
            font-family: 'Cairo', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* ========================================
           Icon Styling (Font Awesome)
           ======================================== */
        .stat-card i,
        .tab i,
        .panel h2 i,
        label i {
            margin-left: 8px;
            opacity: 0.9;
            vertical-align: middle;
        }

        .stat-card i {
            font-size: 1.1em;
            color: var(--accent);
        }

        .tab i {
            font-size: 0.9em;
        }

        .panel h2 i {
            font-size: 0.95em;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo h1 {
            color: var(--accent);
            font-size: 1.6rem;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            padding: 0.6rem 1.5rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-elevated);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            font-weight: 600;
        }

        .btn:hover {
            background: var(--bg-hover);
            border-color: var(--border-hover);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-success {
            background: var(--success);
            color: white;
            border: none;
        }

        .btn-success:hover {
            filter: brightness(1.1);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            border: none;
        }

        .btn-danger:hover {
            filter: brightness(1.1);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.2s;
        }

        .stat-card:hover {
            border-color: var(--border-hover);
            background: var(--bg-elevated);
        }

        .stat-card h3 {
            font-size: 2.5rem;
            color: var(--accent);
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .stat-card p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .tab {
            padding: 0.8rem 1.5rem;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            font-weight: 600;
        }

        .tab:hover {
            background: var(--bg-elevated);
            border-color: var(--border-hover);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--accent-soft);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Panels */
        .panel {
            display: none;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
        }

        .panel.active {
            display: block;
        }

        .panel h2 {
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            font-weight: 700;
        }

        /* Form */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9rem;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: inherit;
            transition: all 0.2s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--border-focus);
            background: var(--bg-elevated);
        }

        textarea {
            min-height: 150px;
            resize: vertical;
        }

        /* List Items */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-elevated);
            border-radius: 8px;
            margin-bottom: 0.8rem;
            border: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 1rem;
            transition: all 0.2s;
        }

        .list-item:hover {
            border-color: var(--border-hover);
            background: var(--bg-hover);
        }

        .badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-success {
            background: var(--success-soft);
            color: var(--success);
        }

        .badge-warning {
            background: var(--warning-soft);
            color: var(--warning);
        }

        .badge-draft {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-secondary);
        }

        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            background: var(--accent-soft);
            border: 1px solid var(--accent);
            color: var(--text-primary);
        }

        /* Section Cards */
        .section-card {
            background: var(--bg-elevated);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
        }

        .section-card h4 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .content-box {
            background: var(--bg-primary);
            padding: 0.8rem;
            border-radius: 5px;
            margin-top: 0.5rem;
            white-space: pre-wrap;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }

            .container {
                padding: 0 1rem;
            }
        }

        /* Import Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s;
        }

        .close-btn:hover {
            color: var(--text-primary);
        }

        .import-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .import-tab {
            padding: 0.8rem 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: var(--text);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .import-tab:hover,
        .import-tab.active {
            background: var(--gold);
            color: var(--dark);
            border-color: var(--gold);
        }

        .preview-sections {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }

        /* ========================================
           ğŸŒ³ Tree View Styles (Modern)
           ======================================== */
        .tree-view-container {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-top: 1rem;
        }

        .tree-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .btn-tree-action {
            padding: 0.4rem 1rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 150ms;
        }

        .btn-tree-action:hover {
            background: var(--bg-hover);
            border-color: var(--border-hover);
        }

        .tree-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .tree-children {
            list-style: none;
            margin: 0;
            padding: 0;
            margin-right: 24px;
            border-right: 1px solid var(--border);
            padding-top: 0.25rem;
        }

        .tree-item {
            margin: 0;
            padding: 0;
        }

        .tree-item-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 6px;
            margin-bottom: 2px;
            transition: all 150ms;
        }

        .tree-item-content:hover {
            background: var(--bg-elevated);
            border-color: var(--border);
        }

        .tree-item-content:hover .tree-actions {
            opacity: 1;
        }

        .tree-toggle {
            width: 20px;
            height: 20px;
            padding: 0;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 150ms;
        }

        .tree-toggle i {
            font-size: 12px;
        }

        .tree-toggle.expanded i {
            transform: rotate(-90deg);
        }

        .tree-spacer {
            width: 20px;
        }

        .tree-icon {
            font-size: 16px;
            min-width: 20px;
        }

        .tree-label {
            flex: 1;
            font-size: 0.875rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .tree-actions {
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity 150ms;
        }

        .btn-tree-icon {
            width: 24px;
            height: 24px;
            padding: 0;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 150ms;
        }

        .btn-tree-icon:hover {
            background: var(--accent);
            color: white;
        }

        .btn-tree-icon i {
            font-size: 12px;
        }

        .tree-item.active>.tree-item-content {
            background: var(--accent-soft);
            border-color: var(--accent);
        }

        /* ========================================
           ğŸ¯ Category Picker (Modern)
           ======================================== */
        .category-picker {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.5rem;
        }

        .category-picker.error {
            border-color: var(--danger);
            animation: catShake 0.3s;
        }

        @keyframes catShake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        .category-breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            flex-wrap: wrap;
            min-height: 32px;
            padding: 0.4rem 0.75rem;
            background: var(--accent-soft);
            border-radius: 6px;
            margin-bottom: 0.75rem;
            font-size: 0.85rem;
        }

        .crumb-item {
            color: var(--accent);
            font-weight: 600;
        }

        .crumb-sep {
            color: var(--text-muted);
            font-size: 0.7rem;
        }

        .crumb-placeholder {
            color: var(--text-secondary);
            font-style: italic;
        }

        .category-levels {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .category-level-wrap {
            flex: 1;
            min-width: 180px;
        }

        .category-level-wrap label {
            display: block;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 4px;
        }

        .category-level-wrap select {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.875rem;
            cursor: pointer;
        }

        .category-level-wrap select:focus {
            border-color: var(--gold);
            outline: none;
        }

        /* ============ Phase 4: Dynamic Section Editor ============ */
        .section-editor {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .section-editor:hover {
            border-color: var(--accent);
        }

        .section-editor-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .section-editor-header:hover {
            background: var(--bg-hover);
        }

        .section-icon {
            font-size: 1.2em;
        }

        .section-label {
            flex: 1;
            font-weight: 600;
            color: var(--text-primary);
        }

        .section-hint {
            font-size: 0.75em;
            padding: 2px 8px;
            background: var(--accent-soft);
            color: var(--accent);
            border-radius: 12px;
        }

        .section-toggle {
            transition: transform 0.3s;
            color: var(--text-secondary);
        }

        .section-editor.open .section-toggle {
            transform: rotate(180deg);
        }

        .section-editor-body {
            padding: 0 16px 16px;
        }

        .section-input {
            width: 100%;
            box-sizing: border-box;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            direction: rtl;
        }

        .section-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
        }

        .json-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .json-toolbar button {
            padding: 4px 10px;
            background: var(--accent-soft);
            border: 1px solid var(--accent);
            border-radius: 6px;
            color: var(--accent);
            cursor: pointer;
            font-size: 12px;
        }

        .json-toolbar button:hover {
            filter: brightness(1.2);
        }

        .json-status {
            margin-right: auto;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .dynamic-list-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }

        .dynamic-list-item {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .dynamic-list-item input {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .btn-add-item {
            padding: 6px 14px;
            background: transparent;
            border: 1px dashed var(--accent);
            border-radius: 6px;
            color: var(--accent);
            cursor: pointer;
            font-size: 13px;
        }

        .btn-add-item:hover {
            background: var(--accent-soft);
        }

        .btn-remove-item {
            padding: 4px 8px;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid var(--danger);
            border-radius: 6px;
            color: var(--danger);
            cursor: pointer;
            font-size: 12px;
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .basic-fields {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .editor-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .loading-sections {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .sections-container-label {
            color: var(--accent);
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ============ Phase 4: Toast Notifications ============ */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }

        .toast {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            pointer-events: auto;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            min-width: 280px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast-success {
            background: linear-gradient(135deg, #059669, #10b981);
        }

        .toast-error {
            background: linear-gradient(135deg, #dc2626, #ef4444);
        }

        .toast-warning {
            background: linear-gradient(135deg, #d97706, #f59e0b);
        }

        .toast-info {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
        }

        .toast-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            opacity: 0.7;
            margin-right: auto;
            font-size: 16px;
        }

        .toast-close:hover {
            opacity: 1;
        }

        /* ============ Phase 4: Auto-Save Indicator ============ */
        #autosave-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            font-size: 12px;
            color: var(--text-secondary);
            opacity: 0.6;
            z-index: 999;
        }
    </style>

</head>

<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <div>
                <h1>Ø¹ÙÙ„Ù’Ù…ÙŒ ÙŠÙÙ†Ù’ØªÙÙÙØ¹Ù Ø¨ÙÙ‡Ù</h1>
                <div style="font-size: 0.85rem; color: var(--text-secondary);">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                </div>
            </div>
        </div>
        <div class="user-info">
            <span id="username" style="color: var(--gold); font-weight: 600;"></span>
            <a href="/api/admin/logout" class="btn"><i class="fa-solid fa-right-from-bracket"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
        </div>
    </div>

    <div class="container">
        <!-- Stats -->
        <div class="stats">
            <div class="stat-card">
                <h3 id="sectionsCount">0</h3>
                <p><i class="fa-solid fa-book-open"></i> Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</p>
            </div>
            <div class="stat-card">
                <h3 id="sheikhsCount">0</h3>
                <p><i class="fa-solid fa-user"></i> Ø§Ù„Ø´ÙŠÙˆØ®</p>
            </div>
            <div class="stat-card">
                <h3 id="lessonsCount">0</h3>
                <p><i class="fa-solid fa-book-quran"></i> Ø§Ù„Ø¯Ø±ÙˆØ³</p>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('aiInput')"><i class="fa-solid fa-wand-magic-sparkles"></i> AI
                Master Input</button>
            <button class="tab" onclick="showTab('categories')"><i class="fa-solid fa-sitemap"></i> Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <button class="tab" onclick="showTab('sections')"><i class="fa-solid fa-book-open"></i> Ø£Ù‚Ø³Ø§Ù…
                Ø§Ù„Ø¯Ø±ÙˆØ³</button>
            <button class="tab" onclick="showTab('sheikhs')"><i class="fa-solid fa-user"></i> Ø§Ù„Ø´ÙŠÙˆØ®</button>
            <button class="tab" onclick="showTab('lessons')"><i class="fa-solid fa-book-quran"></i> Ø§Ù„Ø¯Ø±ÙˆØ³</button>
            <button class="tab" onclick="showTab('addLesson')"><i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³</button>
            <button class="tab" onclick="showTab('preview')"><i class="fa-solid fa-eye"></i> Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
        </div>

        <!-- AI Input Panel -->
        <div id="aiInput" class="panel active">
            <h2><i class="fa-solid fa-wand-magic-sparkles"></i> Ø­Ù‚Ù„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Master Input)</h2>
            <p style="color: rgba(255,255,255,0.7); margin-bottom: 1.5rem;">
                Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø§Ù… Ù‡Ù†Ø§ØŒ ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù‡ÙŠÙˆØ²Ø¹Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©.
            </p>
            <textarea id="rawInput" placeholder="Ù…Ø«Ø§Ù„: Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø¯Ø±Ø³ØŒ Ø£Ùˆ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ØŒ Ø£Ùˆ Ø£ÙŠ Ù…Ø­ØªÙˆÙ‰ Ù†ØµÙŠ..."
                style="min-height: 250px;"></textarea>
            <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="analyzeWithAI()">
                    <i class="fa-solid fa-sparkles"></i> ØªØ­Ù„ÙŠÙ„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
                </button>
                <button class="btn" onclick="saveDraft()">
                    <i class="fa-solid fa-floppy-disk"></i> Ø­ÙØ¸ ÙƒÙ…Ø³ÙˆØ¯Ø©
                </button>
                <button class="btn" onclick="clearInput()">
                    <i class="fa-solid fa-trash-can"></i> Ù…Ø³Ø­
                </button>
            </div>

            <h3 style="color: var(--gold); margin: 2rem 0 1rem;">
                <i class="fa-solid fa-folder-tree"></i> Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø© <span
                    style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">(Ø³ÙŠØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                    Ø¹Ù„ÙŠÙ‡Ø§)</span>
            </h3>
            <div id="availableSections"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
                <div class="alert">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…...</div>
            </div>
        </div>

        <!-- ============ Categories Panel (Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„Ù‡Ø±Ù…ÙŠØ©) ============ -->
        <div id="categories" class="panel">
            <h2><i class="fa-solid fa-sitemap" style="color: var(--gold)"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
            <div class="alert">
                <i class="fa-solid fa-circle-info"></i> Ù†Ø¸Ø§Ù… Ù‡Ø±Ù…ÙŠ Ù…Ø±Ù† - Ø£Ø¶Ù Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¬ÙˆØ§ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¨Ø±Ø§Ø­ØªÙƒ Ø¨Ù„Ø§ Ø­Ø¯ÙˆØ¯!
            </div>

            <!-- Breadcrumb Navigation -->
            <div id="catBreadcrumb"
                style="display:flex; align-items:center; gap:8px; margin:15px 0; flex-wrap:wrap; font-size:0.95rem;">
                <span onclick="loadCategories(null)" style="cursor:pointer; color:var(--gold); font-weight:700;"><i
                        class="fa-solid fa-house"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </div>

            <!-- Add Category Form -->
            <div
                style="background:rgba(218,165,32,0.08); border:1px solid rgba(218,165,32,0.25); border-radius:12px; padding:18px; margin-bottom:20px;">
                <h4 style="color:var(--gold); margin-bottom:12px;"><i class="fa-solid fa-circle-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…
                    Ø¬Ø¯ÙŠØ¯</h4>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div class="form-group" style="margin:0">
                        <label>Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…</label>
                        <input type="text" id="catName" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…">
                    </div>
                    <div class="form-group" style="margin:0">
                        <label>Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input type="text" id="catDesc" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ±">
                    </div>
                </div>
                <div style="display:flex; gap:12px; margin-top:12px; align-items:flex-end; flex-wrap:wrap;">
                    <div class="form-group" style="margin:0; flex:1">
                        <label>Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© (Font Awesome)</label>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="text" id="catIcon" value="fa-solid fa-folder" style="flex:1"
                                oninput="previewIcon()">
                            <div id="catIconPreview"
                                style="width:45px; height:45px; display:flex; align-items:center; justify-content:center; background:rgba(218,165,32,0.15); border-radius:10px; font-size:1.4rem; color:#DAA520;">
                                <i class="fa-solid fa-folder"></i>
                            </div>
                        </div>
                    </div>
                    <div class="form-group" style="margin:0; width:120px;">
                        <label>Ø§Ù„Ù„ÙˆÙ†</label>
                        <input type="color" id="catColor" value="#DAA520"
                            style="height:42px; width:100%; border:none; border-radius:8px; cursor:pointer;">
                    </div>
                    <button class="btn btn-primary" onclick="addCategory()" style="height:42px; white-space:nowrap;">
                        <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ©
                    </button>
                </div>

                <!-- Popular Icons Grid -->
                <div style="margin-top:12px;">
                    <small style="color:rgba(255,255,255,0.5);">Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø³Ø±ÙŠØ¹Ø©:</small>
                    <div id="quickIcons" style="display:flex; flex-wrap:wrap; gap:6px; margin-top:6px;"></div>
                </div>
            </div>

            <!-- Categories Tree View -->
            <div class="tree-view-container">
                <div class="tree-controls">
                    <button class="btn-tree-action" onclick="expandAllTree()">
                        <i class="fa-solid fa-angles-down"></i> Expand All
                    </button>
                    <button class="btn-tree-action" onclick="collapseAllTree()">
                        <i class="fa-solid fa-angles-up"></i> Collapse All
                    </button>
                    <button class="btn-tree-action" onclick="reloadCategoryTree()">
                        <i class="fa-solid fa-rotate"></i> Reload
                    </button>
                </div>

                <ul class="tree-list" id="categoryTreeRoot">
                    <!-- Tree will be rendered here by JS -->
                </ul>
            </div>
        </div>

        <!-- Sections Panel -->
        <div id="sections" class="panel">
            <h2><i class="fa-solid fa-book-open"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©)</h2>
            <div class="alert">
                <i class="fa-solid fa-circle-info"></i> Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© - ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ø­Ø°Ù Ø£ÙŠ Ù‚Ø³Ù… Ù…Ù† MongoDB
            </div>
            <button class="btn btn-primary" onclick="seedSections()"><i class="fa-solid fa-seedling"></i> Ù…Ù„Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (15 Ù‚Ø³Ù…)</button>
            <hr style="margin: 1.5rem 0; border-color: rgba(212,175,55,0.3)">

            <div class="form-group">
                <label>Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯</label>
                <div style="display:flex; gap:10px; flex-wrap:wrap">
                    <input type="text" id="newSectionKey" placeholder="sectionKey (Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ)" style="flex:1">
                    <input type="text" id="newSectionLabel" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ" style="flex:1">
                    <input type="text" id="newSectionIcon" placeholder="fa-book-quran" style="width:80px">
                    <button class="btn btn-primary" onclick="addSection()">Ø¥Ø¶Ø§ÙØ©</button>
                </div>
            </div>

            <div id="sectionsList"></div>
        </div>

        <!-- Sheikhs Panel -->
        <div id="sheikhs" class="panel">
            <h2><i class="fa-solid fa-user"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´ÙŠÙˆØ®</h2>
            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ø´ÙŠØ®</label>
                <div style="display:flex; gap:10px">
                    <input type="text" id="sheikhName" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø´ÙŠØ® Ø§Ù„Ø´Ø¹Ø±Ø§ÙˆÙŠ" style="flex:1">
                    <button class="btn btn-primary" onclick="addSheikh()"><i class="fa-solid fa-plus"></i>
                        Ø¥Ø¶Ø§ÙØ©</button>
                </div>
            </div>
            <hr style="margin: 1.5rem 0; border-color: rgba(212,175,55,0.3)">
            <div id="sheikhsList"></div>
        </div>

        <!-- Lessons Panel -->
        <div id="lessons" class="panel">
            <h2><i class="fa-solid fa-book-quran"></i> Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…Ø¶Ø§ÙØ©</h2>
            <div style="margin-bottom: 1rem;">
                <button class="btn btn-primary" onclick="openNewLessonEditor()">
                    <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯
                </button>
            </div>
            <div id="lessonsList"></div>
        </div>

        <!-- Add Lesson Panel (Dynamic) -->
        <div id="addLesson" class="panel">
            <div class="editor-header">
                <h2 id="formTitle"><i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯</h2>
                <button class="btn" onclick="cancelEdit()" id="cancelEditBtn" style="display:none;">
                    <i class="fa-solid fa-arrow-right"></i> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                </button>
            </div>

            <!-- Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø«Ø§Ø¨ØªØ©) -->
            <div class="basic-fields">
                <div class="form-group">
                    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³ <span style="color:#e74c3c">*</span></label>
                    <input type="text" id="lessonTitle" placeholder="Ù…Ø«Ø§Ù„: Ø¯Ø±Ø³ Ø¹Ù† Ù…ØµØ¹Ø¨ Ø¨Ù† Ø¹Ù…ÙŠØ±">
                </div>
                <div class="form-group">
                    <label>Ø¹Ù†ÙˆØ§Ù† ÙØ±Ø¹ÙŠ</label>
                    <input type="text" id="lessonSubtitle" placeholder="Ø¹Ù†ÙˆØ§Ù† ÙØ±Ø¹ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø´ÙŠØ®</label>
                    <select id="lessonSheikh"></select>
                </div>
                <!-- ğŸ¯ Category Picker (Cascading) -->
                <div class="form-group" id="categoryPickerContainer">
                    <label><i class="fa-solid fa-folder-tree"></i> ØªØµÙ†ÙŠÙ Ø§Ù„Ø¯Ø±Ø³ <span
                            style="color:#e74c3c">*</span></label>
                    <div class="category-picker" id="categoryPicker">
                        <div class="category-breadcrumb" id="categoryBreadcrumb">
                            <span class="crumb-placeholder">Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ...</span>
                        </div>
                        <div class="category-levels" id="categoryLevels"></div>
                    </div>
                    <input type="hidden" id="selectedCategoryId" value="">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
                    <select id="lessonStatus">
                        <option value="draft">ğŸ“ Ù…Ø³ÙˆØ¯Ø©</option>
                        <option value="published">âœ… Ù…Ù†Ø´ÙˆØ±</option>
                    </select>
                </div>
            </div>

            <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø§Ù… -->
            <div class="form-group">
                <label>Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø§Ù… (Ø§Ù„ØªÙØ±ÙŠØº)</label>
                <textarea id="lessonContent" placeholder="Ø£Ù„ØµÙ‚ Ù‡Ù†Ø§ ØªÙØ±ÙŠØº Ø§Ù„Ø¯Ø±Ø³..."></textarea>
            </div>
            <div class="form-group"
                style="border: 1px dashed var(--gold); padding: 15px; border-radius: 10px; background: rgba(212,175,55,0.05);">
                <label style="color: var(--gold);">ğŸ”’ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ <small style="color:#999;">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ -
                        Ù„Ù„Ø£Ø¯Ù…Ù† ÙˆØ§Ù„Ù€ AI ÙÙ‚Ø·)</small></label>
                <textarea id="lessonRawSource"
                    placeholder="Ø£Ù„ØµÙ‚ Ù‡Ù†Ø§ Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ø´ÙŠØ® Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø³Ø±ÙŠØ©... (Ù„Ù† ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹)"
                    style="border-color: var(--gold); min-height: 100px;"></textarea>
                <small style="color:#888; display:block; margin-top:5px;">âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ Ù„Ø§ ÙŠØ¸Ù‡Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆÙ„Ø§ ÙŠØ¯Ø®Ù„ ÙÙŠ
                    Ø§Ù„ØªØ­Ù„ÙŠÙ„ - Ù„Ù„Ø­ÙØ¸ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ ÙÙ‚Ø·</small>
            </div>

            <!-- â­ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© (ØªØªØ¨Ù†Ù‰ Ù…Ù† SectionRegistry!) -->
            <div class="sections-container-label">
                <i class="fa-solid fa-puzzle-piece"></i> Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
                <small style="color: var(--text-secondary); font-weight: 400;">(ØªØªØ­Ù…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø©
                    Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)</small>
            </div>
            <div id="lesson-sections-container">
                <div class="loading-sections">
                    <i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…...
                </div>
            </div>

            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­ÙØ¸ -->
            <div class="editor-actions">
                <button class="btn btn-primary" id="saveDraftBtn" onclick="saveLessonDynamic(false)">
                    <i class="fa-solid fa-floppy-disk"></i> Ø­ÙØ¸ ÙƒÙ…Ø³ÙˆØ¯Ø©
                </button>
                <button class="btn btn-success" id="savePublishBtn" onclick="saveLessonDynamic(true)">
                    <i class="fa-solid fa-rocket"></i> Ù†Ø´Ø± Ù…Ø¨Ø§Ø´Ø±Ø©
                </button>
                <button class="btn" style="background: #9b59b6; color: white;" onclick="openImportModal()">
                    <i class="fa-solid fa-file-import"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON/Ù†Øµ
                </button>
            </div>
        </div>

        <!-- Preview Panel -->
        <div id="preview" class="panel">
            <h2><i class="fa-solid fa-eye"></i> Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>
            <div class="form-group">
                <label>Ø§Ø®ØªØ± Ø¯Ø±Ø³ Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</label>
                <select id="previewLesson" onchange="showPreview()"></select>
            </div>
            <div id="previewContent"></div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fa-solid fa-file-import"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø­ØªÙˆÙ‰ Ø®Ø§Ø±Ø¬ÙŠ</h2>
                <button class="close-btn" onclick="closeImportModal()">Ã—</button>
            </div>

            <!-- ğŸ”’ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ - ØªØµÙ…ÙŠÙ… Ø¨Ù†ÙØ³Ø¬ÙŠ -->
            <div
                style="background: linear-gradient(135deg, rgba(142,68,173,0.15), rgba(155,89,182,0.08)); border: 2px solid rgba(155,89,182,0.5); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                <label style="color: #9b59b6; font-weight: 700; font-size: 1rem; display: block; margin-bottom: 8px;">
                    ğŸ”’ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ
                    <span style="font-weight: 400; font-size: 0.8rem; color: #999;">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ù„Ù„Ø£Ø¯Ù…Ù† ÙˆØ§Ù„Ù€ AI
                        ÙÙ‚Ø·)</span>
                </label>
                <textarea id="importRawSource" placeholder="ğŸ“ Ø£Ù„ØµÙ‚ Ù‡Ù†Ø§ Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ø´ÙŠØ® Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ø§Ù„Ø³Ø±ÙŠØ©..."
                    style="border: 1px solid rgba(155,89,182,0.4); background: rgba(155,89,182,0.05); min-height: 80px; border-radius: 8px; width: 100%; box-sizing: border-box; padding: 10px; color: var(--text); font-family: inherit;"></textarea>
                <small style="color: #8e44ad; display: block; margin-top: 5px;">âš ï¸ ÙŠØªØ­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø· â€¢ Ù„Ø§ ÙŠØ¸Ù‡Ø±
                    ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ â€¢ Ù„Ù„Ù€ AI Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹</small>
            </div>

            <div class="import-tabs">
                <button class="import-tab active" onclick="setImportType('json')">ğŸ“¦ JSON Ø¬Ø§Ù‡Ø²</button>
                <button class="import-tab" onclick="setImportType('text')">ğŸ“ Ù†Øµ Ø¹Ø§Ø¯ÙŠ</button>
            </div>

            <div class="form-group">
                <label id="importLabel">Ø§Ù„ØµÙ‚ ÙƒÙˆØ¯ JSON Ù‡Ù†Ø§:</label>
                <textarea id="importContent" placeholder='{ "title": "...", "overview": {...} }'></textarea>
            </div>

            <div id="importResult"></div>
            <div id="previewSections" class="preview-sections" style="display:none;"></div>

            <div style="margin-top: 20px; display: flex; gap: 1rem;">
                <button class="btn" style="background: #3498db; color: white;" onclick="parseAndPreview()">ğŸ” Ù…Ø¹Ø§ÙŠÙ†Ø©
                    ÙˆØªØ­Ù„ÙŠÙ„</button>
                <button class="btn btn-success" onclick="applyImport()" id="applyBtn" disabled>âœ… ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰
                    Ø§Ù„Ø¯Ø±Ø³</button>
            </div>
        </div>
    </div>

    <script>
        // ============ Auth Check ============
        async function checkAuth() {
            try {
                const res = await fetch('/api/admin/check');
                const data = await res.json();

                if (!data.loggedIn) {
                    window.location.href = '/admin';
                    return;
                }

                document.getElementById('username').textContent = data.username || 'Admin';
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = '/admin';
            }
        }

        // ============ Tab Navigation ============
        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            // Find the clicked tab button
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => {
                if (t.textContent.includes(tabId === 'categories' ? 'Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' :
                    tabId === 'sections' ? 'Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¯Ø±ÙˆØ³' :
                        tabId === 'sheikhs' ? 'Ø§Ù„Ø´ÙŠÙˆØ®' :
                            tabId === 'lessons' ? 'Ø§Ù„Ø¯Ø±ÙˆØ³' :
                                tabId === 'addLesson' ? 'Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³' :
                                    tabId === 'preview' ? 'Ù…Ø¹Ø§ÙŠÙ†Ø©' : 'AI')) {
                    t.classList.add('active');
                }
            });
            document.getElementById(tabId).classList.add('active');

            if (tabId === 'preview') updatePreviewSelect();
            if (tabId === 'categories') loadCategories(currentParentId);
        }

        // ============ Sections ============
        let sections = [];

        async function loadSections() {
            try {
                const res = await fetch('/api/sections/variables');
                const data = await res.json();

                sections = data.sections || [];
                document.getElementById('sectionsCount').textContent = data.count || 0;

                // Display in AI tab
                document.getElementById('availableSections').innerHTML = sections.map(sec => `
                    <div class="section-card">
                        <h4>${sec.icon} ${sec.labelAr}</h4>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">${sec.key}</div>
                        <div style="font-size: 0.9rem; margin-top: 0.5rem;">${sec.description || ''}</div>
                    </div>
                `).join('');

                // Display in sections management tab
                const res2 = await fetch('/api/sections/all', {
                    credentials: 'include'
                });
                const allSections = await res2.json();

                document.getElementById('sectionsList').innerHTML = allSections.map(s => `
                    <div class="list-item">
                        <span>${s.icon} ${s.labelAr} <small style="color:#999;">(${s.sectionKey})</small></span>
                        <span class="badge ${s.isActive ? 'badge-success' : 'badge-warning'}">
                            ${s.isActive ? 'Ù†Ø´Ø·' : 'Ù…Ø¹Ø·Ù„'}
                        </span>
                        <button class="btn btn-danger" onclick="deleteSection('${s._id}')">Ø­Ø°Ù</button>
                    </div>
                `).join('') || '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù…</p>';

            } catch (error) {
                console.error('Error loading sections:', error);
                document.getElementById('availableSections').innerHTML = `
                    <div class="alert" style="background: rgba(231,76,60,0.2); border-color: #e74c3c;">
                        âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                    </div>
                `;
            }
        }

        // ============ Auth Check ============
        async function checkAuth() {
            console.log('ğŸ” [checkAuth] Starting authentication check...');
            try {
                const res = await fetch('/api/admin/check');
                console.log('ğŸ” [checkAuth] Response status:', res.status);

                const data = await res.json();
                console.log('ğŸ” [checkAuth] Response data:', data);

                if (!data.authenticated) {
                    // ØºÙŠØ± Ù…Ø³Ø¬Ù„ - Ø­ÙˆÙ‘Ù„Ù‡ Ù„Ù„Ù€ login
                    console.warn('âŒ [checkAuth] NOT authenticated - redirecting to /admin');
                    window.location.href = '/admin';
                    return;
                }

                // Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ - Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                console.log('âœ… [checkAuth] Authenticated as:', data.username);
                const usernameEl = document.getElementById('username');
                if (usernameEl) {
                    usernameEl.textContent = data.username || 'Admin';
                    console.log('âœ… [checkAuth] Username displayed:', usernameEl.textContent);
                } else {
                    console.warn('âš ï¸ [checkAuth] Username element not found!');
                }
            } catch (error) {
                console.error('âŒ [checkAuth] Error occurred:', error);
                // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ - Ø­ÙˆÙ‘Ù„Ù‡ Ù„Ù„Ù€ login Ù„Ù„Ø£Ù…Ø§Ù†
                console.warn('âŒ [checkAuth] Redirecting to /admin due to error');
                window.location.href = '/admin';
            }
        }

        async function seedSections() {
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ù„Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (15 Ù‚Ø³Ù…)ØŸ')) return;

            try {
                const res = await fetch('/scripts/seed_sections.js');
                const text = await res.text();
                eval(text); // Execute seed script

                alert('âœ… ØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­!');
                loadSections();
            } catch (error) {
                console.error('Seed error:', error);
                alert('âŒ ÙØ´Ù„ Ù…Ù„Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…. Ø§Ø³ØªØ®Ø¯Ù…: node scripts/seed_sections.js');
            }
        }

        async function addSection() {
            const key = document.getElementById('newSectionKey').value.trim();
            const labelAr = document.getElementById('newSectionLabel').value.trim();
            const icon = document.getElementById('newSectionIcon').value.trim() || '<i class="fa-solid fa-book-open"></i>';

            if (!key || !labelAr) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ù…Ù„Ø©');

            try {
                const res = await fetch('/api/sections', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ sectionKey: key, labelAr, icon, isActive: true })
                });

                if (res.ok) {
                    document.getElementById('newSectionKey').value = '';
                    document.getElementById('newSectionLabel').value = '';
                    document.getElementById('newSectionIcon').value = '';
                    loadSections();
                    alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù…');
                } else {
                    alert('âŒ ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù…');
                }
            } catch (error) {
                console.error('Add section error:', error);
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }

        async function deleteSection(id) {
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…ØŸ')) return;

            try {
                const res = await fetch(`/api/sections/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (res.ok) {
                    loadSections();
                    alert('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù');
                } else {
                    alert('âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
                }
            } catch (error) {
                console.error('Delete error:', error);
            }
        }

        // ============ Sheikhs (MongoDB API) ============
        let sheikhsList = [];

        async function loadSheikhs() {
            try {
                const res = await fetch('/api/sheikhs');
                sheikhsList = await res.json();
                document.getElementById('sheikhsCount').textContent = sheikhsList.length;

                document.getElementById('sheikhsList').innerHTML = sheikhsList.map(s => `
                    <div class="list-item">
                        <span><i class="fa-solid fa-user"></i> ${s.name}</span>
                        <button class="btn btn-danger" onclick="deleteSheikh('${s._id}')">Ø­Ø°Ù</button>
                    </div>
                `).join('') || '<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙŠÙˆØ®</p>';

                // Update select
                const select = document.getElementById('lessonSheikh');
                select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´ÙŠØ®</option>' +
                    sheikhsList.map(s => `<option value="${s._id}">${s.name}</option>`).join('');
            } catch (error) {
                console.error('Load sheikhs error:', error);
            }
        }

        async function addSheikh() {
            const name = document.getElementById('sheikhName').value.trim();
            if (!name) return alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø´ÙŠØ®');

            try {
                const res = await fetch('/api/sheikhs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                if (res.ok) {
                    document.getElementById('sheikhName').value = '';
                    loadSheikhs();
                    alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´ÙŠØ®');
                } else {
                    alert('âŒ ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´ÙŠØ®');
                }
            } catch (error) {
                console.error('Add sheikh error:', error);
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }

        async function deleteSheikh(id) {
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø´ÙŠØ®ØŸ')) return;
            try {
                const res = await fetch(`/api/sheikhs/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadSheikhs();
                    alert('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù');
                } else {
                    alert('âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
                }
            } catch (error) {
                console.error('Delete sheikh error:', error);
            }
        }

        // ============ Lessons (MongoDB) - Dynamic System ============
        let currentEditId = null;

        async function loadLessons() {
            try {
                const res = await fetch('/api/lessons');
                const lessons = await res.json();

                document.getElementById('lessonsCount').textContent = lessons.length;

                document.getElementById('lessonsList').innerHTML = lessons.map(l => {
                    const sheikhName = l.sheikhName || l.sheikhId || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const isPublished = l.status === 'published';
                    return `
                        <div class="list-item">
                            <div>
                                <strong><i class="fa-solid fa-book-quran"></i> ${l.title}</strong>
                                <small style="color:#999"> - ${sheikhName}</small>
                                <span class="badge badge-${isPublished ? 'success' : 'draft'}">
                                    ${isPublished ? 'Ù…Ù†Ø´ÙˆØ±' : 'Ù…Ø³ÙˆØ¯Ø©'}
                                </span>
                            </div>
                            <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                                <button class="btn" style="background:#3498db;color:white;" onclick="editLesson('${l._id}')"><i class="fa-solid fa-pen-to-square"></i> ØªØ¹Ø¯ÙŠÙ„</button>
                                <button class="btn btn-success" onclick="togglePublish('${l._id}', ${isPublished})">${isPublished ? '<i class="fa-solid fa-upload"></i> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù†Ø´Ø±' : '<i class="fa-solid fa-rocket"></i> Ù†Ø´Ø±'}</button>
                                <button class="btn btn-danger" onclick="deleteLesson('${l._id}')"><i class="fa-solid fa-trash-can"></i> Ø­Ø°Ù</button>
                            </div>
                        </div>
                    `;
                }).join('') || '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±ÙˆØ³ Ø¨Ø¹Ø¯</p>';

            } catch (error) {
                console.error('Load lessons error:', error);
            }
        }

        // ============ â­ Dynamic Lesson Editor (Phase 4) ============

        /**
         * Ø¨Ù†Ø§Ø¡ ÙÙˆØ±Ù… Ø§Ù„Ø¯Ø±Ø³ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ù…Ù† SectionRegistry
         * â­ Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„Ù†Ø§Ø¨Ø¶ - ÙƒÙ„ Ø­Ø§Ø¬Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
         */
        async function buildDynamicLessonForm(lessonData = null) {
            try {
                const res = await fetch('/api/sections/all', { credentials: 'include' });
                const allSections = await res.json();
                const container = document.getElementById('lesson-sections-container');
                container.innerHTML = '';

                const activeSections = allSections.filter(s => s.isActive);
                if (activeSections.length === 0) {
                    container.innerHTML = '<div class="loading-sections">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ù†Ø´Ø·Ø©. Ø£Ø¶Ù Ø£Ù‚Ø³Ø§Ù… Ù…Ù† ØªØ§Ø¨ "Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¯Ø±ÙˆØ³"</div>';
                    return;
                }

                activeSections.forEach(section => {
                    container.appendChild(createSectionEditor(section, lessonData));
                });

                console.log(`âœ… ØªÙ… Ø¨Ù†Ø§Ø¡ ${activeSections.length} Ù‚Ø³Ù… Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ`);
            } catch (error) {
                console.error('buildDynamicLessonForm error:', error);
                document.getElementById('lesson-sections-container').innerHTML =
                    '<div class="loading-sections" style="color:var(--danger);">âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>';
            }
        }

        /**
         * Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­Ø±Ø± Ù…Ø®ØµØµ Ù„ÙƒÙ„ Ù‚Ø³Ù… Ø­Ø³Ø¨ Ù†ÙˆØ¹Ù‡
         */
        function createSectionEditor(section, lessonData) {
            const wrapper = document.createElement('div');
            wrapper.className = 'section-editor';
            wrapper.dataset.key = section.sectionKey;

            const hasData = lessonData && lessonData[section.sectionKey];
            if (hasData) wrapper.classList.add('open');

            wrapper.innerHTML = `
                <div class="section-editor-header" onclick="toggleSectionEditor(this)">
                    <span class="section-icon">${section.icon || '<i class="fa-solid fa-book-open"></i>'}</span>
                    <span class="section-label">${section.labelAr}</span>
                    <span class="section-hint">${section.schemaHint || 'mixed'}</span>
                    <i class="fa-solid fa-chevron-down section-toggle"></i>
                </div>
                <div class="section-editor-body" style="display: ${hasData ? 'block' : 'none'};">
                    ${getEditorByHint(section, lessonData)}
                </div>
            `;
            return wrapper;
        }

        /**
         * â­ Ø§Ù„Ù…Ø±ÙˆÙ†Ø© - ÙƒÙ„ Ù†ÙˆØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙŠÙ‡ Ù…Ø­Ø±Ø± Ù…Ø®ØªÙ„Ù
         */
        function getEditorByHint(section, lessonData) {
            const key = section.sectionKey;
            const value = lessonData ? lessonData[key] : null;
            const jsonValue = value ? JSON.stringify(value, null, 2) : '';

            switch (section.schemaHint) {
                case 'text':
                    return `<textarea class="section-input text-editor" data-key="${key}"
                             placeholder="Ø§ÙƒØªØ¨ ${section.labelAr}..." rows="4">${value || ''}</textarea>`;

                case 'list':
                    return `<div class="dynamic-list-editor" data-key="${key}">
                        <div class="dynamic-list-items">${renderDynamicListItems(value)}</div>
                        <button class="btn-add-item" onclick="addDynamicListItem(this)">
                            <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ±
                        </button></div>`;

                case 'cards':
                case 'object':
                case 'mixed':
                default:
                    return `<div class="json-editor-wrapper" data-key="${key}">
                        <div class="json-toolbar">
                            <button onclick="formatJSON(this)" title="ØªÙ†Ø³ÙŠÙ‚"><i class="fa-solid fa-align-left"></i> ØªÙ†Ø³ÙŠÙ‚</button>
                            <button onclick="validateJSON(this)" title="ØªØ­Ù‚Ù‚"><i class="fa-solid fa-check"></i> ØªØ­Ù‚Ù‚</button>
                            <span class="json-status"></span>
                        </div>
                        <textarea class="section-input json-editor" data-key="${key}"
                            placeholder='{"key": "value"}' rows="6">${jsonValue}</textarea>
                    </div>`;
            }
        }

        function toggleSectionEditor(header) {
            const editor = header.closest('.section-editor');
            const body = editor.querySelector('.section-editor-body');
            editor.classList.toggle('open');
            body.style.display = editor.classList.contains('open') ? 'block' : 'none';
        }

        function renderDynamicListItems(items) {
            if (!items || !Array.isArray(items)) return '';
            return items.map((item, i) => `
                <div class="dynamic-list-item">
                    <input type="text" value="${typeof item === 'string' ? item.replace(/"/g, '&quot;') : JSON.stringify(item)}" placeholder="Ø¹Ù†ØµØ± ${i + 1}">
                    <button class="btn-remove-item" onclick="this.parentElement.remove()">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        function addDynamicListItem(btn) {
            const container = btn.previousElementSibling;
            const div = document.createElement('div');
            div.className = 'dynamic-list-item';
            div.innerHTML = `
                <input type="text" placeholder="Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯">
                <button class="btn-remove-item" onclick="this.parentElement.remove()">
                    <i class="fa-solid fa-trash"></i>
                </button>
            `;
            container.appendChild(div);
            div.querySelector('input').focus();
        }

        function collectDynamicListItems(editor) {
            const items = [];
            editor.querySelectorAll('.dynamic-list-item input').forEach(input => {
                if (input.value.trim()) items.push(input.value.trim());
            });
            return items;
        }

        /**
         * Ø¬Ù…Ø¹ ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø±Ø³ (Ø«Ø§Ø¨ØªØ© + Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©)
         */
        function collectLessonData(publish = false) {
            const data = {
                title: document.getElementById('lessonTitle').value.trim(),
                subtitle: document.getElementById('lessonSubtitle')?.value?.trim() || '',
                sheikhId: document.getElementById('lessonSheikh').value,
                categoryId: getSelectedCategoryId(),
                rawContent: document.getElementById('lessonContent').value.trim(),
                rawSource: document.getElementById('lessonRawSource').value.trim(),
                status: publish ? 'published' : (document.getElementById('lessonStatus')?.value || 'draft'),
            };

            // â­ Ø¬Ù…Ø¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
            document.querySelectorAll('.section-editor').forEach(editor => {
                const key = editor.dataset.key;
                const jsonInput = editor.querySelector('.json-editor');
                const textInput = editor.querySelector('.text-editor');
                const listEditor = editor.querySelector('.dynamic-list-editor');

                if (jsonInput && jsonInput.value.trim()) {
                    try { data[key] = JSON.parse(jsonInput.value); }
                    catch (e) { data[key] = jsonInput.value; }
                } else if (textInput && textInput.value.trim()) {
                    data[key] = textInput.value;
                } else if (listEditor) {
                    const items = collectDynamicListItems(editor);
                    if (items.length > 0) data[key] = items;
                }
            });

            return data;
        }

        /**
         * â­ Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø³ (Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ)
         */
        async function saveLessonDynamic(publish = false) {
            const data = collectLessonData(publish);

            if (!data.title) {
                showToast('âš ï¸ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³ Ù…Ø·Ù„ÙˆØ¨!', 'error');
                return;
            }

            if (!data.categoryId) {
                const picker = document.getElementById('categoryPicker');
                if (picker) {
                    picker.classList.add('error');
                    picker.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                showToast('âš ï¸ Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙ Ø§Ù„Ø¯Ø±Ø³ Ø£ÙˆÙ„Ø§Ù‹!', 'error');
                return;
            }

            try {
                let res;
                if (currentEditId) {
                    res = await fetch(`/api/lessons/${currentEditId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    res = await fetch('/api/lessons', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                if (res.ok) {
                    const wasEditing = !!currentEditId;
                    clearAutoSave();
                    cancelEdit();
                    await loadLessons();
                    showToast(
                        wasEditing ? 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­' :
                            (publish ? 'ğŸš€ ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¯Ø±Ø³' : 'âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø³ ÙƒÙ…Ø³ÙˆØ¯Ø©'),
                        'success'
                    );
                    showTab('lessons');
                    document.querySelectorAll('.tab')[4]?.click();
                } else {
                    const err = await res.json();
                    showToast('âŒ ÙØ´Ù„: ' + (err.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'), 'error');
                }
            } catch (error) {
                console.error('Save lesson error:', error);
                showToast('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
            }
        }

        // Backward compat wrapper
        async function saveLesson(publish = false) {
            return saveLessonDynamic(publish);
        }

        /**
         * â­ ÙØªØ­ Ø¯Ø±Ø³ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ (Ù…Ø¹ Ù…Ù„Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©)
         */
        async function editLesson(id) {
            try {
                const res = await fetch(`/api/lessons/${id}`);
                const lesson = await res.json();

                if (!lesson || lesson.error) {
                    return showToast('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø³', 'error');
                }

                currentEditId = id;

                // Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                document.getElementById('lessonTitle').value = lesson.title || '';
                if (document.getElementById('lessonSubtitle'))
                    document.getElementById('lessonSubtitle').value = lesson.subtitle || '';
                document.getElementById('lessonContent').value = lesson.rawContent || '';
                document.getElementById('lessonRawSource').value = lesson.rawSource || '';
                if (document.getElementById('lessonStatus'))
                    document.getElementById('lessonStatus').value = lesson.status || 'draft';

                // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´ÙŠØ®
                const sheikhSelect = document.getElementById('lessonSheikh');
                if (lesson.sheikhId) sheikhSelect.value = lesson.sheikhId;

                // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØµÙ†ÙŠÙ
                if (lesson.categoryId) setCategoryPickerValue(lesson.categoryId);

                // â­ Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙÙˆØ±Ù… Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                await buildDynamicLessonForm(lesson);

                // ØªØºÙŠÙŠØ± UI Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                document.getElementById('formTitle').innerHTML = '<i class="fa-solid fa-pen-to-square"></i> ØªØ¹Ø¯ÙŠÙ„: <span style="color:var(--accent)">' + lesson.title + '</span>';
                document.getElementById('cancelEditBtn').style.display = 'inline-block';
                document.getElementById('saveDraftBtn').innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
                document.getElementById('savePublishBtn').innerHTML = '<i class="fa-solid fa-rocket"></i> Ø­ÙØ¸ ÙˆÙ†Ø´Ø±';

                // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØªØ§Ø¨ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.tab')[5].classList.add('active');
                document.getElementById('addLesson').classList.add('active');

                window.scrollTo({ top: 0, behavior: 'smooth' });
                showToast('ğŸ“ Ø¬Ø§Ø±ÙŠ ØªØ¹Ø¯ÙŠÙ„: ' + lesson.title, 'info');

            } catch (error) {
                console.error('Edit lesson error:', error);
                showToast('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø³', 'error');
            }
        }

        /**
         * ÙØªØ­ ÙÙˆØ±Ù… Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯ (Ù…Ø¹ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©)
         */
        async function openNewLessonEditor() {
            cancelEdit();
            await buildDynamicLessonForm(null);
            startAutoSave();

            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØªØ§Ø¨ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab')[5].classList.add('active');
            document.getElementById('addLesson').classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelEdit() {
            currentEditId = null;
            document.getElementById('lessonTitle').value = '';
            if (document.getElementById('lessonSubtitle'))
                document.getElementById('lessonSubtitle').value = '';
            document.getElementById('lessonContent').value = '';
            document.getElementById('lessonRawSource').value = '';
            document.getElementById('lessonSheikh').selectedIndex = 0;
            if (document.getElementById('lessonStatus'))
                document.getElementById('lessonStatus').value = 'draft';
            resetCategoryPicker();
            document.getElementById('lesson-sections-container').innerHTML = '';
            document.getElementById('formTitle').innerHTML = '<i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯';
            document.getElementById('cancelEditBtn').style.display = 'none';
            document.getElementById('saveDraftBtn').innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Ø­ÙØ¸ ÙƒÙ…Ø³ÙˆØ¯Ø©';
            document.getElementById('savePublishBtn').innerHTML = '<i class="fa-solid fa-rocket"></i> Ù†Ø´Ø± Ù…Ø¨Ø§Ø´Ø±Ø©';
            clearAutoSave();
        }

        // ============ JSON Editor Helpers ============
        function formatJSON(btn) {
            const textarea = btn.closest('.json-editor-wrapper').querySelector('.json-editor');
            const status = btn.closest('.json-toolbar').querySelector('.json-status');
            try {
                const obj = JSON.parse(textarea.value);
                textarea.value = JSON.stringify(obj, null, 2);
                status.textContent = 'âœ… ØªÙ… Ø§Ù„ØªÙ†Ø³ÙŠÙ‚';
                status.style.color = '#10b981';
            } catch (e) {
                status.textContent = 'âŒ JSON ØºÙŠØ± ØµØ§Ù„Ø­';
                status.style.color = '#ef4444';
            }
        }

        function validateJSON(btn) {
            const textarea = btn.closest('.json-editor-wrapper').querySelector('.json-editor');
            const status = btn.closest('.json-toolbar').querySelector('.json-status');
            try {
                JSON.parse(textarea.value);
                status.textContent = 'âœ… JSON ØµØ§Ù„Ø­';
                status.style.color = '#10b981';
            } catch (e) {
                status.textContent = 'âŒ ' + e.message;
                status.style.color = '#ef4444';
            }
        }

        // ============ Toast Notifications (Phase 4) ============
        function showToast(message, type = 'info') {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                document.body.appendChild(container);
            }
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <span>${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">âœ•</button>
            `;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // ============ Auto-Save System (Phase 4) ============
        let autoSaveInterval = null;
        const AUTO_SAVE_KEY = 'zizo-bilal-lesson-autosave';

        function startAutoSave() {
            clearAutoSave();
            autoSaveInterval = setInterval(() => {
                const title = document.getElementById('lessonTitle')?.value;
                const content = document.getElementById('lessonContent')?.value;
                if (title || content) {
                    const data = collectLessonData(false);
                    data._savedAt = Date.now();
                    localStorage.setItem(AUTO_SAVE_KEY, JSON.stringify(data));
                    const indicator = document.getElementById('autosave-indicator');
                    if (indicator) indicator.textContent = 'ğŸ’¾ ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ';
                }
            }, 30000);
        }

        function restoreAutoSave() {
            const saved = localStorage.getItem(AUTO_SAVE_KEY);
            if (!saved) return false;
            try {
                const data = JSON.parse(saved);
                const age = Date.now() - (data._savedAt || 0);
                if (age < 3600000 && data.title) {
                    if (confirm('ğŸ”„ Ù„Ù‚ÙŠÙ†Ø§ Ù…Ø³ÙˆØ¯Ø© Ù…Ø­ÙÙˆØ¸Ø© ("' + data.title + '"). ØªØ­Ø¨ Ù†Ø³ØªØ±Ø¬Ø¹Ù‡Ø§ØŸ')) {
                        document.getElementById('lessonTitle').value = data.title || '';
                        if (document.getElementById('lessonSubtitle'))
                            document.getElementById('lessonSubtitle').value = data.subtitle || '';
                        document.getElementById('lessonContent').value = data.rawContent || '';
                        document.getElementById('lessonRawSource').value = data.rawSource || '';
                        showToast('â™»ï¸ ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©', 'info');
                        return true;
                    }
                }
            } catch (e) { console.error('restoreAutoSave error:', e); }
            return false;
        }

        function clearAutoSave() {
            localStorage.removeItem(AUTO_SAVE_KEY);
            if (autoSaveInterval) { clearInterval(autoSaveInterval); autoSaveInterval = null; }
            const indicator = document.getElementById('autosave-indicator');
            if (indicator) indicator.textContent = '';
        }

        async function togglePublish(id, isCurrentlyPublished) {
            const newStatus = isCurrentlyPublished ? 'draft' : 'published';
            const msg = isCurrentlyPublished ? 'Ø¥Ù„ØºØ§Ø¡ Ù†Ø´Ø± Ø§Ù„Ø¯Ø±Ø³ØŸ' : 'Ù†Ø´Ø± Ø§Ù„Ø¯Ø±Ø³ØŸ';
            if (!confirm(msg)) return;

            try {
                const res = await fetch(`/api/lessons/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });

                if (res.ok) {
                    loadLessons();
                    alert(isCurrentlyPublished ? 'âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù†Ø´Ø±' : 'ğŸš€ ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    alert('âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©');
                }
            } catch (error) {
                console.error('Publish error:', error);
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }

        async function deleteLesson(id) {
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ØŸ')) return;

            try {
                const res = await fetch(`/api/lessons/${id}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    loadLessons();
                    alert('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù');
                } else {
                    alert('âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
                }
            } catch (error) {
                console.error('Delete error:', error);
            }
        }

        // ============ AI Functions ============
        function analyzeWithAI() {
            const content = document.getElementById('rawInput').value;

            if (!content.trim()) {
                return alert('âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ù…Ø­ØªÙˆÙ‰ Ø£ÙˆÙ„Ø§Ù‹!');
            }

            alert('âœ¨ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù‚Ø§Ø¯Ù… ÙÙŠ Phase 4!\n\nØ­Ø§Ù„ÙŠØ§Ù‹: Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…ØªÙˆÙØ±Ø© ÙˆØ§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ.');
        }

        function saveDraft() {
            const content = document.getElementById('rawInput').value;
            localStorage.setItem('aiDraft', content);
            alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ù…Ø­Ù„ÙŠØ§Ù‹!');
        }

        function clearInput() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ØŸ')) {
                document.getElementById('rawInput').value = '';
                localStorage.removeItem('aiDraft');
            }
        }

        function restoreDraft() {
            const draft = localStorage.getItem('aiDraft');
            if (draft) {
                document.getElementById('rawInput').value = draft;
            }
        }

        // ============ Preview ============
        function updatePreviewSelect() {
            // TODO: Implement preview
            alert('Ù‚Ø±ÙŠØ¨Ø§Ù‹: Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¯Ø±ÙˆØ³');
        }

        function showPreview() {
            // TODO
        }

        // ============ Import Modal Functions ============
        let importType = 'json';
        let importedData = null;

        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
            document.getElementById('importContent').value = '';
            document.getElementById('importRawSource').value = '';
            document.getElementById('importResult').innerHTML = '';
            document.getElementById('previewSections').style.display = 'none';
            document.getElementById('applyBtn').disabled = true;
            importedData = null;
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }

        function setImportType(type) {
            importType = type;
            document.querySelectorAll('.import-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            const label = document.getElementById('importLabel');
            const textarea = document.getElementById('importContent');

            if (type === 'json') {
                label.textContent = 'Ø§Ù„ØµÙ‚ ÙƒÙˆØ¯ JSON Ù‡Ù†Ø§:';
                textarea.placeholder = '{ "title": "...", "overview": {...} }';
            } else {
                label.textContent = 'Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§ (Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø¨Ù€ ## Ø£Ùˆ Ø¥ÙŠÙ…ÙˆØ¬ÙŠ):';
                textarea.placeholder = '## Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©\nØ§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©...\n\n## Ø§Ù„Ø¢ÙŠØ§Øª\n- Ø¢ÙŠØ© 1\n- Ø¢ÙŠØ© 2';
            }
        }

        function parseAndPreview() {
            const content = document.getElementById('importContent').value.trim();
            const resultDiv = document.getElementById('importResult');
            const previewDiv = document.getElementById('previewSections');

            if (!content) {
                resultDiv.innerHTML = '<div class="alert" style="background: rgba(231,76,60,0.2); border-color: #e74c3c;">âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø­ØªÙˆÙ‰ Ø£ÙˆÙ„Ø§Ù‹</div>';
                return;
            }

            try {
                if (importType === 'json') {
                    importedData = JSON.parse(content);
                    resultDiv.innerHTML = '<div class="alert" style="background: rgba(46,204,113,0.2); border-color: #2ecc71;">âœ… JSON ØµØ­ÙŠØ­ - ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!</div>';

                    // Show preview
                    previewDiv.style.display = 'block';
                    previewDiv.innerHTML = `
                        <h4 style="color: var(--gold);">ğŸ“‹ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰:</h4>
                        <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${importedData.title || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                        <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:</strong> ${Object.keys(importedData).length}</p>
                        <pre style="background: var(--dark); padding: 10px; border-radius: 8px; max-height: 200px; overflow: auto; font-size: 0.8rem;">${JSON.stringify(importedData, null, 2).substring(0, 500)}...</pre>
                    `;
                } else {
                    // Parse plain text
                    importedData = parseTextContent(content);
                    resultDiv.innerHTML = '<div class="alert" style="background: rgba(46,204,113,0.2); border-color: #2ecc71;">âœ… ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ Ø¨Ù†Ø¬Ø§Ø­!</div>';

                    previewDiv.style.display = 'block';
                    previewDiv.innerHTML = `
                        <h4 style="color: var(--gold);">ğŸ“‹ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰:</h4>
                        <p><strong>Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ÙƒØªØ´ÙØ©:</strong> ${Object.keys(importedData).length}</p>
                    `;
                }

                document.getElementById('applyBtn').disabled = false;

            } catch (error) {
                resultDiv.innerHTML = `<div class="alert" style="background: rgba(231,76,60,0.2); border-color: #e74c3c;">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„: ${error.message}</div>`;
                importedData = null;
                document.getElementById('applyBtn').disabled = true;
            }
        }

        function parseTextContent(text) {
            // Simple text parser
            const sections = {};
            const lines = text.split('\n');
            let currentSection = 'general';

            lines.forEach(line => {
                if (line.startsWith('##')) {
                    currentSection = line.replace(/^##\s*/, '').trim();
                    sections[currentSection] = [];
                } else if (line.trim()) {
                    if (!sections[currentSection]) sections[currentSection] = [];
                    sections[currentSection].push(line.trim());
                }
            });

            return sections;
        }

        function applyImport() {
            if (!importedData) return;

            const rawSource = document.getElementById('importRawSource').value.trim();

            // Apply to lesson form
            if (importedData.title) {
                document.getElementById('lessonTitle').value = importedData.title;
            }

            // Store full data in lessonContent as JSON
            document.getElementById('lessonContent').value = JSON.stringify(importedData, null, 2);

            // Set rawSource if provided
            if (rawSource) {
                document.getElementById('lessonRawSource').value = rawSource;
            }

            closeImportModal();
            alert('âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø³.');
        }

        // ============ Categories Management (Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù‡Ø±Ù…ÙŠØ©) ============
        let currentParentId = null;
        let breadcrumbPath = []; // [{id, name}]
        let allCategoriesCache = [];

        const QUICK_ICONS = [
            { icon: 'fa-solid fa-book-quran', label: 'Ù‚Ø±Ø¢Ù†' },
            { icon: 'fa-solid fa-hands-praying', label: 'Ø¯Ø¹Ø§Ø¡' },
            { icon: 'fa-solid fa-mosque', label: 'Ù…Ø³Ø¬Ø¯' },
            { icon: 'fa-solid fa-user-tie', label: 'Ø´ÙŠØ®' },
            { icon: 'fa-solid fa-graduation-cap', label: 'Ø¯Ø±Ø³' },
            { icon: 'fa-solid fa-scroll', label: 'ØªÙØ³ÙŠØ±' },
            { icon: 'fa-solid fa-scale-balanced', label: 'Ø£Ø­ÙƒØ§Ù…' },
            { icon: 'fa-solid fa-gem', label: 'ÙÙˆØ§Ø¦Ø¯' },
            { icon: 'fa-solid fa-microphone', label: 'Ø¨ÙˆØ¯ÙƒØ§Ø³Øª' },
            { icon: 'fa-solid fa-book-open', label: 'ÙƒØªØ§Ø¨' },
            { icon: 'fa-solid fa-star', label: 'Ù†Ø¬Ù…Ø©' },
            { icon: 'fa-solid fa-heart', label: 'Ù‚Ù„Ø¨' },
            { icon: 'fa-solid fa-moon', label: 'Ù‡Ù„Ø§Ù„' },
            { icon: 'fa-solid fa-sun', label: 'Ø´Ù…Ø³' },
            { icon: 'fa-solid fa-users', label: 'Ù…Ø¬Ù…ÙˆØ¹Ø©' },
            { icon: 'fa-solid fa-circle-question', label: 'Ø³Ø¤Ø§Ù„' },
            { icon: 'fa-solid fa-lightbulb', label: 'ÙÙƒØ±Ø©' },
            { icon: 'fa-solid fa-bell', label: 'ØªØ°ÙƒÙŠØ±' },
            { icon: 'fa-solid fa-layer-group', label: 'Ø·Ø¨Ù‚Ø§Øª' },
            { icon: 'fa-solid fa-magnifying-glass', label: 'Ø¨Ø­Ø«' },
            { icon: 'fa-solid fa-play', label: 'ØªØ´ØºÙŠÙ„' },
            { icon: 'fa-solid fa-chart-pie', label: 'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª' },
            { icon: 'fa-solid fa-clock', label: 'ÙˆÙ‚Øª' },
            { icon: 'fa-solid fa-map', label: 'Ø®Ø±ÙŠØ·Ø©' },
        ];

        function renderQuickIcons() {
            document.getElementById('quickIcons').innerHTML = QUICK_ICONS.map(q => `
                <button type="button" onclick="pickIcon('${q.icon}')" title="${q.label}"
                    style="width:36px; height:36px; display:flex; align-items:center; justify-content:center;
                    background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius:8px;
                    cursor:pointer; color:#ccc; font-size:1rem; transition:all 0.2s;"
                    onmouseover="this.style.background='rgba(218,165,32,0.2)'; this.style.color='#DAA520'; this.style.borderColor='rgba(218,165,32,0.4)';"
                    onmouseout="this.style.background='rgba(255,255,255,0.06)'; this.style.color='#ccc'; this.style.borderColor='rgba(255,255,255,0.12)';">
                    <i class="${q.icon}"></i>
                </button>
            `).join('');
        }

        function pickIcon(iconClass) {
            document.getElementById('catIcon').value = iconClass;
            previewIcon();
        }

        function previewIcon() {
            const iconClass = document.getElementById('catIcon').value.trim();
            document.getElementById('catIconPreview').innerHTML = `<i class="${iconClass}"></i>`;
        }

        // ============ Tree View Functions ============

        /**
         * Toggle expand/collapse for a tree node
         */
        function toggleTreeNode(button) {
            const item = button.closest('.tree-item');
            const children = item.querySelector('.tree-children');

            if (!children) return;

            const isExpanded = children.style.display !== 'none';

            if (isExpanded) {
                children.style.display = 'none';
                button.classList.remove('expanded');
            } else {
                children.style.display = 'block';
                button.classList.add('expanded');
            }
        }

        /**
         * Expand all tree nodes
         */
        function expandAllTree() {
            document.querySelectorAll('.tree-children').forEach(children => {
                children.style.display = 'block';
            });
            document.querySelectorAll('.tree-toggle').forEach(toggle => {
                toggle.classList.add('expanded');
            });
        }

        /**
         * Collapse all tree nodes
         */
        function collapseAllTree() {
            document.querySelectorAll('.tree-children').forEach(children => {
                children.style.display = 'none';
            });
            document.querySelectorAll('.tree-toggle').forEach(toggle => {
                toggle.classList.remove('expanded');
            });
        }

        /**
         * Reload the category tree
         */
        async function reloadCategoryTree() {
            await loadCategoryTree();
        }

        /**
         * Render tree view recursively
         */
        function renderTreeView(categories, level = 0) {
            if (!categories || categories.length === 0) return '';

            let html = '';

            categories.forEach(cat => {
                const hasChildren = cat.children && cat.children.length > 0;
                const iconColor = cat.color || '#D4AF37';
                const icon = cat.icon || 'fa-solid fa-folder';

                html += `
                    <li class="tree-item" data-id="${cat._id}" data-level="${level}">
                        <div class="tree-item-content">
                            ${hasChildren
                        ? `<button class="tree-toggle" onclick="toggleTreeNode(this)"><i class="fa-solid fa-chevron-left"></i></button>`
                        : '<span class="tree-spacer"></span>'
                    }
                            <i class="tree-icon ${icon}" style="color: ${iconColor}"></i>
                            <span class="tree-label">${cat.name}</span>
                            <div class="tree-actions">
                                <button class="btn-tree-icon" onclick="addChildCategory('${cat._id}')" title="Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… ÙØ±Ø¹ÙŠ">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                                <button class="btn-tree-icon" onclick="editCategoryFromTree('${cat._id}')" title="ØªØ¹Ø¯ÙŠÙ„">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                                <button class="btn-tree-icon" onclick="deleteCategoryFromTree('${cat._id}', '${cat.name}')" title="Ø­Ø°Ù">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                `;

                if (hasChildren) {
                    html += `<ul class="tree-children" style="display: none;">`;
                    html += renderTreeView(cat.children, level + 1);
                    html += `</ul>`;
                }

                html += `</li>`;
            });

            return html;
        }

        /**
         * Load category tree from API
         */
        async function loadCategoryTree() {
            try {
                const res = await fetch('/api/categories/tree');
                const tree = await res.json();

                const container = document.getElementById('categoryTreeRoot');

                if (tree.length === 0) {
                    container.innerHTML = `
                        <div style="text-align:center; padding:40px; color:rgba(255,255,255,0.4);">
                            <i class="fa-solid fa-folder-open" style="font-size:3rem; margin-bottom:1rem;"></i>
                            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</p>
                            <p style="font-size:0.9rem;">Ø£Ø¶Ù Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = renderTreeView(tree, 0);
                }

                // Update stat
                const allRes = await fetch('/api/categories/all');
                const allCats = await allRes.json();
                const catCountEl = document.getElementById('categoriesCount');
                if (catCountEl) catCountEl.textContent = allCats.length;

            } catch (error) {
                console.error('Load tree error:', error);
                const container = document.getElementById('categoryTreeRoot');
                container.innerHTML = `
                    <div class="alert" style="background:rgba(231,76,60,0.2); border-color:#e74c3c;">
                        âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                    </div>
                `;
            }
        }

        // ========================================
        // ğŸ¯ Category Picker (Cascading) Logic
        // ========================================
        let categoryPickerTree = []; // Full tree cache
        let categorySelectedPath = []; // [{id, name, icon}, ...]

        async function loadCategoryPickerTree() {
            try {
                const res = await fetch('/api/categories/tree');
                const data = await res.json();
                console.log('ğŸ¯ Category Picker - API response:', data);
                categoryPickerTree = Array.isArray(data) ? data : [];
                console.log('ğŸ¯ Category Picker - tree length:', categoryPickerTree.length);
                if (categoryPickerTree.length > 0) {
                    renderCategoryLevel(0, categoryPickerTree);
                } else {
                    console.warn('ğŸ¯ Category Picker - No categories found!');
                }
            } catch (error) {
                console.error('Load category picker error:', error);
            }
        }

        function renderCategoryLevel(levelIndex, nodes) {
            const container = document.getElementById('categoryLevels');
            // Remove all dropdowns from this level onwards
            const existingWraps = container.querySelectorAll('.category-level-wrap');
            for (let i = existingWraps.length - 1; i >= levelIndex; i--) {
                existingWraps[i].remove();
            }
            // Trim path to current level
            categorySelectedPath = categorySelectedPath.slice(0, levelIndex);

            if (!nodes || nodes.length === 0) {
                updateCategoryBreadcrumb();
                return;
            }

            const levelNames = ['Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ', 'Ø§Ù„ÙØ±Ø¹ÙŠ', 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ' + (levelIndex + 1)];
            const labelText = levelIndex < 2 ? levelNames[levelIndex] : levelNames[2];

            const wrap = document.createElement('div');
            wrap.className = 'category-level-wrap';
            wrap.innerHTML = `
                <label>${labelText}</label>
                <select onchange="onCategoryLevelSelect(${levelIndex}, this.value)">
                    <option value="">-- Ø§Ø®ØªØ± --</option>
                    ${nodes.map(n => `<option value="${n._id}" data-name="${n.name}" data-icon="${n.icon || 'fa-solid fa-folder'}">${n.icon ? '' : 'ğŸ“'} ${n.name} ${n.children && n.children.length > 0 ? '(' + n.children.length + ')' : ''}</option>`).join('')}
                </select>
            `;
            container.appendChild(wrap);
            updateCategoryBreadcrumb();
        }

        function onCategoryLevelSelect(levelIndex, selectedId) {
            if (!selectedId) {
                // Reset from this level
                categorySelectedPath = categorySelectedPath.slice(0, levelIndex);
                const container = document.getElementById('categoryLevels');
                const wraps = container.querySelectorAll('.category-level-wrap');
                for (let i = wraps.length - 1; i > levelIndex; i--) {
                    wraps[i].remove();
                }
                document.getElementById('selectedCategoryId').value = categorySelectedPath.length > 0 ? categorySelectedPath[categorySelectedPath.length - 1].id : '';
                updateCategoryBreadcrumb();
                return;
            }

            // Find selected node in tree (recursive search)
            const node = findNodeInTree(categoryPickerTree, selectedId);
            if (!node) return;

            // Update path
            categorySelectedPath = categorySelectedPath.slice(0, levelIndex);
            categorySelectedPath.push({ id: node._id, name: node.name, icon: node.icon });

            // Set hidden input
            document.getElementById('selectedCategoryId').value = node._id;

            // Remove error state
            document.getElementById('categoryPicker').classList.remove('error');

            // If has children, show next level
            if (node.children && node.children.length > 0) {
                renderCategoryLevel(levelIndex + 1, node.children);
            } else {
                // Remove dropdowns after this level
                const container = document.getElementById('categoryLevels');
                const wraps = container.querySelectorAll('.category-level-wrap');
                for (let i = wraps.length - 1; i > levelIndex; i--) {
                    wraps[i].remove();
                }
                updateCategoryBreadcrumb();
            }
        }

        function findNodeInTree(nodes, id) {
            for (const node of nodes) {
                if (node._id === id) return node;
                if (node.children && node.children.length > 0) {
                    const found = findNodeInTree(node.children, id);
                    if (found) return found;
                }
            }
            return null;
        }

        function updateCategoryBreadcrumb() {
            const breadcrumb = document.getElementById('categoryBreadcrumb');
            if (categorySelectedPath.length === 0) {
                breadcrumb.innerHTML = '<span class="crumb-placeholder">Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ...</span>';
                return;
            }
            breadcrumb.innerHTML = categorySelectedPath.map((item, i) => {
                const sep = i < categorySelectedPath.length - 1 ? ' <span class="crumb-sep">â—‚</span> ' : '';
                return `<span class="crumb-item">${item.name}</span>${sep}`;
            }).join('');
        }

        function resetCategoryPicker() {
            categorySelectedPath = [];
            document.getElementById('selectedCategoryId').value = '';
            document.getElementById('categoryBreadcrumb').innerHTML = '<span class="crumb-placeholder">Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ...</span>';
            const container = document.getElementById('categoryLevels');
            container.innerHTML = '';
            // Re-render first level
            if (categoryPickerTree.length > 0) {
                renderCategoryLevel(0, categoryPickerTree);
            }
        }

        function getSelectedCategoryId() {
            return document.getElementById('selectedCategoryId').value || null;
        }

        // Set category picker to a specific categoryId (for edit mode)
        function setCategoryPickerValue(categoryId) {
            if (!categoryId || categoryPickerTree.length === 0) return;
            // Find path from root to this category
            const path = findPathInTree(categoryPickerTree, categoryId);
            if (!path) return;

            // Reset picker
            categorySelectedPath = [];
            const container = document.getElementById('categoryLevels');
            container.innerHTML = '';

            // Re-render each level and select
            let currentNodes = categoryPickerTree;
            path.forEach((nodeId, levelIndex) => {
                renderCategoryLevel(levelIndex, currentNodes);
                const selects = container.querySelectorAll('select');
                if (selects[levelIndex]) {
                    selects[levelIndex].value = nodeId;
                }
                const node = findNodeInTree(currentNodes, nodeId);
                if (node) {
                    categorySelectedPath.push({ id: node._id, name: node.name, icon: node.icon });
                    currentNodes = node.children || [];
                }
            });

            document.getElementById('selectedCategoryId').value = categoryId;
            updateCategoryBreadcrumb();

            // Show children if last selected has children
            const lastNode = findNodeInTree(categoryPickerTree, categoryId);
            if (lastNode && lastNode.children && lastNode.children.length > 0) {
                renderCategoryLevel(path.length, lastNode.children);
            }
        }

        function findPathInTree(nodes, targetId, currentPath = []) {
            for (const node of nodes) {
                const newPath = [...currentPath, node._id];
                if (node._id === targetId) return newPath;
                if (node.children && node.children.length > 0) {
                    const found = findPathInTree(node.children, targetId, newPath);
                    if (found) return found;
                }
            }
            return null;
        }

        /**
         * Add child category
         */
        function addChildCategory(parentId) {
            currentParentId = parentId;
            document.getElementById('catName').focus();
        }

        /**
         * Edit category from tree
         */
        async function editCategoryFromTree(id) {
            try {
                const res = await fetch(`/api/categories/single/${id}`);
                const cat = await res.json();

                document.getElementById('catName').value = cat.name;
                document.getElementById('catDesc').value = cat.description || '';
                document.getElementById('catIcon').value = cat.icon || 'fa-solid fa-folder';
                document.getElementById('catColor').value = cat.color || '#DAA520';
                previewIcon();

                // Store edit mode
                window.editingCategoryId = id;

                alert('Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ - Ø§Ø¶ØºØ· "Ø¥Ø¶Ø§ÙØ©" Ù„Ù„Ø­ÙØ¸');
            } catch (error) {
                console.error('Edit error:', error);
                alert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø³Ù…');
            }
        }

        /**
         * Delete category from tree
         */
        async function deleteCategoryFromTree(id, name) {
            if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù "${name}"ØŸ\n\nØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ©!`)) return;

            try {
                const res = await fetch(`/api/categories/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Delete failed');

                alert('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­');
                await loadCategoryTree();
            } catch (error) {
                console.error('Delete error:', error);
                alert('âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
            }
        }

        async function loadCategories(parentId) {

            currentParentId = parentId;

            try {
                const url = parentId
                    ? `/api/categories/children/${parentId}`
                    : '/api/categories/all';
                const res = await fetch(url);
                let categories = await res.json();

                // Ù„Ùˆ ÙÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù€ root Ø¨Ø³
                if (!parentId) {
                    categories = categories.filter(c => !c.parentId);
                }

                allCategoriesCache = categories;
                renderCategories(categories);
                renderBreadcrumb();

                // Update stat
                const allRes = await fetch('/api/categories/all');
                const allCats = await allRes.json();
                const catCountEl = document.getElementById('categoriesCount');
                if (catCountEl) catCountEl.textContent = allCats.length;

            } catch (error) {
                console.error('Load categories error:', error);
                const listEl = document.getElementById('categoriesList');
                if (listEl) {
                    listEl.innerHTML = `
                        <div class="alert" style="background:rgba(231,76,60,0.2); border-color:#e74c3c;">âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
                    `;
                }
            }
        }

        function renderBreadcrumb() {
            const bc = document.getElementById('catBreadcrumb');
            let html = `<span onclick="navigateToRoot()" style="cursor:pointer; color:var(--gold); font-weight:700;"><i class="fa-solid fa-house"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>`;

            breadcrumbPath.forEach((item, idx) => {
                html += ` <i class="fa-solid fa-chevron-left" style="color:rgba(255,255,255,0.3); font-size:0.7rem;"></i> `;
                if (idx === breadcrumbPath.length - 1) {
                    html += `<span style="color:white; font-weight:600;">${item.name}</span>`;
                } else {
                    html += `<span onclick="navigateToBreadcrumb(${idx})" style="cursor:pointer; color:var(--gold);">${item.name}</span>`;
                }
            });
            bc.innerHTML = html;
        }

        function navigateToRoot() {
            breadcrumbPath = [];
            // Load category tree view
            loadCategoryTree();

        }

        function navigateToBreadcrumb(index) {
            const item = breadcrumbPath[index];
            breadcrumbPath = breadcrumbPath.slice(0, index + 1);
            loadCategories(item.id);
        }

        function openCategory(id, name) {
            breadcrumbPath.push({ id, name });
            loadCategories(id);
        }

        function renderCategories(categories) {
            const listEl = document.getElementById('categoriesList');
            if (!listEl) return; // Element doesn't exist in current view

            if (categories.length === 0) {
                listEl.innerHTML = `
                    <div style="text-align:center; padding:40px; color:rgba(255,255,255,0.4);">
                        <i class="fa-solid fa-folder-open" style="font-size:3rem; margin-bottom:15px; display:block;"></i>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ù‡Ù†Ø§ Ø¨Ø¹Ø¯</p>
                        <p style="font-size:0.85rem;">Ø£Ø¶Ù Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„ÙÙˆØ±Ù… Ø£Ø¹Ù„Ø§Ù‡ â¬†ï¸</p>
                    </div>
                `;
                return;
            }

            listEl.innerHTML = `
                <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(220px, 1fr)); gap:14px;">
                    ${categories.map(cat => `
                        <div class="cat-card" style="background:linear-gradient(145deg, rgba(30,30,40,0.95), rgba(20,20,30,0.98));
                            border:1px solid ${cat.color || '#DAA520'}30; border-radius:14px; padding:18px;
                            cursor:pointer; transition:all 0.3s; position:relative;"
                            onmouseover="this.style.transform='translateY(-3px)'; this.style.borderColor='${cat.color || '#DAA520'}80'; this.style.boxShadow='0 8px 25px ${cat.color || '#DAA520'}20';"
                            onmouseout="this.style.transform=''; this.style.borderColor='${cat.color || '#DAA520'}30'; this.style.boxShadow='none';">
                            
                            <!-- Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©/Ø§Ù„Ø§Ø³Ù… -->
                            <div onclick="openCategory('${cat._id}', '${cat.name.replace(/'/g, "\\'")}')"
                                style="text-align:center; margin-bottom:12px;">
                                <div style="width:55px; height:55px; margin:0 auto 10px; display:flex; align-items:center;
                                    justify-content:center; background:${cat.color || '#DAA520'}18; border-radius:14px;
                                    font-size:1.8rem; color:${cat.color || '#DAA520'};">
                                    <i class="${cat.icon || 'fa-solid fa-folder'}"></i>
                                </div>
                                <h4 style="color:white; font-size:1rem; margin:0;">${cat.name}</h4>
                                ${cat.description ? `<small style="color:rgba(255,255,255,0.4); font-size:0.8rem;">${cat.description}</small>` : ''}
                            </div>
                            
                            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù -->
                            <div style="display:flex; gap:6px; justify-content:center; border-top:1px solid rgba(255,255,255,0.08); padding-top:10px;">
                                <button onclick="event.stopPropagation(); editCategory('${cat._id}')" 
                                    style="background:rgba(52,152,219,0.15); border:1px solid rgba(52,152,219,0.3); color:#3498db;
                                    border-radius:8px; padding:5px 12px; cursor:pointer; font-size:0.8rem; transition:all 0.2s;"
                                    onmouseover="this.style.background='rgba(52,152,219,0.3)'"
                                    onmouseout="this.style.background='rgba(52,152,219,0.15)'">
                                    <i class="fa-solid fa-pen"></i> ØªØ¹Ø¯ÙŠÙ„
                                </button>
                                <button onclick="event.stopPropagation(); deleteCategory('${cat._id}', '${cat.name.replace(/'/g, "\\\'")}')" 
                                    style="background:rgba(231,76,60,0.15); border:1px solid rgba(231,76,60,0.3); color:#e74c3c;
                                    border-radius:8px; padding:5px 12px; cursor:pointer; font-size:0.8rem; transition:all 0.2s;"
                                    onmouseover="this.style.background='rgba(231,76,60,0.3)'"
                                    onmouseout="this.style.background='rgba(231,76,60,0.15)'">
                                    <i class="fa-solid fa-trash"></i> Ø­Ø°Ù
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function addCategory() {
            const name = document.getElementById('catName').value.trim();
            const icon = document.getElementById('catIcon').value.trim() || 'fa-solid fa-folder';
            const color = document.getElementById('catColor').value || '#DAA520';
            const description = document.getElementById('catDesc').value.trim();

            if (!name) return alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…!');

            try {
                const res = await fetch('/api/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name, icon, color, description,
                        parentId: currentParentId
                    })
                });

                if (res.ok) {
                    document.getElementById('catName').value = '';
                    document.getElementById('catDesc').value = '';

                    // Reload tree view instead of old list
                    await loadCategoryTree();

                    alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù…!');
                } else {
                    const err = await res.json();
                    alert('âŒ ÙØ´Ù„: ' + (err.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                }
            } catch (error) {
                console.error('Add category error:', error);
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }


        async function editCategory(id) {
            try {
                // Get current data
                const allRes = await fetch('/api/categories/all');
                const allCats = await allRes.json();
                const cat = allCats.find(c => c._id === id);
                if (!cat) return alert('Ø§Ù„Ù‚Ø³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');

                const newName = prompt('Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…:', cat.name);
                if (newName === null) return; // cancelled

                const newIcon = prompt('Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© (Font Awesome class):', cat.icon || 'fa-solid fa-folder');
                if (newIcon === null) return;

                const newColor = prompt('Ø§Ù„Ù„ÙˆÙ† (hex):', cat.color || '#DAA520');
                if (newColor === null) return;

                const res = await fetch(`/api/categories/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: newName || cat.name,
                        icon: newIcon || cat.icon,
                        color: newColor || cat.color
                    })
                });

                if (res.ok) {
                    loadCategories(currentParentId);
                    alert('âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„!');
                } else {
                    alert('âŒ ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
                }
            } catch (error) {
                console.error('Edit category error:', error);
            }
        }

        async function deleteCategory(id, name) {
            if (!confirm(`âš ï¸ Ø­Ø°Ù "${name}" ÙˆÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ©ØŸ\nÙ‡Ø°Ø§ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!`)) return;

            try {
                const res = await fetch(`/api/categories/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadCategories(currentParentId);
                    alert('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù!');
                } else {
                    alert('âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
                }
            } catch (error) {
                console.error('Delete category error:', error);
            }
        }

        // ============ Initialize ============
        window.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            restoreDraft();
            restoreAutoSave();
            renderQuickIcons();
            await loadCategories(null);
            await loadCategoryTree();
            await loadSections();
            await loadSheikhs();
            await loadLessons();
            await loadCategoryPickerTree();
        });
    </script>

    <!-- Phase 4: Auto-Save Indicator -->
    <div id="autosave-indicator"></div>

    <!-- ============ Floating Action Buttons (FAB) ============ -->
    <div class="fab-container" id="fabContainer">
        <button class="fab-main" id="fabMain" onclick="toggleFAB()" title="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©">
            <i class="fa-solid fa-plus"></i>
        </button>
        <div class="fab-actions" id="fabActions">
            <button class="fab-action fab-lesson" onclick="fabAction('newLesson')">
                <i class="fa-solid fa-book-quran"></i>
                <span class="fab-tooltip">Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯</span>
            </button>
            <button class="fab-action fab-ai" onclick="fabAction('ai')">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
                <span class="fab-tooltip">AI Master Input</span>
            </button>
            <button class="fab-action fab-import" onclick="fabAction('import')">
                <i class="fa-solid fa-file-import"></i>
                <span class="fab-tooltip">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø­ØªÙˆÙ‰</span>
            </button>
            <button class="fab-action fab-top" onclick="fabAction('top')">
                <i class="fa-solid fa-arrow-up"></i>
                <span class="fab-tooltip">Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©</span>
            </button>
        </div>
    </div>

    <!-- ============ FAB + Animation Scripts ============ -->
    <script>
        // Floating Action Button
        function toggleFAB() {
            const fab = document.getElementById('fabMain');
            const actions = document.getElementById('fabActions');
            fab.classList.toggle('active');
            actions.classList.toggle('show');
        }

        function fabAction(action) {
            toggleFAB(); // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            switch (action) {
                case 'newLesson':
                    if (typeof openNewLessonEditor === 'function') {
                        openNewLessonEditor();
                    } else {
                        showTab('addLesson');
                        document.querySelectorAll('.tab')[5]?.click();
                    }
                    break;
                case 'ai':
                    showTab('aiInput');
                    document.querySelectorAll('.tab')[0]?.click();
                    break;
                case 'import':
                    if (typeof openImportModal === 'function') openImportModal();
                    break;
                case 'top':
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    break;
            }
        }

        // Close FAB on clicking outside
        document.addEventListener('click', (e) => {
            const fab = document.getElementById('fabContainer');
            if (fab && !fab.contains(e.target)) {
                document.getElementById('fabMain')?.classList.remove('active');
                document.getElementById('fabActions')?.classList.remove('show');
            }
        });

        // Show/hide FAB scroll-to-top on scroll
        window.addEventListener('scroll', () => {
            const fabContainer = document.getElementById('fabContainer');
            if (fabContainer) {
                fabContainer.style.opacity = window.scrollY > 100 ? '1' : '0.6';
            }
        });
    </script>

    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>