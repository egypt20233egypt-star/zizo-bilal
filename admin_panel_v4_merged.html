<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููุญุฉ ุงูุชุญูู - Admin Panel v4</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #D4AF37;
            --dark: #1a1a2e;
            --darker: #16213e;
            --burgundy: #722F37;
            --green: #27ae60;
            --text: #f5f5f5;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, var(--darker) 100%);
            color: var(--text);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--darker);
            border-bottom: 2px solid var(--gold);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo h1 {
            color: var(--gold);
            font-size: 1.6rem;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            padding: 0.6rem 1.5rem;
            border: 1px solid var(--gold);
            border-radius: 8px;
            background: rgba(212, 175, 55, 0.1);
            color: var(--gold);
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            font-weight: 600;
        }

        .btn:hover {
            background: var(--gold);
            color: var(--dark);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gold) 0%, #e6c547 100%);
            color: var(--dark);
            border: none;
        }

        .btn-success {
            background: var(--green);
            color: white;
            border: none;
        }

        .btn-danger {
            background: var(--burgundy);
            color: white;
            border: none;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-card h3 {
            font-size: 2.5rem;
            color: var(--gold);
            margin-bottom: 0.5rem;
        }

        .stat-card p {
            color: rgba(255, 255, 255, 0.7);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .tab {
            padding: 0.8rem 1.5rem;
            background: var(--darker);
            border: 1px solid var(--gold);
            color: var(--gold);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .tab:hover,
        .tab.active {
            background: var(--gold);
            color: var(--dark);
        }

        /* Panels */
        .panel {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 12px;
            padding: 2rem;
            backdrop-filter: blur(10px);
        }

        .panel.active {
            display: block;
        }

        .panel h2 {
            color: var(--gold);
            margin-bottom: 1.5rem;
        }

        /* Form */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--gold);
            font-weight: 600;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            font-family: inherit;
            transition: all 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--gold);
            background: rgba(255, 255, 255, 0.15);
        }

        textarea {
            min-height: 150px;
            resize: vertical;
        }

        /* List Items */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 0.8rem;
            border: 1px solid rgba(212, 175, 55, 0.1);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-success {
            background: #2ecc71;
            color: white;
        }

        .badge-warning {
            background: #f39c12;
            color: white;
        }

        .badge-draft {
            background: #95a5a6;
            color: white;
        }

        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid var(--gold);
        }

        /* Section Cards */
        .section-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        .section-card h4 {
            color: var(--gold);
            margin-bottom: 0.5rem;
        }

        .content-box {
            background: rgba(0, 0, 0, 0.4);
            padding: 0.8rem;
            border-radius: 5px;
            margin-top: 0.5rem;
            white-space: pre-wrap;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }

            .container {
                padding: 0 1rem;
            }
        }

        /* Import Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--darker);
            padding: 2rem;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid var(--gold);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--gold);
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
        }

        .import-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .import-tab {
            padding: 0.8rem 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: var(--text);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .import-tab:hover,
        .import-tab.active {
            background: var(--gold);
            color: var(--dark);
            border-color: var(--gold);
        }

        .preview-sections {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }

        /* ========================================
           ๐ณ Tree View Styles (SaaS-style)
           ======================================== */
        .tree-view-container {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(212, 175, 55, 0.2);
            margin-top: 1rem;
        }

        .tree-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .btn-tree-action {
            padding: 0.4rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 150ms;
        }

        .btn-tree-action:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: var(--gold);
        }

        .tree-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .tree-children {
            list-style: none;
            margin: 0;
            padding: 0;
            margin-right: 24px;
            border-right: 1px solid rgba(212, 175, 55, 0.2);
            padding-top: 0.25rem;
        }

        .tree-item {
            margin: 0;
            padding: 0;
        }

        .tree-item-content {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid transparent;
            border-radius: 6px;
            margin-bottom: 2px;
            transition: all 150ms;
        }

        .tree-item-content:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: rgba(212, 175, 55, 0.2);
        }

        .tree-item-content:hover .tree-actions {
            opacity: 1;
        }

        .tree-toggle {
            width: 20px;
            height: 20px;
            padding: 0;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 150ms;
        }

        .tree-toggle i {
            font-size: 12px;
        }

        .tree-toggle.expanded i {
            transform: rotate(-90deg);
        }

        .tree-spacer {
            width: 20px;
        }

        .tree-icon {
            font-size: 16px;
            min-width: 20px;
        }

        .tree-label {
            flex: 1;
            font-size: 0.875rem;
            color: var(--text);
            font-weight: 500;
        }

        .tree-actions {
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity 150ms;
        }

        .btn-tree-icon {
            width: 24px;
            height: 24px;
            padding: 0;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 150ms;
        }

        .btn-tree-icon:hover {
            background: var(--gold);
            color: var(--dark);
        }

        .btn-tree-icon i {
            font-size: 12px;
        }

        .tree-item.active>.tree-item-content {
            background: rgba(212, 175, 55, 0.15);
            border-color: var(--gold);
        }
    </style>

</head>

<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <span style="font-size: 2rem;">๐</span>
            <div>
                <h1>ููุญุฉ ุงูุฃุฏูู v4.0 (Merged)</h1>
                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">MongoDB + Authentication + All Features
                </div>
            </div>
        </div>
        <div class="user-info">
            <span id="username" style="color: var(--gold); font-weight: 600;"></span>
            <a href="/api/admin/logout" class="btn">๐ช ุชุณุฌูู ุงูุฎุฑูุฌ</a>
        </div>
    </div>

    <div class="container">
        <!-- Stats -->
        <div class="stats">
            <div class="stat-card">
                <h3 id="sectionsCount">0</h3>
                <p>๐ ุงูุฃูุณุงู</p>
            </div>
            <div class="stat-card">
                <h3 id="sheikhsCount">0</h3>
                <p>๐ค ุงูุดููุฎ</p>
            </div>
            <div class="stat-card">
                <h3 id="lessonsCount">0</h3>
                <p>๐ ุงูุฏุฑูุณ</p>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('aiInput')">๐ค AI Master Input</button>
            <button class="tab" onclick="showTab('categories')"><i class="fa-solid fa-sitemap"></i> ุงูุฃูุณุงู
                ุงูุฑุฆูุณูุฉ</button>
            <button class="tab" onclick="showTab('sections')">๐ ุฃูุณุงู ุงูุฏุฑูุณ</button>
            <button class="tab" onclick="showTab('sheikhs')">๐ค ุงูุดููุฎ</button>
            <button class="tab" onclick="showTab('lessons')">๐ ุงูุฏุฑูุณ</button>
            <button class="tab" onclick="showTab('addLesson')">โ ุฅุถุงูุฉ ุฏุฑุณ</button>
            <button class="tab" onclick="showTab('preview')">๐๏ธ ูุนุงููุฉ</button>
        </div>

        <!-- AI Input Panel -->
        <div id="aiInput" class="panel active">
            <h2>๐ค ุญูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู (Master Input)</h2>
            <p style="color: rgba(255,255,255,0.7); margin-bottom: 1.5rem;">
                ุงูุชุจ ุงููุญุชูู ุงูุฎุงู ููุงุ ูุงูุฐูุงุก ุงูุงุตุทูุงุนู ูููุฒุนู ุชููุงุฆูุงู ุนูู ุงูุฃูุณุงู ุงููุชุงุญุฉ.
            </p>
            <textarea id="rawInput" placeholder="ูุซุงู: ุงูุชุจ ูุต ุงูุฏุฑุณุ ุฃู ุฑุงุจุท ููุชููุจุ ุฃู ุฃู ูุญุชูู ูุตู..."
                style="min-height: 250px;"></textarea>
            <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="analyzeWithAI()">
                    โจ ุชุญููู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู
                </button>
                <button class="btn" onclick="saveDraft()">
                    ๐พ ุญูุธ ููุณูุฏุฉ
                </button>
                <button class="btn" onclick="clearInput()">
                    ๐๏ธ ูุณุญ
                </button>
            </div>

            <h3 style="color: var(--gold); margin: 2rem 0 1rem;">
                ๐ ุงูุฃูุณุงู ุงููุชุงุญุฉ <span style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">(ุณูุชู ุชูุฒูุน ุงููุญุชูู
                    ุนูููุง)</span>
            </h3>
            <div id="availableSections"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
                <div class="alert">ุฌุงุฑู ุชุญููู ุงูุฃูุณุงู...</div>
            </div>
        </div>

        <!-- ============ Categories Panel (ุงูุฃูุณุงู ุงูุฑุฆูุณูุฉ ุงููุฑููุฉ) ============ -->
        <div id="categories" class="panel">
            <h2><i class="fa-solid fa-sitemap" style="color: var(--gold)"></i> ุฅุฏุงุฑุฉ ุงูุฃูุณุงู ุงูุฑุฆูุณูุฉ</h2>
            <div class="alert">
                <i class="fa-solid fa-circle-info"></i> ูุธุงู ูุฑูู ูุฑู - ุฃุถู ุฃููููุฉ ุฌูุง ุฃููููุฉ ุจุฑุงุญุชู ุจูุง ุญุฏูุฏ!
            </div>

            <!-- Breadcrumb Navigation -->
            <div id="catBreadcrumb"
                style="display:flex; align-items:center; gap:8px; margin:15px 0; flex-wrap:wrap; font-size:0.95rem;">
                <span onclick="loadCategories(null)" style="cursor:pointer; color:var(--gold); font-weight:700;"><i
                        class="fa-solid fa-house"></i> ุงูุฑุฆูุณูุฉ</span>
            </div>

            <!-- Add Category Form -->
            <div
                style="background:rgba(218,165,32,0.08); border:1px solid rgba(218,165,32,0.25); border-radius:12px; padding:18px; margin-bottom:20px;">
                <h4 style="color:var(--gold); margin-bottom:12px;"><i class="fa-solid fa-circle-plus"></i> ุฅุถุงูุฉ ูุณู
                    ุฌุฏูุฏ</h4>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div class="form-group" style="margin:0">
                        <label>ุงุณู ุงููุณู</label>
                        <input type="text" id="catName" placeholder="ูุซุงู: ุงููุฑุขู ุงููุฑูู">
                    </div>
                    <div class="form-group" style="margin:0">
                        <label>ุงููุตู (ุงุฎุชูุงุฑู)</label>
                        <input type="text" id="catDesc" placeholder="ูุตู ูุฎุชุตุฑ">
                    </div>
                </div>
                <div style="display:flex; gap:12px; margin-top:12px; align-items:flex-end; flex-wrap:wrap;">
                    <div class="form-group" style="margin:0; flex:1">
                        <label>ุงูุฃููููุฉ (Font Awesome)</label>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="text" id="catIcon" value="fa-solid fa-folder" style="flex:1"
                                oninput="previewIcon()">
                            <div id="catIconPreview"
                                style="width:45px; height:45px; display:flex; align-items:center; justify-content:center; background:rgba(218,165,32,0.15); border-radius:10px; font-size:1.4rem; color:#DAA520;">
                                <i class="fa-solid fa-folder"></i>
                            </div>
                        </div>
                    </div>
                    <div class="form-group" style="margin:0; width:120px;">
                        <label>ุงูููู</label>
                        <input type="color" id="catColor" value="#DAA520"
                            style="height:42px; width:100%; border:none; border-radius:8px; cursor:pointer;">
                    </div>
                    <button class="btn btn-primary" onclick="addCategory()" style="height:42px; white-space:nowrap;">
                        <i class="fa-solid fa-plus"></i> ุฅุถุงูุฉ
                    </button>
                </div>

                <!-- Popular Icons Grid -->
                <div style="margin-top:12px;">
                    <small style="color:rgba(255,255,255,0.5);">ุฃููููุงุช ุณุฑูุนุฉ:</small>
                    <div id="quickIcons" style="display:flex; flex-wrap:wrap; gap:6px; margin-top:6px;"></div>
                </div>
            </div>

            <!-- Categories Tree View -->
            <div class="tree-view-container">
                <div class="tree-controls">
                    <button class="btn-tree-action" onclick="expandAllTree()">
                        <i class="fa-solid fa-angles-down"></i> Expand All
                    </button>
                    <button class="btn-tree-action" onclick="collapseAllTree()">
                        <i class="fa-solid fa-angles-up"></i> Collapse All
                    </button>
                    <button class="btn-tree-action" onclick="reloadCategoryTree()">
                        <i class="fa-solid fa-rotate"></i> Reload
                    </button>
                </div>

                <ul class="tree-list" id="categoryTreeRoot">
                    <!-- Tree will be rendered here by JS -->
                </ul>
            </div>
        </div>

        <!-- Sections Panel -->
        <div id="sections" class="panel">
            <h2>๐ ุฅุฏุงุฑุฉ ุงูุฃูุณุงู (ุฏููุงููููุฉ)</h2>
            <div class="alert">
                โน๏ธ ุงูุฃูุณุงู ุฏููุงููููุฉ - ููููู ุฅุถุงูุฉ ุฃู ุญุฐู ุฃู ูุณู ูู MongoDB
            </div>
            <button class="btn btn-primary" onclick="seedSections()">๐ฑ ููุก ุงูุฃูุณุงู ุงูุงูุชุฑุงุถูุฉ (15 ูุณู)</button>
            <hr style="margin: 1.5rem 0; border-color: rgba(212,175,55,0.3)">

            <div class="form-group">
                <label>ุฅุถุงูุฉ ูุณู ุฌุฏูุฏ</label>
                <div style="display:flex; gap:10px; flex-wrap:wrap">
                    <input type="text" id="newSectionKey" placeholder="sectionKey (ุงูุฌููุฒู)" style="flex:1">
                    <input type="text" id="newSectionLabel" placeholder="ุงูุงุณู ุจุงูุนุฑุจู" style="flex:1">
                    <input type="text" id="newSectionIcon" placeholder="๐" style="width:80px">
                    <button class="btn btn-primary" onclick="addSection()">ุฅุถุงูุฉ</button>
                </div>
            </div>

            <div id="sectionsList"></div>
        </div>

        <!-- Sheikhs Panel -->
        <div id="sheikhs" class="panel">
            <h2>๐ค ุฅุฏุงุฑุฉ ุงูุดููุฎ</h2>
            <div class="form-group">
                <label>ุงุณู ุงูุดูุฎ</label>
                <div style="display:flex; gap:10px">
                    <input type="text" id="sheikhName" placeholder="ูุซุงู: ุงูุดูุฎ ุงูุดุนุฑุงูู" style="flex:1">
                    <button class="btn btn-primary" onclick="addSheikh()">โ ุฅุถุงูุฉ</button>
                </div>
            </div>
            <hr style="margin: 1.5rem 0; border-color: rgba(212,175,55,0.3)">
            <div id="sheikhsList"></div>
        </div>

        <!-- Lessons Panel -->
        <div id="lessons" class="panel">
            <h2>๐ ุงูุฏุฑูุณ ุงููุถุงูุฉ</h2>
            <div id="lessonsList"></div>
        </div>

        <!-- Add Lesson Panel -->
        <div id="addLesson" class="panel">
            <h2 id="formTitle">โ ุฅุถุงูุฉ ุฏุฑุณ ุฌุฏูุฏ</h2>
            <div class="form-group">
                <label>ุนููุงู ุงูุฏุฑุณ</label>
                <input type="text" id="lessonTitle" placeholder="ูุซุงู: ุฏุฑุณ ุนู ูุตุนุจ ุจู ุนููุฑ">
            </div>
            <div class="form-group">
                <label>ุงูุดูุฎ</label>
                <select id="lessonSheikh"></select>
            </div>
            <div class="form-group">
                <label>ุงููุญุชูู ุงูุฎุงู (ุงูุชูุฑูุบ)</label>
                <textarea id="lessonContent" placeholder="ุฃูุตู ููุง ุชูุฑูุบ ุงูุฏุฑุณ..."></textarea>
            </div>
            <div class="form-group"
                style="border: 1px dashed var(--gold); padding: 15px; border-radius: 10px; background: rgba(212,175,55,0.05);">
                <label style="color: var(--gold);">๐ ุงููุตุฏุฑ ุงููุฑุฌุนู ุงูุฏุงุฎูู <small style="color:#999;">(ุงุฎุชูุงุฑู -
                        ููุฃุฏูู ูุงูู AI ููุท)</small></label>
                <textarea id="lessonRawSource"
                    placeholder="ุฃูุตู ููุง ุงููุต ุงูุฃุตูู ููุดูุฎ ุฃู ููุงุญุธุงุช ุณุฑูุฉ... (ูู ูุธูุฑ ูู ุงููููุน)"
                    style="border-color: var(--gold); min-height: 100px;"></textarea>
                <small style="color:#888; display:block; margin-top:5px;">โ๏ธ ูุฐุง ุงูุญูู ูุง ูุธูุฑ ูููุณุชุฎุฏููู ููุง ูุฏุฎู ูู
                    ุงูุชุญููู - ููุญูุธ ุงูุฏุงุฎูู ููุท</small>
            </div>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button class="btn btn-primary" id="saveDraftBtn" onclick="saveLesson(false)">๐พ ุญูุธ ููุณูุฏุฉ</button>
                <button class="btn btn-success" id="savePublishBtn" onclick="saveLesson(true)">๐ ูุดุฑ ูุจุงุดุฑุฉ</button>
                <button class="btn" style="background: #9b59b6; color: white;" onclick="openImportModal()">๐ ุงุณุชูุฑุงุฏ
                    JSON/ูุต</button>
                <button class="btn btn-danger" id="cancelEditBtn" onclick="cancelEdit()" style="display:none;">โ ุฅูุบุงุก
                    ุงูุชุนุฏูู</button>
            </div>
        </div>

        <!-- Preview Panel -->
        <div id="preview" class="panel">
            <h2>๐๏ธ ูุนุงููุฉ ุงููููุน</h2>
            <div class="form-group">
                <label>ุงุฎุชุฑ ุฏุฑุณ ูููุนุงููุฉ</label>
                <select id="previewLesson" onchange="showPreview()"></select>
            </div>
            <div id="previewContent"></div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>๐ ุงุณุชูุฑุงุฏ ูุญุชูู ุฎุงุฑุฌู</h2>
                <button class="close-btn" onclick="closeImportModal()">ร</button>
            </div>

            <!-- ๐ ุงููุตุฏุฑ ุงููุฑุฌุนู - ุชุตููู ุจููุณุฌู -->
            <div
                style="background: linear-gradient(135deg, rgba(142,68,173,0.15), rgba(155,89,182,0.08)); border: 2px solid rgba(155,89,182,0.5); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                <label style="color: #9b59b6; font-weight: 700; font-size: 1rem; display: block; margin-bottom: 8px;">
                    ๐ ุงููุตุฏุฑ ุงููุฑุฌุนู ุงูุฏุงุฎูู
                    <span style="font-weight: 400; font-size: 0.8rem; color: #999;">(ุงุฎุชูุงุฑู - ููุฃุฏูู ูุงูู AI
                        ููุท)</span>
                </label>
                <textarea id="importRawSource" placeholder="๐ ุฃูุตู ููุง ุงููุต ุงูุฃุตูู ููุดูุฎ ุฃู ููุงุญุธุงุชู ุงูุณุฑูุฉ..."
                    style="border: 1px solid rgba(155,89,182,0.4); background: rgba(155,89,182,0.05); min-height: 80px; border-radius: 8px; width: 100%; box-sizing: border-box; padding: 10px; color: var(--text); font-family: inherit;"></textarea>
                <small style="color: #8e44ad; display: block; margin-top: 5px;">โ๏ธ ูุชุญูุธ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุท โข ูุง ูุธูุฑ
                    ูู ุงููููุน ููุงุฆูุงู โข ููู AI ูุณุชูุจูุงู</small>
            </div>

            <div class="import-tabs">
                <button class="import-tab active" onclick="setImportType('json')">๐ฆ JSON ุฌุงูุฒ</button>
                <button class="import-tab" onclick="setImportType('text')">๐ ูุต ุนุงุฏู</button>
            </div>

            <div class="form-group">
                <label id="importLabel">ุงูุตู ููุฏ JSON ููุง:</label>
                <textarea id="importContent" placeholder='{ "title": "...", "overview": {...} }'></textarea>
            </div>

            <div id="importResult"></div>
            <div id="previewSections" class="preview-sections" style="display:none;"></div>

            <div style="margin-top: 20px; display: flex; gap: 1rem;">
                <button class="btn" style="background: #3498db; color: white;" onclick="parseAndPreview()">๐ ูุนุงููุฉ
                    ูุชุญููู</button>
                <button class="btn btn-success" onclick="applyImport()" id="applyBtn" disabled>โ ุชุทุจูู ุนูู
                    ุงูุฏุฑุณ</button>
            </div>
        </div>
    </div>

    <script>
        // ============ Auth Check ============
        async function checkAuth() {
            try {
                const res = await fetch('/api/admin/check');
                const data = await res.json();

                if (!data.loggedIn) {
                    window.location.href = '/admin';
                    return;
                }

                document.getElementById('username').textContent = `๐ค ${data.username || 'Admin'}`;
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = '/admin';
            }
        }

        // ============ Tab Navigation ============
        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            // Find the clicked tab button
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => {
                if (t.textContent.includes(tabId === 'categories' ? 'ุงูุฃูุณุงู ุงูุฑุฆูุณูุฉ' :
                    tabId === 'sections' ? 'ุฃูุณุงู ุงูุฏุฑูุณ' :
                        tabId === 'sheikhs' ? 'ุงูุดููุฎ' :
                            tabId === 'lessons' ? 'ุงูุฏุฑูุณ' :
                                tabId === 'addLesson' ? 'ุฅุถุงูุฉ ุฏุฑุณ' :
                                    tabId === 'preview' ? 'ูุนุงููุฉ' : 'AI')) {
                    t.classList.add('active');
                }
            });
            document.getElementById(tabId).classList.add('active');

            if (tabId === 'preview') updatePreviewSelect();
            if (tabId === 'categories') loadCategories(currentParentId);
        }

        // ============ Sections ============
        let sections = [];

        async function loadSections() {
            try {
                const res = await fetch('/api/sections/variables');
                const data = await res.json();

                sections = data.sections || [];
                document.getElementById('sectionsCount').textContent = data.count || 0;

                // Display in AI tab
                document.getElementById('availableSections').innerHTML = sections.map(sec => `
                    <div class="section-card">
                        <h4>${sec.icon} ${sec.labelAr}</h4>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">${sec.key}</div>
                        <div style="font-size: 0.9rem; margin-top: 0.5rem;">${sec.description || ''}</div>
                    </div>
                `).join('');

                // Display in sections management tab
                const res2 = await fetch('/api/sections/all', {
                    credentials: 'include'
                });
                const allSections = await res2.json();

                document.getElementById('sectionsList').innerHTML = allSections.map(s => `
                    <div class="list-item">
                        <span>${s.icon} ${s.labelAr} <small style="color:#999;">(${s.sectionKey})</small></span>
                        <span class="badge ${s.isActive ? 'badge-success' : 'badge-warning'}">
                            ${s.isActive ? 'ูุดุท' : 'ูุนุทู'}
                        </span>
                        <button class="btn btn-danger" onclick="deleteSection('${s._id}')">ุญุฐู</button>
                    </div>
                `).join('') || '<p>ูุง ุชูุฌุฏ ุฃูุณุงู</p>';

            } catch (error) {
                console.error('Error loading sections:', error);
                document.getElementById('availableSections').innerHTML = `
                    <div class="alert" style="background: rgba(231,76,60,0.2); border-color: #e74c3c;">
                        โ ูุดู ุชุญููู ุงูุฃูุณุงู
                    </div>
                `;
            }
        }

        async function seedSections() {
            if (!confirm('ูู ุชุฑูุฏ ููุก ุงูุฃูุณุงู ุงูุงูุชุฑุงุถูุฉ (15 ูุณู)ุ')) return;

            try {
                const res = await fetch('/scripts/seed_sections.js');
                const text = await res.text();
                eval(text); // Execute seed script

                alert('โ ุชู ููุก ุงูุฃูุณุงู ุจูุฌุงุญ!');
                loadSections();
            } catch (error) {
                console.error('Seed error:', error);
                alert('โ ูุดู ููุก ุงูุฃูุณุงู. ุงุณุชุฎุฏู: node scripts/seed_sections.js');
            }
        }

        async function addSection() {
            const key = document.getElementById('newSectionKey').value.trim();
            const labelAr = document.getElementById('newSectionLabel').value.trim();
            const icon = document.getElementById('newSectionIcon').value.trim() || '๐';

            if (!key || !labelAr) return alert('ุฃุฏุฎู ุงูุจูุงูุงุช ูุงููุฉ');

            try {
                const res = await fetch('/api/sections', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ sectionKey: key, labelAr, icon, isActive: true })
                });

                if (res.ok) {
                    document.getElementById('newSectionKey').value = '';
                    document.getElementById('newSectionLabel').value = '';
                    document.getElementById('newSectionIcon').value = '';
                    loadSections();
                    alert('โ ุชู ุฅุถุงูุฉ ุงููุณู');
                } else {
                    alert('โ ูุดู ุฅุถุงูุฉ ุงููุณู');
                }
            } catch (error) {
                console.error('Add section error:', error);
                alert('โ ุฎุทุฃ ูู ุงูุงุชุตุงู');
            }
        }

        async function deleteSection(id) {
            if (!confirm('ูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงููุณูุ')) return;

            try {
                const res = await fetch(`/api/sections/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (res.ok) {
                    loadSections();
                    alert('โ ุชู ุงูุญุฐู');
                } else {
                    alert('โ ูุดู ุงูุญุฐู');
                }
            } catch (error) {
                console.error('Delete error:', error);
            }
        }

        // ============ Sheikhs (MongoDB API) ============
        let sheikhsList = [];

        async function loadSheikhs() {
            try {
                const res = await fetch('/api/sheikhs');
                sheikhsList = await res.json();
                document.getElementById('sheikhsCount').textContent = sheikhsList.length;

                document.getElementById('sheikhsList').innerHTML = sheikhsList.map(s => `
                    <div class="list-item">
                        <span>๐ค ${s.name}</span>
                        <button class="btn btn-danger" onclick="deleteSheikh('${s._id}')">ุญุฐู</button>
                    </div>
                `).join('') || '<p>ูุง ููุฌุฏ ุดููุฎ</p>';

                // Update select
                const select = document.getElementById('lessonSheikh');
                select.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุดูุฎ</option>' +
                    sheikhsList.map(s => `<option value="${s._id}">${s.name}</option>`).join('');
            } catch (error) {
                console.error('Load sheikhs error:', error);
            }
        }

        async function addSheikh() {
            const name = document.getElementById('sheikhName').value.trim();
            if (!name) return alert('ุฃุฏุฎู ุงุณู ุงูุดูุฎ');

            try {
                const res = await fetch('/api/sheikhs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                if (res.ok) {
                    document.getElementById('sheikhName').value = '';
                    loadSheikhs();
                    alert('โ ุชู ุฅุถุงูุฉ ุงูุดูุฎ');
                } else {
                    alert('โ ูุดู ุฅุถุงูุฉ ุงูุดูุฎ');
                }
            } catch (error) {
                console.error('Add sheikh error:', error);
                alert('โ ุฎุทุฃ ูู ุงูุงุชุตุงู');
            }
        }

        async function deleteSheikh(id) {
            if (!confirm('ูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงูุดูุฎุ')) return;
            try {
                const res = await fetch(`/api/sheikhs/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadSheikhs();
                    alert('โ ุชู ุงูุญุฐู');
                } else {
                    alert('โ ูุดู ุงูุญุฐู');
                }
            } catch (error) {
                console.error('Delete sheikh error:', error);
            }
        }

        // ============ Lessons (MongoDB) ============
        let currentEditId = null;

        async function loadLessons() {
            try {
                const res = await fetch('/api/lessons');
                const lessons = await res.json();

                document.getElementById('lessonsCount').textContent = lessons.length;

                document.getElementById('lessonsList').innerHTML = lessons.map(l => {
                    const sheikhName = l.sheikhName || l.sheikhId || 'ุบูุฑ ูุญุฏุฏ';
                    const isPublished = l.status === 'published';
                    return `
                        <div class="list-item">
                            <div>
                                <strong>๐ ${l.title}</strong>
                                <small style="color:#999"> - ${sheikhName}</small>
                                <span class="badge badge-${isPublished ? 'success' : 'draft'}">
                                    ${isPublished ? 'ููุดูุฑ' : 'ูุณูุฏุฉ'}
                                </span>
                            </div>
                            <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                                <button class="btn" style="background:#3498db;color:white;" onclick="editLesson('${l._id}')">โ๏ธ ุชุนุฏูู</button>
                                <button class="btn btn-success" onclick="togglePublish('${l._id}', ${isPublished})">${isPublished ? '๐ค ุฅูุบุงุก ุงููุดุฑ' : '๐ ูุดุฑ'}</button>
                                <button class="btn btn-danger" onclick="deleteLesson('${l._id}')">๐๏ธ ุญุฐู</button>
                            </div>
                        </div>
                    `;
                }).join('') || '<p>ูุง ุชูุฌุฏ ุฏุฑูุณ ุจุนุฏ</p>';

            } catch (error) {
                console.error('Load lessons error:', error);
            }
        }

        async function saveLesson(publish = false) {
            const title = document.getElementById('lessonTitle').value.trim();
            const sheikhId = document.getElementById('lessonSheikh').value;
            const rawContent = document.getElementById('lessonContent').value.trim();
            const rawSource = document.getElementById('lessonRawSource').value.trim();

            if (!title) return alert('ุฃุฏุฎู ุนููุงู ุงูุฏุฑุณ');

            const lessonData = {
                title,
                sheikhId,
                rawContent,
                rawSource,
                status: publish ? 'published' : 'draft'
            };

            try {
                let res;
                if (currentEditId) {
                    // โ๏ธ ุชุญุฏูุซ ุฏุฑุณ ููุฌูุฏ
                    res = await fetch(`/api/lessons/${currentEditId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(lessonData)
                    });
                } else {
                    // โ ุฅุถุงูุฉ ุฏุฑุณ ุฌุฏูุฏ
                    res = await fetch('/api/lessons', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(lessonData)
                    });
                }

                if (res.ok) {
                    const wasEditing = !!currentEditId;
                    cancelEdit();
                    loadLessons();
                    alert(wasEditing ? 'โ ุชู ุชุญุฏูุซ ุงูุฏุฑุณ ุจูุฌุงุญ' : (publish ? '๐ ุชู ูุดุฑ ุงูุฏุฑุณ' : '๐พ ุชู ุญูุธ ุงูุฏุฑุณ ููุณูุฏุฉ'));
                    showTab('lessons');
                    // click the lessons tab to make it active
                    document.querySelectorAll('.tab')[3]?.click();
                } else {
                    const err = await res.json();
                    alert('โ ูุดู: ' + (err.error || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'));
                }
            } catch (error) {
                console.error('Save lesson error:', error);
                alert('โ ุฎุทุฃ ูู ุงูุงุชุตุงู');
            }
        }

        async function editLesson(id) {
            try {
                const res = await fetch(`/api/lessons/${id}`);
                const lesson = await res.json();

                if (!lesson || lesson.error) {
                    return alert('โ ูุดู ุชุญููู ุงูุฏุฑุณ');
                }

                currentEditId = id;

                // ููุก ุงูููุฑู
                document.getElementById('lessonTitle').value = lesson.title || '';
                document.getElementById('lessonContent').value = lesson.rawContent || (typeof lesson.overview === 'string' ? lesson.overview : JSON.stringify(lesson, null, 2));
                document.getElementById('lessonRawSource').value = lesson.rawSource || '';

                // ุงุฎุชูุงุฑ ุงูุดูุฎ
                const sheikhSelect = document.getElementById('lessonSheikh');
                if (lesson.sheikhId) {
                    sheikhSelect.value = lesson.sheikhId;
                }

                // ุชุบููุฑ UI ููุถุน ุงูุชุนุฏูู
                document.getElementById('formTitle').innerHTML = 'โ๏ธ ุชุนุฏูู ุงูุฏุฑุณ: <span style="color:#3498db">' + lesson.title + '</span>';
                document.getElementById('cancelEditBtn').style.display = 'inline-block';
                document.getElementById('saveDraftBtn').textContent = '๐พ ุญูุธ ุงูุชุนุฏูู';
                document.getElementById('savePublishBtn').textContent = '๐ ุญูุธ ููุดุฑ';

                // ุงูุงูุชูุงู ูุชุงุจ ุงูุฅุถุงูุฉ
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.tab')[4].classList.add('active');
                document.getElementById('addLesson').classList.add('active');

                // Scroll ููุฃุนูู
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (error) {
                console.error('Edit lesson error:', error);
                alert('โ ุฎุทุฃ ูู ุชุญููู ุงูุฏุฑุณ');
            }
        }

        function cancelEdit() {
            currentEditId = null;
            document.getElementById('lessonTitle').value = '';
            document.getElementById('lessonContent').value = '';
            document.getElementById('lessonRawSource').value = '';
            document.getElementById('lessonSheikh').selectedIndex = 0;
            document.getElementById('formTitle').textContent = 'โ ุฅุถุงูุฉ ุฏุฑุณ ุฌุฏูุฏ';
            document.getElementById('cancelEditBtn').style.display = 'none';
            document.getElementById('saveDraftBtn').textContent = '๐พ ุญูุธ ููุณูุฏุฉ';
            document.getElementById('savePublishBtn').textContent = '๐ ูุดุฑ ูุจุงุดุฑุฉ';
        }

        async function togglePublish(id, isCurrentlyPublished) {
            const newStatus = isCurrentlyPublished ? 'draft' : 'published';
            const msg = isCurrentlyPublished ? 'ุฅูุบุงุก ูุดุฑ ุงูุฏุฑุณุ' : 'ูุดุฑ ุงูุฏุฑุณุ';
            if (!confirm(msg)) return;

            try {
                const res = await fetch(`/api/lessons/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });

                if (res.ok) {
                    loadLessons();
                    alert(isCurrentlyPublished ? '๐ค ุชู ุฅูุบุงุก ุงููุดุฑ' : '๐ ุชู ุงููุดุฑ ุจูุฌุงุญ');
                } else {
                    alert('โ ูุดู ุชุญุฏูุซ ุงูุญุงูุฉ');
                }
            } catch (error) {
                console.error('Publish error:', error);
                alert('โ ุฎุทุฃ ูู ุงูุงุชุตุงู');
            }
        }

        async function deleteLesson(id) {
            if (!confirm('ูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงูุฏุฑุณุ')) return;

            try {
                const res = await fetch(`/api/lessons/${id}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    loadLessons();
                    alert('โ ุชู ุงูุญุฐู');
                } else {
                    alert('โ ูุดู ุงูุญุฐู');
                }
            } catch (error) {
                console.error('Delete error:', error);
            }
        }

        // ============ AI Functions ============
        function analyzeWithAI() {
            const content = document.getElementById('rawInput').value;

            if (!content.trim()) {
                return alert('โ ุงูุฑุฌุงุก ูุชุงุจุฉ ูุญุชูู ุฃููุงู!');
            }

            alert('๐ค ุชุญููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุงุฏู ูู Phase 4!\n\nุญุงููุงู: ุงูุฃูุณุงู ูุชููุฑุฉ ูุงููุธุงู ุฌุงูุฒ ููุชูุฒูุน ุงูุฏููุงูููู.');
        }

        function saveDraft() {
            const content = document.getElementById('rawInput').value;
            localStorage.setItem('aiDraft', content);
            alert('โ ุชู ุญูุธ ุงููุณูุฏุฉ ูุญููุงู!');
        }

        function clearInput() {
            if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ูุณุญ ุงููุญุชููุ')) {
                document.getElementById('rawInput').value = '';
                localStorage.removeItem('aiDraft');
            }
        }

        function restoreDraft() {
            const draft = localStorage.getItem('aiDraft');
            if (draft) {
                document.getElementById('rawInput').value = draft;
            }
        }

        // ============ Preview ============
        function updatePreviewSelect() {
            // TODO: Implement preview
            alert('ูุฑูุจุงู: ูุนุงููุฉ ุงูุฏุฑูุณ');
        }

        function showPreview() {
            // TODO
        }

        // ============ Import Modal Functions ============
        let importType = 'json';
        let importedData = null;

        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
            document.getElementById('importContent').value = '';
            document.getElementById('importRawSource').value = '';
            document.getElementById('importResult').innerHTML = '';
            document.getElementById('previewSections').style.display = 'none';
            document.getElementById('applyBtn').disabled = true;
            importedData = null;
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }

        function setImportType(type) {
            importType = type;
            document.querySelectorAll('.import-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            const label = document.getElementById('importLabel');
            const textarea = document.getElementById('importContent');

            if (type === 'json') {
                label.textContent = 'ุงูุตู ููุฏ JSON ููุง:';
                textarea.placeholder = '{ "title": "...", "overview": {...} }';
            } else {
                label.textContent = 'ุงูุตู ุงููุต ููุง (ุงูุนูุงููู ุจู ## ุฃู ุฅูููุฌู):';
                textarea.placeholder = '## ูุธุฑุฉ ุนุงูุฉ\nุงูุฑุณุงูุฉ ุงููุฑูุฒูุฉ...\n\n## ุงูุขูุงุช\n- ุขูุฉ 1\n- ุขูุฉ 2';
            }
        }

        function parseAndPreview() {
            const content = document.getElementById('importContent').value.trim();
            const resultDiv = document.getElementById('importResult');
            const previewDiv = document.getElementById('previewSections');

            if (!content) {
                resultDiv.innerHTML = '<div class="alert" style="background: rgba(231,76,60,0.2); border-color: #e74c3c;">โ ุงูุฑุฌุงุก ุฅุฏุฎุงู ูุญุชูู ุฃููุงู</div>';
                return;
            }

            try {
                if (importType === 'json') {
                    importedData = JSON.parse(content);
                    resultDiv.innerHTML = '<div class="alert" style="background: rgba(46,204,113,0.2); border-color: #2ecc71;">โ JSON ุตุญูุญ - ุชู ุงูุชุญููู ุจูุฌุงุญ!</div>';

                    // Show preview
                    previewDiv.style.display = 'block';
                    previewDiv.innerHTML = `
                        <h4 style="color: var(--gold);">๐ ูุนุงููุฉ ุงููุญุชูู:</h4>
                        <p><strong>ุงูุนููุงู:</strong> ${importedData.title || 'ุบูุฑ ูุญุฏุฏ'}</p>
                        <p><strong>ุนุฏุฏ ุงูุฃูุณุงู:</strong> ${Object.keys(importedData).length}</p>
                        <pre style="background: var(--dark); padding: 10px; border-radius: 8px; max-height: 200px; overflow: auto; font-size: 0.8rem;">${JSON.stringify(importedData, null, 2).substring(0, 500)}...</pre>
                    `;
                } else {
                    // Parse plain text
                    importedData = parseTextContent(content);
                    resultDiv.innerHTML = '<div class="alert" style="background: rgba(46,204,113,0.2); border-color: #2ecc71;">โ ุชู ุชุญููู ุงููุต ุจูุฌุงุญ!</div>';

                    previewDiv.style.display = 'block';
                    previewDiv.innerHTML = `
                        <h4 style="color: var(--gold);">๐ ูุนุงููุฉ ุงููุญุชูู:</h4>
                        <p><strong>ุงูุฃูุณุงู ุงูููุชุดูุฉ:</strong> ${Object.keys(importedData).length}</p>
                    `;
                }

                document.getElementById('applyBtn').disabled = false;

            } catch (error) {
                resultDiv.innerHTML = `<div class="alert" style="background: rgba(231,76,60,0.2); border-color: #e74c3c;">โ ุฎุทุฃ ูู ุงูุชุญููู: ${error.message}</div>`;
                importedData = null;
                document.getElementById('applyBtn').disabled = true;
            }
        }

        function parseTextContent(text) {
            // Simple text parser
            const sections = {};
            const lines = text.split('\n');
            let currentSection = 'general';

            lines.forEach(line => {
                if (line.startsWith('##') || line.match(/^[๐๐๐คโ๏ธ๐ก๐โ๐๏ธ๐ค๐โจ๐๐๐]/)) {
                    currentSection = line.replace(/^##\s*/, '').replace(/^[๐๐๐คโ๏ธ๐ก๐โ๐๏ธ๐ค๐โจ๐๐๐]\s*/, '').trim();
                    sections[currentSection] = [];
                } else if (line.trim()) {
                    if (!sections[currentSection]) sections[currentSection] = [];
                    sections[currentSection].push(line.trim());
                }
            });

            return sections;
        }

        function applyImport() {
            if (!importedData) return;

            const rawSource = document.getElementById('importRawSource').value.trim();

            // Apply to lesson form
            if (importedData.title) {
                document.getElementById('lessonTitle').value = importedData.title;
            }

            // Store full data in lessonContent as JSON
            document.getElementById('lessonContent').value = JSON.stringify(importedData, null, 2);

            // Set rawSource if provided
            if (rawSource) {
                document.getElementById('lessonRawSource').value = rawSource;
            }

            closeImportModal();
            alert('โ ุชู ุงุณุชูุฑุงุฏ ุงููุญุชูู ุจูุฌุงุญ! ููููู ุงูุขู ุญูุธ ุงูุฏุฑุณ.');
        }

        // ============ Categories Management (ุงูุฃูุณุงู ุงููุฑููุฉ) ============
        let currentParentId = null;
        let breadcrumbPath = []; // [{id, name}]
        let allCategoriesCache = [];

        const QUICK_ICONS = [
            { icon: 'fa-solid fa-book-quran', label: 'ูุฑุขู' },
            { icon: 'fa-solid fa-hands-praying', label: 'ุฏุนุงุก' },
            { icon: 'fa-solid fa-mosque', label: 'ูุณุฌุฏ' },
            { icon: 'fa-solid fa-user-tie', label: 'ุดูุฎ' },
            { icon: 'fa-solid fa-graduation-cap', label: 'ุฏุฑุณ' },
            { icon: 'fa-solid fa-scroll', label: 'ุชูุณูุฑ' },
            { icon: 'fa-solid fa-scale-balanced', label: 'ุฃุญูุงู' },
            { icon: 'fa-solid fa-gem', label: 'ููุงุฆุฏ' },
            { icon: 'fa-solid fa-microphone', label: 'ุจูุฏูุงุณุช' },
            { icon: 'fa-solid fa-book-open', label: 'ูุชุงุจ' },
            { icon: 'fa-solid fa-star', label: 'ูุฌูุฉ' },
            { icon: 'fa-solid fa-heart', label: 'ููุจ' },
            { icon: 'fa-solid fa-moon', label: 'ููุงู' },
            { icon: 'fa-solid fa-sun', label: 'ุดูุณ' },
            { icon: 'fa-solid fa-users', label: 'ูุฌููุนุฉ' },
            { icon: 'fa-solid fa-circle-question', label: 'ุณุคุงู' },
            { icon: 'fa-solid fa-lightbulb', label: 'ููุฑุฉ' },
            { icon: 'fa-solid fa-bell', label: 'ุชุฐููุฑ' },
            { icon: 'fa-solid fa-layer-group', label: 'ุทุจูุงุช' },
            { icon: 'fa-solid fa-magnifying-glass', label: 'ุจุญุซ' },
            { icon: 'fa-solid fa-play', label: 'ุชุดุบูู' },
            { icon: 'fa-solid fa-chart-pie', label: 'ุฅุญุตุงุฆูุงุช' },
            { icon: 'fa-solid fa-clock', label: 'ููุช' },
            { icon: 'fa-solid fa-map', label: 'ุฎุฑูุทุฉ' },
        ];

        function renderQuickIcons() {
            document.getElementById('quickIcons').innerHTML = QUICK_ICONS.map(q => `
                <button type="button" onclick="pickIcon('${q.icon}')" title="${q.label}"
                    style="width:36px; height:36px; display:flex; align-items:center; justify-content:center;
                    background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius:8px;
                    cursor:pointer; color:#ccc; font-size:1rem; transition:all 0.2s;"
                    onmouseover="this.style.background='rgba(218,165,32,0.2)'; this.style.color='#DAA520'; this.style.borderColor='rgba(218,165,32,0.4)';"
                    onmouseout="this.style.background='rgba(255,255,255,0.06)'; this.style.color='#ccc'; this.style.borderColor='rgba(255,255,255,0.12)';">
                    <i class="${q.icon}"></i>
                </button>
            `).join('');
        }

        function pickIcon(iconClass) {
            document.getElementById('catIcon').value = iconClass;
            previewIcon();
        }

        function previewIcon() {
            const iconClass = document.getElementById('catIcon').value.trim();
            document.getElementById('catIconPreview').innerHTML = `<i class="${iconClass}"></i>`;
        }

        // ============ Tree View Functions ============

        /**
         * Toggle expand/collapse for a tree node
         */
        function toggleTreeNode(button) {
            const item = button.closest('.tree-item');
            const children = item.querySelector('.tree-children');

            if (!children) return;

            const isExpanded = children.style.display !== 'none';

            if (isExpanded) {
                children.style.display = 'none';
                button.classList.remove('expanded');
            } else {
                children.style.display = 'block';
                button.classList.add('expanded');
            }
        }

        /**
         * Expand all tree nodes
         */
        function expandAllTree() {
            document.querySelectorAll('.tree-children').forEach(children => {
                children.style.display = 'block';
            });
            document.querySelectorAll('.tree-toggle').forEach(toggle => {
                toggle.classList.add('expanded');
            });
        }

        /**
         * Collapse all tree nodes
         */
        function collapseAllTree() {
            document.querySelectorAll('.tree-children').forEach(children => {
                children.style.display = 'none';
            });
            document.querySelectorAll('.tree-toggle').forEach(toggle => {
                toggle.classList.remove('expanded');
            });
        }

        /**
         * Reload the category tree
         */
        async function reloadCategoryTree() {
            await loadCategoryTree();
        }

        /**
         * Render tree view recursively
         */
        function renderTreeView(categories, level = 0) {
            if (!categories || categories.length === 0) return '';

            let html = '';

            categories.forEach(cat => {
                const hasChildren = cat.children && cat.children.length > 0;
                const iconColor = cat.color || '#D4AF37';
                const icon = cat.icon || 'fa-solid fa-folder';

                html += `
                    <li class="tree-item" data-id="${cat._id}" data-level="${level}">
                        <div class="tree-item-content">
                            ${hasChildren
                        ? `<button class="tree-toggle" onclick="toggleTreeNode(this)"><i class="fa-solid fa-chevron-left"></i></button>`
                        : '<span class="tree-spacer"></span>'
                    }
                            <i class="tree-icon ${icon}" style="color: ${iconColor}"></i>
                            <span class="tree-label">${cat.name}</span>
                            <div class="tree-actions">
                                <button class="btn-tree-icon" onclick="addChildCategory('${cat._id}')" title="ุฅุถุงูุฉ ูุณู ูุฑุนู">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                                <button class="btn-tree-icon" onclick="editCategoryFromTree('${cat._id}')" title="ุชุนุฏูู">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                                <button class="btn-tree-icon" onclick="deleteCategoryFromTree('${cat._id}', '${cat.name}')" title="ุญุฐู">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                `;

                if (hasChildren) {
                    html += `<ul class="tree-children" style="display: none;">`;
                    html += renderTreeView(cat.children, level + 1);
                    html += `</ul>`;
                }

                html += `</li>`;
            });

            return html;
        }

        /**
         * Load category tree from API
         */
        async function loadCategoryTree() {
            try {
                const res = await fetch('/api/categories/tree');
                const tree = await res.json();

                const container = document.getElementById('categoryTreeRoot');

                if (tree.length === 0) {
                    container.innerHTML = `
                        <div style="text-align:center; padding:40px; color:rgba(255,255,255,0.4);">
                            <i class="fa-solid fa-folder-open" style="font-size:3rem; margin-bottom:1rem;"></i>
                            <p>ูุง ุชูุฌุฏ ุฃูุณุงู ุญุชู ุงูุขู</p>
                            <p style="font-size:0.9rem;">ุฃุถู ูุณู ุฌุฏูุฏ ูู ุงูุฃุนูู</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = renderTreeView(tree, 0);
                }

                // Update stat
                const allRes = await fetch('/api/categories/all');
                const allCats = await allRes.json();
                const catCountEl = document.getElementById('categoriesCount');
                if (catCountEl) catCountEl.textContent = allCats.length;

            } catch (error) {
                console.error('Load tree error:', error);
                const container = document.getElementById('categoryTreeRoot');
                container.innerHTML = `
                    <div class="alert" style="background:rgba(231,76,60,0.2); border-color:#e74c3c;">
                        โ ูุดู ุชุญููู ุงูุฃูุณุงู
                    </div>
                `;
            }
        }

        /**
         * Add child category
         */
        function addChildCategory(parentId) {
            currentParentId = parentId;
            document.getElementById('catName').focus();
        }

        /**
         * Edit category from tree
         */
        async function editCategoryFromTree(id) {
            try {
                const res = await fetch(`/api/categories/${id}`);
                const cat = await res.json();

                document.getElementById('catName').value = cat.name;
                document.getElementById('catDesc').value = cat.description || '';
                document.getElementById('catIcon').value = cat.icon || 'fa-solid fa-folder';
                document.getElementById('catColor').value = cat.color || '#DAA520';
                previewIcon();

                // Store edit mode
                window.editingCategoryId = id;

                alert('ุฌุงูุฒ ููุชุนุฏูู - ุงุถุบุท "ุฅุถุงูุฉ" ููุญูุธ');
            } catch (error) {
                console.error('Edit error:', error);
                alert('ูุดู ุชุญููู ุจูุงูุงุช ุงููุณู');
            }
        }

        /**
         * Delete category from tree
         */
        async function deleteCategoryFromTree(id, name) {
            if (!confirm(`ูู ุชุฑูุฏ ุญุฐู "${name}"ุ\n\nุชุญุฐูุฑ: ุณูุชู ุญุฐู ุฌููุน ุงูุฃูุณุงู ุงููุฑุนูุฉ!`)) return;

            try {
                const res = await fetch(`/api/categories/${id}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Delete failed');

                alert('โ ุชู ุงูุญุฐู ุจูุฌุงุญ');
                await loadCategoryTree();
            } catch (error) {
                console.error('Delete error:', error);
                alert('โ ูุดู ุงูุญุฐู');
            }
        }

        async function loadCategories(parentId) {

            currentParentId = parentId;

            try {
                const url = parentId
                    ? `/api/categories/children/${parentId}`
                    : '/api/categories/all';
                const res = await fetch(url);
                let categories = await res.json();

                // ูู ูู ุงูุฑุฆูุณูุฉุ ุงุนุฑุถ ุงูู root ุจุณ
                if (!parentId) {
                    categories = categories.filter(c => !c.parentId);
                }

                allCategoriesCache = categories;
                renderCategories(categories);
                renderBreadcrumb();

                // Update stat
                const allRes = await fetch('/api/categories/all');
                const allCats = await allRes.json();
                const catCountEl = document.getElementById('categoriesCount');
                if (catCountEl) catCountEl.textContent = allCats.length;

            } catch (error) {
                console.error('Load categories error:', error);
                document.getElementById('categoriesList').innerHTML = `
                    <div class="alert" style="background:rgba(231,76,60,0.2); border-color:#e74c3c;">โ ูุดู ุชุญููู ุงูุฃูุณุงู</div>
                `;
            }
        }

        function renderBreadcrumb() {
            const bc = document.getElementById('catBreadcrumb');
            let html = `<span onclick="navigateToRoot()" style="cursor:pointer; color:var(--gold); font-weight:700;"><i class="fa-solid fa-house"></i> ุงูุฑุฆูุณูุฉ</span>`;

            breadcrumbPath.forEach((item, idx) => {
                html += ` <i class="fa-solid fa-chevron-left" style="color:rgba(255,255,255,0.3); font-size:0.7rem;"></i> `;
                if (idx === breadcrumbPath.length - 1) {
                    html += `<span style="color:white; font-weight:600;">${item.name}</span>`;
                } else {
                    html += `<span onclick="navigateToBreadcrumb(${idx})" style="cursor:pointer; color:var(--gold);">${item.name}</span>`;
                }
            });
            bc.innerHTML = html;
        }

        function navigateToRoot() {
            breadcrumbPath = [];
            // Load category tree view
            loadCategoryTree();

        }

        function navigateToBreadcrumb(index) {
            const item = breadcrumbPath[index];
            breadcrumbPath = breadcrumbPath.slice(0, index + 1);
            loadCategories(item.id);
        }

        function openCategory(id, name) {
            breadcrumbPath.push({ id, name });
            loadCategories(id);
        }

        function renderCategories(categories) {
            if (categories.length === 0) {
                document.getElementById('categoriesList').innerHTML = `
                    <div style="text-align:center; padding:40px; color:rgba(255,255,255,0.4);">
                        <i class="fa-solid fa-folder-open" style="font-size:3rem; margin-bottom:15px; display:block;"></i>
                        <p>ูุง ุชูุฌุฏ ุฃูุณุงู ููุง ุจุนุฏ</p>
                        <p style="font-size:0.85rem;">ุฃุถู ูุณู ุฌุฏูุฏ ูู ุงูููุฑู ุฃุนูุงู โฌ๏ธ</p>
                    </div>
                `;
                return;
            }

            document.getElementById('categoriesList').innerHTML = `
                <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(220px, 1fr)); gap:14px;">
                    ${categories.map(cat => `
                        <div class="cat-card" style="background:linear-gradient(145deg, rgba(30,30,40,0.95), rgba(20,20,30,0.98));
                            border:1px solid ${cat.color || '#DAA520'}30; border-radius:14px; padding:18px;
                            cursor:pointer; transition:all 0.3s; position:relative;"
                            onmouseover="this.style.transform='translateY(-3px)'; this.style.borderColor='${cat.color || '#DAA520'}80'; this.style.boxShadow='0 8px 25px ${cat.color || '#DAA520'}20';"
                            onmouseout="this.style.transform=''; this.style.borderColor='${cat.color || '#DAA520'}30'; this.style.boxShadow='none';">
                            
                            <!-- ุงูุฏุฎูู ุนูุฏ ุงูุถุบุท ุนูู ุงูุฃููููุฉ/ุงูุงุณู -->
                            <div onclick="openCategory('${cat._id}', '${cat.name.replace(/'/g, "\\'")}')"
                                style="text-align:center; margin-bottom:12px;">
                                <div style="width:55px; height:55px; margin:0 auto 10px; display:flex; align-items:center;
                                    justify-content:center; background:${cat.color || '#DAA520'}18; border-radius:14px;
                                    font-size:1.8rem; color:${cat.color || '#DAA520'};">
                                    <i class="${cat.icon || 'fa-solid fa-folder'}"></i>
                                </div>
                                <h4 style="color:white; font-size:1rem; margin:0;">${cat.name}</h4>
                                ${cat.description ? `<small style="color:rgba(255,255,255,0.4); font-size:0.8rem;">${cat.description}</small>` : ''}
                            </div>
                            
                            <!-- ุฃุฒุฑุงุฑ ุงูุชุนุฏูู ูุงูุญุฐู -->
                            <div style="display:flex; gap:6px; justify-content:center; border-top:1px solid rgba(255,255,255,0.08); padding-top:10px;">
                                <button onclick="event.stopPropagation(); editCategory('${cat._id}')" 
                                    style="background:rgba(52,152,219,0.15); border:1px solid rgba(52,152,219,0.3); color:#3498db;
                                    border-radius:8px; padding:5px 12px; cursor:pointer; font-size:0.8rem; transition:all 0.2s;"
                                    onmouseover="this.style.background='rgba(52,152,219,0.3)'"
                                    onmouseout="this.style.background='rgba(52,152,219,0.15)'">
                                    <i class="fa-solid fa-pen"></i> ุชุนุฏูู
                                </button>
                                <button onclick="event.stopPropagation(); deleteCategory('${cat._id}', '${cat.name.replace(/'/g, "\\\'")}')" 
                                    style="background:rgba(231,76,60,0.15); border:1px solid rgba(231,76,60,0.3); color:#e74c3c;
                                    border-radius:8px; padding:5px 12px; cursor:pointer; font-size:0.8rem; transition:all 0.2s;"
                                    onmouseover="this.style.background='rgba(231,76,60,0.3)'"
                                    onmouseout="this.style.background='rgba(231,76,60,0.15)'">
                                    <i class="fa-solid fa-trash"></i> ุญุฐู
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function addCategory() {
            const name = document.getElementById('catName').value.trim();
            const icon = document.getElementById('catIcon').value.trim() || 'fa-solid fa-folder';
            const color = document.getElementById('catColor').value || '#DAA520';
            const description = document.getElementById('catDesc').value.trim();

            if (!name) return alert('ุฃุฏุฎู ุงุณู ุงููุณู!');

            try {
                const res = await fetch('/api/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name, icon, color, description,
                        parentId: currentParentId
                    })
                });

                if (res.ok) {
                    document.getElementById('catName').value = '';
                    document.getElementById('catDesc').value = '';

                    // Reload tree view instead of old list
                    await loadCategoryTree();

                    alert('โ ุชู ุฅุถุงูุฉ ุงููุณู!');
                } else {
                    const err = await res.json();
                    alert('โ ูุดู: ' + (err.error || 'ุฎุทุฃ ุบูุฑ ูุนุฑูู'));
                }
            } catch (error) {
                console.error('Add category error:', error);
                alert('โ ุฎุทุฃ ูู ุงูุงุชุตุงู');
            }
        }


        async function editCategory(id) {
            try {
                // Get current data
                const allRes = await fetch('/api/categories/all');
                const allCats = await allRes.json();
                const cat = allCats.find(c => c._id === id);
                if (!cat) return alert('ุงููุณู ุบูุฑ ููุฌูุฏ');

                const newName = prompt('ุงุณู ุงููุณู:', cat.name);
                if (newName === null) return; // cancelled

                const newIcon = prompt('ุงูุฃููููุฉ (Font Awesome class):', cat.icon || 'fa-solid fa-folder');
                if (newIcon === null) return;

                const newColor = prompt('ุงูููู (hex):', cat.color || '#DAA520');
                if (newColor === null) return;

                const res = await fetch(`/api/categories/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: newName || cat.name,
                        icon: newIcon || cat.icon,
                        color: newColor || cat.color
                    })
                });

                if (res.ok) {
                    loadCategories(currentParentId);
                    alert('โ ุชู ุงูุชุนุฏูู!');
                } else {
                    alert('โ ูุดู ุงูุชุนุฏูู');
                }
            } catch (error) {
                console.error('Edit category error:', error);
            }
        }

        async function deleteCategory(id, name) {
            if (!confirm(`โ๏ธ ุญุฐู "${name}" ููู ุงูุฃูุณุงู ุงููุฑุนูุฉุ\nูุฐุง ูุง ูููู ุงูุชุฑุงุฌุน ุนูู!`)) return;

            try {
                const res = await fetch(`/api/categories/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadCategories(currentParentId);
                    alert('โ ุชู ุงูุญุฐู!');
                } else {
                    alert('โ ูุดู ุงูุญุฐู');
                }
            } catch (error) {
                console.error('Delete category error:', error);
            }
        }

        // ============ Initialize ============
        window.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            restoreDraft();
            renderQuickIcons();
            await loadCategories(null);
            await loadSections();
            await loadSheikhs();
            await loadLessons();
        });
    </script>
</body>

</html>