<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Admin Panel v4</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #D4AF37;
            --dark: #1a1a2e;
            --darker: #16213e;
            --burgundy: #722F37;
            --green: #27ae60;
            --text: #f5f5f5;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, var(--darker) 100%);
            color: var(--text);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--darker);
            border-bottom: 2px solid var(--gold);
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo h1 {
            color: var(--gold);
            font-size: 1.6rem;
            text-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            padding: 0.6rem 1.5rem;
            border: 1px solid var(--gold);
            border-radius: 8px;
            background: rgba(212, 175, 55, 0.1);
            color: var(--gold);
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            font-weight: 600;
        }

        .btn:hover {
            background: var(--gold);
            color: var(--dark);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gold) 0%, #e6c547 100%);
            color: var(--dark);
            border: none;
        }

        .btn-success {
            background: var(--green);
            color: white;
            border: none;
        }

        .btn-danger {
            background: var(--burgundy);
            color: white;
            border: none;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-card h3 {
            font-size: 2.5rem;
            color: var(--gold);
            margin-bottom: 0.5rem;
        }

        .stat-card p {
            color: rgba(255, 255, 255, 0.7);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .tab {
            padding: 0.8rem 1.5rem;
            background: var(--darker);
            border: 1px solid var(--gold);
            color: var(--gold);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .tab:hover,
        .tab.active {
            background: var(--gold);
            color: var(--dark);
        }

        /* Panels */
        .panel {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 12px;
            padding: 2rem;
            backdrop-filter: blur(10px);
        }

        .panel.active {
            display: block;
        }

        .panel h2 {
            color: var(--gold);
            margin-bottom: 1.5rem;
        }

        /* Form */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--gold);
            font-weight: 600;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            font-family: inherit;
            transition: all 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--gold);
            background: rgba(255, 255, 255, 0.15);
        }

        textarea {
            min-height: 150px;
            resize: vertical;
        }

        /* List Items */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 0.8rem;
            border: 1px solid rgba(212, 175, 55, 0.1);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .badge {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-success {
            background: #2ecc71;
            color: white;
        }

        .badge-warning {
            background: #f39c12;
            color: white;
        }

        .badge-draft {
            background: #95a5a6;
            color: white;
        }

        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            background: rgba(212, 175, 55, 0.1);
            border: 1px solid var(--gold);
        }

        /* Section Cards */
        .section-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        .section-card h4 {
            color: var(--gold);
            margin-bottom: 0.5rem;
        }

        .content-box {
            background: rgba(0, 0, 0, 0.4);
            padding: 0.8rem;
            border-radius: 5px;
            margin-top: 0.5rem;
            white-space: pre-wrap;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }

            .container {
                padding: 0 1rem;
            }
        }

        /* Import Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--darker);
            padding: 2rem;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid var(--gold);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--gold);
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
        }

        .import-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .import-tab {
            padding: 0.8rem 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(212, 175, 55, 0.3);
            color: var(--text);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .import-tab:hover,
        .import-tab.active {
            background: var(--gold);
            color: var(--dark);
            border-color: var(--gold);
        }

        .preview-sections {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <span style="font-size: 2rem;">ğŸŒ™</span>
            <div>
                <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† v4.0 (Merged)</h1>
                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">MongoDB + Authentication + All Features
                </div>
            </div>
        </div>
        <div class="user-info">
            <span id="username" style="color: var(--gold); font-weight: 600;"></span>
            <a href="/api/admin/logout" class="btn">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
        </div>
    </div>

    <div class="container">
        <!-- Stats -->
        <div class="stats">
            <div class="stat-card">
                <h3 id="sectionsCount">0</h3>
                <p>ğŸ“š Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</p>
            </div>
            <div class="stat-card">
                <h3 id="sheikhsCount">0</h3>
                <p>ğŸ‘¤ Ø§Ù„Ø´ÙŠÙˆØ®</p>
            </div>
            <div class="stat-card">
                <h3 id="lessonsCount">0</h3>
                <p>ğŸ“– Ø§Ù„Ø¯Ø±ÙˆØ³</p>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('aiInput')">ğŸ¤– AI Master Input</button>
            <button class="tab" onclick="showTab('categories')"><i class="fa-solid fa-sitemap"></i> Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <button class="tab" onclick="showTab('sections')">ğŸ“š Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¯Ø±ÙˆØ³</button>
            <button class="tab" onclick="showTab('sheikhs')">ğŸ‘¤ Ø§Ù„Ø´ÙŠÙˆØ®</button>
            <button class="tab" onclick="showTab('lessons')">ğŸ“– Ø§Ù„Ø¯Ø±ÙˆØ³</button>
            <button class="tab" onclick="showTab('addLesson')">â• Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³</button>
            <button class="tab" onclick="showTab('preview')">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
        </div>

        <!-- AI Input Panel -->
        <div id="aiInput" class="panel active">
            <h2>ğŸ¤– Ø­Ù‚Ù„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (Master Input)</h2>
            <p style="color: rgba(255,255,255,0.7); margin-bottom: 1.5rem;">
                Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø§Ù… Ù‡Ù†Ø§ØŒ ÙˆØ§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù‡ÙŠÙˆØ²Ø¹Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©.
            </p>
            <textarea id="rawInput" placeholder="Ù…Ø«Ø§Ù„: Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø¯Ø±Ø³ØŒ Ø£Ùˆ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ØŒ Ø£Ùˆ Ø£ÙŠ Ù…Ø­ØªÙˆÙ‰ Ù†ØµÙŠ..."
                style="min-height: 250px;"></textarea>
            <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="analyzeWithAI()">
                    âœ¨ ØªØ­Ù„ÙŠÙ„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
                </button>
                <button class="btn" onclick="saveDraft()">
                    ğŸ’¾ Ø­ÙØ¸ ÙƒÙ…Ø³ÙˆØ¯Ø©
                </button>
                <button class="btn" onclick="clearInput()">
                    ğŸ—‘ï¸ Ù…Ø³Ø­
                </button>
            </div>

            <h3 style="color: var(--gold); margin: 2rem 0 1rem;">
                ğŸ“‚ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø© <span style="font-size: 0.9rem; color: rgba(255,255,255,0.6);">(Ø³ÙŠØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                    Ø¹Ù„ÙŠÙ‡Ø§)</span>
            </h3>
            <div id="availableSections"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
                <div class="alert">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…...</div>
            </div>
        </div>

        <!-- ============ Categories Panel (Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„Ù‡Ø±Ù…ÙŠØ©) ============ -->
        <div id="categories" class="panel">
            <h2><i class="fa-solid fa-sitemap" style="color: var(--gold)"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
            <div class="alert">
                <i class="fa-solid fa-circle-info"></i> Ù†Ø¸Ø§Ù… Ù‡Ø±Ù…ÙŠ Ù…Ø±Ù† - Ø£Ø¶Ù Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¬ÙˆØ§ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¨Ø±Ø§Ø­ØªÙƒ Ø¨Ù„Ø§ Ø­Ø¯ÙˆØ¯!
            </div>

            <!-- Breadcrumb Navigation -->
            <div id="catBreadcrumb"
                style="display:flex; align-items:center; gap:8px; margin:15px 0; flex-wrap:wrap; font-size:0.95rem;">
                <span onclick="loadCategories(null)" style="cursor:pointer; color:var(--gold); font-weight:700;"><i
                        class="fa-solid fa-house"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </div>

            <!-- Add Category Form -->
            <div
                style="background:rgba(218,165,32,0.08); border:1px solid rgba(218,165,32,0.25); border-radius:12px; padding:18px; margin-bottom:20px;">
                <h4 style="color:var(--gold); margin-bottom:12px;"><i class="fa-solid fa-circle-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…
                    Ø¬Ø¯ÙŠØ¯</h4>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                    <div class="form-group" style="margin:0">
                        <label>Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…</label>
                        <input type="text" id="catName" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…">
                    </div>
                    <div class="form-group" style="margin:0">
                        <label>Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input type="text" id="catDesc" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ±">
                    </div>
                </div>
                <div style="display:flex; gap:12px; margin-top:12px; align-items:flex-end; flex-wrap:wrap;">
                    <div class="form-group" style="margin:0; flex:1">
                        <label>Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© (Font Awesome)</label>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="text" id="catIcon" value="fa-solid fa-folder" style="flex:1"
                                oninput="previewIcon()">
                            <div id="catIconPreview"
                                style="width:45px; height:45px; display:flex; align-items:center; justify-content:center; background:rgba(218,165,32,0.15); border-radius:10px; font-size:1.4rem; color:#DAA520;">
                                <i class="fa-solid fa-folder"></i>
                            </div>
                        </div>
                    </div>
                    <div class="form-group" style="margin:0; width:120px;">
                        <label>Ø§Ù„Ù„ÙˆÙ†</label>
                        <input type="color" id="catColor" value="#DAA520"
                            style="height:42px; width:100%; border:none; border-radius:8px; cursor:pointer;">
                    </div>
                    <button class="btn btn-primary" onclick="addCategory()" style="height:42px; white-space:nowrap;">
                        <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ©
                    </button>
                </div>

                <!-- Popular Icons Grid -->
                <div style="margin-top:12px;">
                    <small style="color:rgba(255,255,255,0.5);">Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø³Ø±ÙŠØ¹Ø©:</small>
                    <div id="quickIcons" style="display:flex; flex-wrap:wrap; gap:6px; margin-top:6px;"></div>
                </div>
            </div>

            <!-- Categories Tree -->
            <div id="categoriesList" style="min-height:100px;"></div>
        </div>

        <!-- Sections Panel -->
        <div id="sections" class="panel">
            <h2>ğŸ“š Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©)</h2>
            <div class="alert">
                â„¹ï¸ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© - ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ Ø­Ø°Ù Ø£ÙŠ Ù‚Ø³Ù… Ù…Ù† MongoDB
            </div>
            <button class="btn btn-primary" onclick="seedSections()">ğŸŒ± Ù…Ù„Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (15 Ù‚Ø³Ù…)</button>
            <hr style="margin: 1.5rem 0; border-color: rgba(212,175,55,0.3)">

            <div class="form-group">
                <label>Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯</label>
                <div style="display:flex; gap:10px; flex-wrap:wrap">
                    <input type="text" id="newSectionKey" placeholder="sectionKey (Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠ)" style="flex:1">
                    <input type="text" id="newSectionLabel" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ" style="flex:1">
                    <input type="text" id="newSectionIcon" placeholder="ğŸ“–" style="width:80px">
                    <button class="btn btn-primary" onclick="addSection()">Ø¥Ø¶Ø§ÙØ©</button>
                </div>
            </div>

            <div id="sectionsList"></div>
        </div>

        <!-- Sheikhs Panel -->
        <div id="sheikhs" class="panel">
            <h2>ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´ÙŠÙˆØ®</h2>
            <div class="form-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ø´ÙŠØ®</label>
                <div style="display:flex; gap:10px">
                    <input type="text" id="sheikhName" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø´ÙŠØ® Ø§Ù„Ø´Ø¹Ø±Ø§ÙˆÙŠ" style="flex:1">
                    <button class="btn btn-primary" onclick="addSheikh()">â• Ø¥Ø¶Ø§ÙØ©</button>
                </div>
            </div>
            <hr style="margin: 1.5rem 0; border-color: rgba(212,175,55,0.3)">
            <div id="sheikhsList"></div>
        </div>

        <!-- Lessons Panel -->
        <div id="lessons" class="panel">
            <h2>ğŸ“– Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…Ø¶Ø§ÙØ©</h2>
            <div id="lessonsList"></div>
        </div>

        <!-- Add Lesson Panel -->
        <div id="addLesson" class="panel">
            <h2 id="formTitle">â• Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯</h2>
            <div class="form-group">
                <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³</label>
                <input type="text" id="lessonTitle" placeholder="Ù…Ø«Ø§Ù„: Ø¯Ø±Ø³ Ø¹Ù† Ù…ØµØ¹Ø¨ Ø¨Ù† Ø¹Ù…ÙŠØ±">
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ø´ÙŠØ®</label>
                <select id="lessonSheikh"></select>
            </div>
            <div class="form-group">
                <label>Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø§Ù… (Ø§Ù„ØªÙØ±ÙŠØº)</label>
                <textarea id="lessonContent" placeholder="Ø£Ù„ØµÙ‚ Ù‡Ù†Ø§ ØªÙØ±ÙŠØº Ø§Ù„Ø¯Ø±Ø³..."></textarea>
            </div>
            <div class="form-group"
                style="border: 1px dashed var(--gold); padding: 15px; border-radius: 10px; background: rgba(212,175,55,0.05);">
                <label style="color: var(--gold);">ğŸ”’ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ <small style="color:#999;">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ -
                        Ù„Ù„Ø£Ø¯Ù…Ù† ÙˆØ§Ù„Ù€ AI ÙÙ‚Ø·)</small></label>
                <textarea id="lessonRawSource"
                    placeholder="Ø£Ù„ØµÙ‚ Ù‡Ù†Ø§ Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ø´ÙŠØ® Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø³Ø±ÙŠØ©... (Ù„Ù† ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹)"
                    style="border-color: var(--gold); min-height: 100px;"></textarea>
                <small style="color:#888; display:block; margin-top:5px;">âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ Ù„Ø§ ÙŠØ¸Ù‡Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆÙ„Ø§ ÙŠØ¯Ø®Ù„ ÙÙŠ
                    Ø§Ù„ØªØ­Ù„ÙŠÙ„ - Ù„Ù„Ø­ÙØ¸ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ ÙÙ‚Ø·</small>
            </div>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button class="btn btn-primary" id="saveDraftBtn" onclick="saveLesson(false)">ğŸ’¾ Ø­ÙØ¸ ÙƒÙ…Ø³ÙˆØ¯Ø©</button>
                <button class="btn btn-success" id="savePublishBtn" onclick="saveLesson(true)">ğŸš€ Ù†Ø´Ø± Ù…Ø¨Ø§Ø´Ø±Ø©</button>
                <button class="btn" style="background: #9b59b6; color: white;" onclick="openImportModal()">ğŸ“‹ Ø§Ø³ØªÙŠØ±Ø§Ø¯
                    JSON/Ù†Øµ</button>
                <button class="btn btn-danger" id="cancelEditBtn" onclick="cancelEdit()" style="display:none;">âŒ Ø¥Ù„ØºØ§Ø¡
                    Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
            </div>
        </div>

        <!-- Preview Panel -->
        <div id="preview" class="panel">
            <h2>ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>
            <div class="form-group">
                <label>Ø§Ø®ØªØ± Ø¯Ø±Ø³ Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</label>
                <select id="previewLesson" onchange="showPreview()"></select>
            </div>
            <div id="previewContent"></div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“‹ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø­ØªÙˆÙ‰ Ø®Ø§Ø±Ø¬ÙŠ</h2>
                <button class="close-btn" onclick="closeImportModal()">Ã—</button>
            </div>

            <!-- ğŸ”’ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ - ØªØµÙ…ÙŠÙ… Ø¨Ù†ÙØ³Ø¬ÙŠ -->
            <div
                style="background: linear-gradient(135deg, rgba(142,68,173,0.15), rgba(155,89,182,0.08)); border: 2px solid rgba(155,89,182,0.5); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                <label style="color: #9b59b6; font-weight: 700; font-size: 1rem; display: block; margin-bottom: 8px;">
                    ğŸ”’ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ
                    <span style="font-weight: 400; font-size: 0.8rem; color: #999;">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ù„Ù„Ø£Ø¯Ù…Ù† ÙˆØ§Ù„Ù€ AI
                        ÙÙ‚Ø·)</span>
                </label>
                <textarea id="importRawSource" placeholder="ğŸ“ Ø£Ù„ØµÙ‚ Ù‡Ù†Ø§ Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ø´ÙŠØ® Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ø§Ù„Ø³Ø±ÙŠØ©..."
                    style="border: 1px solid rgba(155,89,182,0.4); background: rgba(155,89,182,0.05); min-height: 80px; border-radius: 8px; width: 100%; box-sizing: border-box; padding: 10px; color: var(--text); font-family: inherit;"></textarea>
                <small style="color: #8e44ad; display: block; margin-top: 5px;">âš ï¸ ÙŠØªØ­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø· â€¢ Ù„Ø§ ÙŠØ¸Ù‡Ø±
                    ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ â€¢ Ù„Ù„Ù€ AI Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹</small>
            </div>

            <div class="import-tabs">
                <button class="import-tab active" onclick="setImportType('json')">ğŸ“¦ JSON Ø¬Ø§Ù‡Ø²</button>
                <button class="import-tab" onclick="setImportType('text')">ğŸ“ Ù†Øµ Ø¹Ø§Ø¯ÙŠ</button>
            </div>

            <div class="form-group">
                <label id="importLabel">Ø§Ù„ØµÙ‚ ÙƒÙˆØ¯ JSON Ù‡Ù†Ø§:</label>
                <textarea id="importContent" placeholder='{ "title": "...", "overview": {...} }'></textarea>
            </div>

            <div id="importResult"></div>
            <div id="previewSections" class="preview-sections" style="display:none;"></div>

            <div style="margin-top: 20px; display: flex; gap: 1rem;">
                <button class="btn" style="background: #3498db; color: white;" onclick="parseAndPreview()">ğŸ” Ù…Ø¹Ø§ÙŠÙ†Ø©
                    ÙˆØªØ­Ù„ÙŠÙ„</button>
                <button class="btn btn-success" onclick="applyImport()" id="applyBtn" disabled>âœ… ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰
                    Ø§Ù„Ø¯Ø±Ø³</button>
            </div>
        </div>
    </div>

    <script>
        // ============ Auth Check ============
        async function checkAuth() {
            try {
                const res = await fetch('/api/admin/check');
                const data = await res.json();

                if (!data.loggedIn) {
                    window.location.href = '/admin';
                    return;
                }

                document.getElementById('username').textContent = `ğŸ‘¤ ${data.username || 'Admin'}`;
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = '/admin';
            }
        }

        // ============ Tab Navigation ============
        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            // Find the clicked tab button
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(t => {
                if (t.textContent.includes(tabId === 'categories' ? 'Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' :
                    tabId === 'sections' ? 'Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¯Ø±ÙˆØ³' :
                        tabId === 'sheikhs' ? 'Ø§Ù„Ø´ÙŠÙˆØ®' :
                            tabId === 'lessons' ? 'Ø§Ù„Ø¯Ø±ÙˆØ³' :
                                tabId === 'addLesson' ? 'Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³' :
                                    tabId === 'preview' ? 'Ù…Ø¹Ø§ÙŠÙ†Ø©' : 'AI')) {
                    t.classList.add('active');
                }
            });
            document.getElementById(tabId).classList.add('active');

            if (tabId === 'preview') updatePreviewSelect();
            if (tabId === 'categories') loadCategories(currentParentId);
        }

        // ============ Sections ============
        let sections = [];

        async function loadSections() {
            try {
                const res = await fetch('/api/sections/variables');
                const data = await res.json();

                sections = data.sections || [];
                document.getElementById('sectionsCount').textContent = data.count || 0;

                // Display in AI tab
                document.getElementById('availableSections').innerHTML = sections.map(sec => `
                    <div class="section-card">
                        <h4>${sec.icon} ${sec.labelAr}</h4>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">${sec.key}</div>
                        <div style="font-size: 0.9rem; margin-top: 0.5rem;">${sec.description || ''}</div>
                    </div>
                `).join('');

                // Display in sections management tab
                const res2 = await fetch('/api/sections/all', {
                    credentials: 'include'
                });
                const allSections = await res2.json();

                document.getElementById('sectionsList').innerHTML = allSections.map(s => `
                    <div class="list-item">
                        <span>${s.icon} ${s.labelAr} <small style="color:#999;">(${s.sectionKey})</small></span>
                        <span class="badge ${s.isActive ? 'badge-success' : 'badge-warning'}">
                            ${s.isActive ? 'Ù†Ø´Ø·' : 'Ù…Ø¹Ø·Ù„'}
                        </span>
                        <button class="btn btn-danger" onclick="deleteSection('${s._id}')">Ø­Ø°Ù</button>
                    </div>
                `).join('') || '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù…</p>';

            } catch (error) {
                console.error('Error loading sections:', error);
                document.getElementById('availableSections').innerHTML = `
                    <div class="alert" style="background: rgba(231,76,60,0.2); border-color: #e74c3c;">
                        âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                    </div>
                `;
            }
        }

        async function seedSections() {
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ù„Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (15 Ù‚Ø³Ù…)ØŸ')) return;

            try {
                const res = await fetch('/scripts/seed_sections.js');
                const text = await res.text();
                eval(text); // Execute seed script

                alert('âœ… ØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­!');
                loadSections();
            } catch (error) {
                console.error('Seed error:', error);
                alert('âŒ ÙØ´Ù„ Ù…Ù„Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…. Ø§Ø³ØªØ®Ø¯Ù…: node scripts/seed_sections.js');
            }
        }

        async function addSection() {
            const key = document.getElementById('newSectionKey').value.trim();
            const labelAr = document.getElementById('newSectionLabel').value.trim();
            const icon = document.getElementById('newSectionIcon').value.trim() || 'ğŸ“š';

            if (!key || !labelAr) return alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ù…Ù„Ø©');

            try {
                const res = await fetch('/api/sections', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ sectionKey: key, labelAr, icon, isActive: true })
                });

                if (res.ok) {
                    document.getElementById('newSectionKey').value = '';
                    document.getElementById('newSectionLabel').value = '';
                    document.getElementById('newSectionIcon').value = '';
                    loadSections();
                    alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù…');
                } else {
                    alert('âŒ ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù…');
                }
            } catch (error) {
                console.error('Add section error:', error);
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }

        async function deleteSection(id) {
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…ØŸ')) return;

            try {
                const res = await fetch(`/api/sections/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (res.ok) {
                    loadSections();
                    alert('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù');
                } else {
                    alert('âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
                }
            } catch (error) {
                console.error('Delete error:', error);
            }
        }

        // ============ Sheikhs (MongoDB API) ============
        let sheikhsList = [];

        async function loadSheikhs() {
            try {
                const res = await fetch('/api/sheikhs');
                sheikhsList = await res.json();
                document.getElementById('sheikhsCount').textContent = sheikhsList.length;

                document.getElementById('sheikhsList').innerHTML = sheikhsList.map(s => `
                    <div class="list-item">
                        <span>ğŸ‘¤ ${s.name}</span>
                        <button class="btn btn-danger" onclick="deleteSheikh('${s._id}')">Ø­Ø°Ù</button>
                    </div>
                `).join('') || '<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´ÙŠÙˆØ®</p>';

                // Update select
                const select = document.getElementById('lessonSheikh');
                select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´ÙŠØ®</option>' +
                    sheikhsList.map(s => `<option value="${s._id}">${s.name}</option>`).join('');
            } catch (error) {
                console.error('Load sheikhs error:', error);
            }
        }

        async function addSheikh() {
            const name = document.getElementById('sheikhName').value.trim();
            if (!name) return alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø´ÙŠØ®');

            try {
                const res = await fetch('/api/sheikhs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                if (res.ok) {
                    document.getElementById('sheikhName').value = '';
                    loadSheikhs();
                    alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´ÙŠØ®');
                } else {
                    alert('âŒ ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´ÙŠØ®');
                }
            } catch (error) {
                console.error('Add sheikh error:', error);
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }

        async function deleteSheikh(id) {
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø´ÙŠØ®ØŸ')) return;
            try {
                const res = await fetch(`/api/sheikhs/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadSheikhs();
                    alert('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù');
                } else {
                    alert('âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
                }
            } catch (error) {
                console.error('Delete sheikh error:', error);
            }
        }

        // ============ Lessons (MongoDB) ============
        let currentEditId = null;

        async function loadLessons() {
            try {
                const res = await fetch('/api/lessons');
                const lessons = await res.json();

                document.getElementById('lessonsCount').textContent = lessons.length;

                document.getElementById('lessonsList').innerHTML = lessons.map(l => {
                    const sheikhName = l.sheikhName || l.sheikhId || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const isPublished = l.status === 'published';
                    return `
                        <div class="list-item">
                            <div>
                                <strong>ğŸ“– ${l.title}</strong>
                                <small style="color:#999"> - ${sheikhName}</small>
                                <span class="badge badge-${isPublished ? 'success' : 'draft'}">
                                    ${isPublished ? 'Ù…Ù†Ø´ÙˆØ±' : 'Ù…Ø³ÙˆØ¯Ø©'}
                                </span>
                            </div>
                            <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
                                <button class="btn" style="background:#3498db;color:white;" onclick="editLesson('${l._id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                                <button class="btn btn-success" onclick="togglePublish('${l._id}', ${isPublished})">${isPublished ? 'ğŸ“¤ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù†Ø´Ø±' : 'ğŸš€ Ù†Ø´Ø±'}</button>
                                <button class="btn btn-danger" onclick="deleteLesson('${l._id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                            </div>
                        </div>
                    `;
                }).join('') || '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±ÙˆØ³ Ø¨Ø¹Ø¯</p>';

            } catch (error) {
                console.error('Load lessons error:', error);
            }
        }

        async function saveLesson(publish = false) {
            const title = document.getElementById('lessonTitle').value.trim();
            const sheikhId = document.getElementById('lessonSheikh').value;
            const rawContent = document.getElementById('lessonContent').value.trim();
            const rawSource = document.getElementById('lessonRawSource').value.trim();

            if (!title) return alert('Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³');

            const lessonData = {
                title,
                sheikhId,
                rawContent,
                rawSource,
                status: publish ? 'published' : 'draft'
            };

            try {
                let res;
                if (currentEditId) {
                    // âœï¸ ØªØ­Ø¯ÙŠØ« Ø¯Ø±Ø³ Ù…ÙˆØ¬ÙˆØ¯
                    res = await fetch(`/api/lessons/${currentEditId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(lessonData)
                    });
                } else {
                    // â• Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯
                    res = await fetch('/api/lessons', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(lessonData)
                    });
                }

                if (res.ok) {
                    const wasEditing = !!currentEditId;
                    cancelEdit();
                    loadLessons();
                    alert(wasEditing ? 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­' : (publish ? 'ğŸš€ ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¯Ø±Ø³' : 'ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø³ ÙƒÙ…Ø³ÙˆØ¯Ø©'));
                    showTab('lessons');
                    // click the lessons tab to make it active
                    document.querySelectorAll('.tab')[3]?.click();
                } else {
                    const err = await res.json();
                    alert('âŒ ÙØ´Ù„: ' + (err.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                }
            } catch (error) {
                console.error('Save lesson error:', error);
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }

        async function editLesson(id) {
            try {
                const res = await fetch(`/api/lessons/${id}`);
                const lesson = await res.json();

                if (!lesson || lesson.error) {
                    return alert('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø³');
                }

                currentEditId = id;

                // Ù…Ù„Ø¡ Ø§Ù„ÙÙˆØ±Ù…
                document.getElementById('lessonTitle').value = lesson.title || '';
                document.getElementById('lessonContent').value = lesson.rawContent || (typeof lesson.overview === 'string' ? lesson.overview : JSON.stringify(lesson, null, 2));
                document.getElementById('lessonRawSource').value = lesson.rawSource || '';

                // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´ÙŠØ®
                const sheikhSelect = document.getElementById('lessonSheikh');
                if (lesson.sheikhId) {
                    sheikhSelect.value = lesson.sheikhId;
                }

                // ØªØºÙŠÙŠØ± UI Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                document.getElementById('formTitle').innerHTML = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø³: <span style="color:#3498db">' + lesson.title + '</span>';
                document.getElementById('cancelEditBtn').style.display = 'inline-block';
                document.getElementById('saveDraftBtn').textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
                document.getElementById('savePublishBtn').textContent = 'ğŸš€ Ø­ÙØ¸ ÙˆÙ†Ø´Ø±';

                // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØªØ§Ø¨ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.tab')[4].classList.add('active');
                document.getElementById('addLesson').classList.add('active');

                // Scroll Ù„Ù„Ø£Ø¹Ù„Ù‰
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (error) {
                console.error('Edit lesson error:', error);
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø³');
            }
        }

        function cancelEdit() {
            currentEditId = null;
            document.getElementById('lessonTitle').value = '';
            document.getElementById('lessonContent').value = '';
            document.getElementById('lessonRawSource').value = '';
            document.getElementById('lessonSheikh').selectedIndex = 0;
            document.getElementById('formTitle').textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯';
            document.getElementById('cancelEditBtn').style.display = 'none';
            document.getElementById('saveDraftBtn').textContent = 'ğŸ’¾ Ø­ÙØ¸ ÙƒÙ…Ø³ÙˆØ¯Ø©';
            document.getElementById('savePublishBtn').textContent = 'ğŸš€ Ù†Ø´Ø± Ù…Ø¨Ø§Ø´Ø±Ø©';
        }

        async function togglePublish(id, isCurrentlyPublished) {
            const newStatus = isCurrentlyPublished ? 'draft' : 'published';
            const msg = isCurrentlyPublished ? 'Ø¥Ù„ØºØ§Ø¡ Ù†Ø´Ø± Ø§Ù„Ø¯Ø±Ø³ØŸ' : 'Ù†Ø´Ø± Ø§Ù„Ø¯Ø±Ø³ØŸ';
            if (!confirm(msg)) return;

            try {
                const res = await fetch(`/api/lessons/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });

                if (res.ok) {
                    loadLessons();
                    alert(isCurrentlyPublished ? 'ğŸ“¤ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù†Ø´Ø±' : 'ğŸš€ ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    alert('âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©');
                }
            } catch (error) {
                console.error('Publish error:', error);
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }

        async function deleteLesson(id) {
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ØŸ')) return;

            try {
                const res = await fetch(`/api/lessons/${id}`, {
                    method: 'DELETE'
                });

                if (res.ok) {
                    loadLessons();
                    alert('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù');
                } else {
                    alert('âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
                }
            } catch (error) {
                console.error('Delete error:', error);
            }
        }

        // ============ AI Functions ============
        function analyzeWithAI() {
            const content = document.getElementById('rawInput').value;

            if (!content.trim()) {
                return alert('âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ù…Ø­ØªÙˆÙ‰ Ø£ÙˆÙ„Ø§Ù‹!');
            }

            alert('ğŸ¤– ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù‚Ø§Ø¯Ù… ÙÙŠ Phase 4!\n\nØ­Ø§Ù„ÙŠØ§Ù‹: Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…ØªÙˆÙØ±Ø© ÙˆØ§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ.');
        }

        function saveDraft() {
            const content = document.getElementById('rawInput').value;
            localStorage.setItem('aiDraft', content);
            alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ù…Ø­Ù„ÙŠØ§Ù‹!');
        }

        function clearInput() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ØŸ')) {
                document.getElementById('rawInput').value = '';
                localStorage.removeItem('aiDraft');
            }
        }

        function restoreDraft() {
            const draft = localStorage.getItem('aiDraft');
            if (draft) {
                document.getElementById('rawInput').value = draft;
            }
        }

        // ============ Preview ============
        function updatePreviewSelect() {
            // TODO: Implement preview
            alert('Ù‚Ø±ÙŠØ¨Ø§Ù‹: Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¯Ø±ÙˆØ³');
        }

        function showPreview() {
            // TODO
        }

        // ============ Import Modal Functions ============
        let importType = 'json';
        let importedData = null;

        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
            document.getElementById('importContent').value = '';
            document.getElementById('importRawSource').value = '';
            document.getElementById('importResult').innerHTML = '';
            document.getElementById('previewSections').style.display = 'none';
            document.getElementById('applyBtn').disabled = true;
            importedData = null;
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }

        function setImportType(type) {
            importType = type;
            document.querySelectorAll('.import-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            const label = document.getElementById('importLabel');
            const textarea = document.getElementById('importContent');

            if (type === 'json') {
                label.textContent = 'Ø§Ù„ØµÙ‚ ÙƒÙˆØ¯ JSON Ù‡Ù†Ø§:';
                textarea.placeholder = '{ "title": "...", "overview": {...} }';
            } else {
                label.textContent = 'Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§ (Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø¨Ù€ ## Ø£Ùˆ Ø¥ÙŠÙ…ÙˆØ¬ÙŠ):';
                textarea.placeholder = '## Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©\nØ§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©...\n\n## Ø§Ù„Ø¢ÙŠØ§Øª\n- Ø¢ÙŠØ© 1\n- Ø¢ÙŠØ© 2';
            }
        }

        function parseAndPreview() {
            const content = document.getElementById('importContent').value.trim();
            const resultDiv = document.getElementById('importResult');
            const previewDiv = document.getElementById('previewSections');

            if (!content) {
                resultDiv.innerHTML = '<div class="alert" style="background: rgba(231,76,60,0.2); border-color: #e74c3c;">âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø­ØªÙˆÙ‰ Ø£ÙˆÙ„Ø§Ù‹</div>';
                return;
            }

            try {
                if (importType === 'json') {
                    importedData = JSON.parse(content);
                    resultDiv.innerHTML = '<div class="alert" style="background: rgba(46,204,113,0.2); border-color: #2ecc71;">âœ… JSON ØµØ­ÙŠØ­ - ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!</div>';

                    // Show preview
                    previewDiv.style.display = 'block';
                    previewDiv.innerHTML = `
                        <h4 style="color: var(--gold);">ğŸ“‹ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰:</h4>
                        <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${importedData.title || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
                        <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:</strong> ${Object.keys(importedData).length}</p>
                        <pre style="background: var(--dark); padding: 10px; border-radius: 8px; max-height: 200px; overflow: auto; font-size: 0.8rem;">${JSON.stringify(importedData, null, 2).substring(0, 500)}...</pre>
                    `;
                } else {
                    // Parse plain text
                    importedData = parseTextContent(content);
                    resultDiv.innerHTML = '<div class="alert" style="background: rgba(46,204,113,0.2); border-color: #2ecc71;">âœ… ØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ Ø¨Ù†Ø¬Ø§Ø­!</div>';

                    previewDiv.style.display = 'block';
                    previewDiv.innerHTML = `
                        <h4 style="color: var(--gold);">ğŸ“‹ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰:</h4>
                        <p><strong>Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ÙƒØªØ´ÙØ©:</strong> ${Object.keys(importedData).length}</p>
                    `;
                }

                document.getElementById('applyBtn').disabled = false;

            } catch (error) {
                resultDiv.innerHTML = `<div class="alert" style="background: rgba(231,76,60,0.2); border-color: #e74c3c;">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„: ${error.message}</div>`;
                importedData = null;
                document.getElementById('applyBtn').disabled = true;
            }
        }

        function parseTextContent(text) {
            // Simple text parser
            const sections = {};
            const lines = text.split('\n');
            let currentSection = 'general';

            lines.forEach(line => {
                if (line.startsWith('##') || line.match(/^[ğŸ“–ğŸ•ŒğŸ‘¤âš–ï¸ğŸ’¡ğŸ“â“ğŸ™ï¸ğŸ¤–ğŸ“šâœ¨ğŸ”’ğŸ“‹ğŸŒŸ]/)) {
                    currentSection = line.replace(/^##\s*/, '').replace(/^[ğŸ“–ğŸ•ŒğŸ‘¤âš–ï¸ğŸ’¡ğŸ“â“ğŸ™ï¸ğŸ¤–ğŸ“šâœ¨ğŸ”’ğŸ“‹ğŸŒŸ]\s*/, '').trim();
                    sections[currentSection] = [];
                } else if (line.trim()) {
                    if (!sections[currentSection]) sections[currentSection] = [];
                    sections[currentSection].push(line.trim());
                }
            });

            return sections;
        }

        function applyImport() {
            if (!importedData) return;

            const rawSource = document.getElementById('importRawSource').value.trim();

            // Apply to lesson form
            if (importedData.title) {
                document.getElementById('lessonTitle').value = importedData.title;
            }

            // Store full data in lessonContent as JSON
            document.getElementById('lessonContent').value = JSON.stringify(importedData, null, 2);

            // Set rawSource if provided
            if (rawSource) {
                document.getElementById('lessonRawSource').value = rawSource;
            }

            closeImportModal();
            alert('âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø³.');
        }

        // ============ Categories Management (Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù‡Ø±Ù…ÙŠØ©) ============
        let currentParentId = null;
        let breadcrumbPath = []; // [{id, name}]
        let allCategoriesCache = [];

        const QUICK_ICONS = [
            { icon: 'fa-solid fa-book-quran', label: 'Ù‚Ø±Ø¢Ù†' },
            { icon: 'fa-solid fa-hands-praying', label: 'Ø¯Ø¹Ø§Ø¡' },
            { icon: 'fa-solid fa-mosque', label: 'Ù…Ø³Ø¬Ø¯' },
            { icon: 'fa-solid fa-user-tie', label: 'Ø´ÙŠØ®' },
            { icon: 'fa-solid fa-graduation-cap', label: 'Ø¯Ø±Ø³' },
            { icon: 'fa-solid fa-scroll', label: 'ØªÙØ³ÙŠØ±' },
            { icon: 'fa-solid fa-scale-balanced', label: 'Ø£Ø­ÙƒØ§Ù…' },
            { icon: 'fa-solid fa-gem', label: 'ÙÙˆØ§Ø¦Ø¯' },
            { icon: 'fa-solid fa-microphone', label: 'Ø¨ÙˆØ¯ÙƒØ§Ø³Øª' },
            { icon: 'fa-solid fa-book-open', label: 'ÙƒØªØ§Ø¨' },
            { icon: 'fa-solid fa-star', label: 'Ù†Ø¬Ù…Ø©' },
            { icon: 'fa-solid fa-heart', label: 'Ù‚Ù„Ø¨' },
            { icon: 'fa-solid fa-moon', label: 'Ù‡Ù„Ø§Ù„' },
            { icon: 'fa-solid fa-sun', label: 'Ø´Ù…Ø³' },
            { icon: 'fa-solid fa-users', label: 'Ù…Ø¬Ù…ÙˆØ¹Ø©' },
            { icon: 'fa-solid fa-circle-question', label: 'Ø³Ø¤Ø§Ù„' },
            { icon: 'fa-solid fa-lightbulb', label: 'ÙÙƒØ±Ø©' },
            { icon: 'fa-solid fa-bell', label: 'ØªØ°ÙƒÙŠØ±' },
            { icon: 'fa-solid fa-layer-group', label: 'Ø·Ø¨Ù‚Ø§Øª' },
            { icon: 'fa-solid fa-magnifying-glass', label: 'Ø¨Ø­Ø«' },
            { icon: 'fa-solid fa-play', label: 'ØªØ´ØºÙŠÙ„' },
            { icon: 'fa-solid fa-chart-pie', label: 'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª' },
            { icon: 'fa-solid fa-clock', label: 'ÙˆÙ‚Øª' },
            { icon: 'fa-solid fa-map', label: 'Ø®Ø±ÙŠØ·Ø©' },
        ];

        function renderQuickIcons() {
            document.getElementById('quickIcons').innerHTML = QUICK_ICONS.map(q => `
                <button type="button" onclick="pickIcon('${q.icon}')" title="${q.label}"
                    style="width:36px; height:36px; display:flex; align-items:center; justify-content:center;
                    background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius:8px;
                    cursor:pointer; color:#ccc; font-size:1rem; transition:all 0.2s;"
                    onmouseover="this.style.background='rgba(218,165,32,0.2)'; this.style.color='#DAA520'; this.style.borderColor='rgba(218,165,32,0.4)';"
                    onmouseout="this.style.background='rgba(255,255,255,0.06)'; this.style.color='#ccc'; this.style.borderColor='rgba(255,255,255,0.12)';">
                    <i class="${q.icon}"></i>
                </button>
            `).join('');
        }

        function pickIcon(iconClass) {
            document.getElementById('catIcon').value = iconClass;
            previewIcon();
        }

        function previewIcon() {
            const iconClass = document.getElementById('catIcon').value.trim();
            document.getElementById('catIconPreview').innerHTML = `<i class="${iconClass}"></i>`;
        }

        async function loadCategories(parentId) {
            currentParentId = parentId;

            try {
                const url = parentId
                    ? `/api/categories/children/${parentId}`
                    : '/api/categories/all';
                const res = await fetch(url);
                let categories = await res.json();

                // Ù„Ùˆ ÙÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù€ root Ø¨Ø³
                if (!parentId) {
                    categories = categories.filter(c => !c.parentId);
                }

                allCategoriesCache = categories;
                renderCategories(categories);
                renderBreadcrumb();

                // Update stat
                const allRes = await fetch('/api/categories/all');
                const allCats = await allRes.json();
                const catCountEl = document.getElementById('categoriesCount');
                if (catCountEl) catCountEl.textContent = allCats.length;

            } catch (error) {
                console.error('Load categories error:', error);
                document.getElementById('categoriesList').innerHTML = `
                    <div class="alert" style="background:rgba(231,76,60,0.2); border-color:#e74c3c;">âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
                `;
            }
        }

        function renderBreadcrumb() {
            const bc = document.getElementById('catBreadcrumb');
            let html = `<span onclick="navigateToRoot()" style="cursor:pointer; color:var(--gold); font-weight:700;"><i class="fa-solid fa-house"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>`;

            breadcrumbPath.forEach((item, idx) => {
                html += ` <i class="fa-solid fa-chevron-left" style="color:rgba(255,255,255,0.3); font-size:0.7rem;"></i> `;
                if (idx === breadcrumbPath.length - 1) {
                    html += `<span style="color:white; font-weight:600;">${item.name}</span>`;
                } else {
                    html += `<span onclick="navigateToBreadcrumb(${idx})" style="cursor:pointer; color:var(--gold);">${item.name}</span>`;
                }
            });
            bc.innerHTML = html;
        }

        function navigateToRoot() {
            breadcrumbPath = [];
            loadCategories(null);
        }

        function navigateToBreadcrumb(index) {
            const item = breadcrumbPath[index];
            breadcrumbPath = breadcrumbPath.slice(0, index + 1);
            loadCategories(item.id);
        }

        function openCategory(id, name) {
            breadcrumbPath.push({ id, name });
            loadCategories(id);
        }

        function renderCategories(categories) {
            if (categories.length === 0) {
                document.getElementById('categoriesList').innerHTML = `
                    <div style="text-align:center; padding:40px; color:rgba(255,255,255,0.4);">
                        <i class="fa-solid fa-folder-open" style="font-size:3rem; margin-bottom:15px; display:block;"></i>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ù‡Ù†Ø§ Ø¨Ø¹Ø¯</p>
                        <p style="font-size:0.85rem;">Ø£Ø¶Ù Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„ÙÙˆØ±Ù… Ø£Ø¹Ù„Ø§Ù‡ â¬†ï¸</p>
                    </div>
                `;
                return;
            }

            document.getElementById('categoriesList').innerHTML = `
                <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(220px, 1fr)); gap:14px;">
                    ${categories.map(cat => `
                        <div class="cat-card" style="background:linear-gradient(145deg, rgba(30,30,40,0.95), rgba(20,20,30,0.98));
                            border:1px solid ${cat.color || '#DAA520'}30; border-radius:14px; padding:18px;
                            cursor:pointer; transition:all 0.3s; position:relative;"
                            onmouseover="this.style.transform='translateY(-3px)'; this.style.borderColor='${cat.color || '#DAA520'}80'; this.style.boxShadow='0 8px 25px ${cat.color || '#DAA520'}20';"
                            onmouseout="this.style.transform=''; this.style.borderColor='${cat.color || '#DAA520'}30'; this.style.boxShadow='none';">
                            
                            <!-- Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©/Ø§Ù„Ø§Ø³Ù… -->
                            <div onclick="openCategory('${cat._id}', '${cat.name.replace(/'/g, "\\'")}')"
                                style="text-align:center; margin-bottom:12px;">
                                <div style="width:55px; height:55px; margin:0 auto 10px; display:flex; align-items:center;
                                    justify-content:center; background:${cat.color || '#DAA520'}18; border-radius:14px;
                                    font-size:1.8rem; color:${cat.color || '#DAA520'};">
                                    <i class="${cat.icon || 'fa-solid fa-folder'}"></i>
                                </div>
                                <h4 style="color:white; font-size:1rem; margin:0;">${cat.name}</h4>
                                ${cat.description ? `<small style="color:rgba(255,255,255,0.4); font-size:0.8rem;">${cat.description}</small>` : ''}
                            </div>
                            
                            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù -->
                            <div style="display:flex; gap:6px; justify-content:center; border-top:1px solid rgba(255,255,255,0.08); padding-top:10px;">
                                <button onclick="event.stopPropagation(); editCategory('${cat._id}')" 
                                    style="background:rgba(52,152,219,0.15); border:1px solid rgba(52,152,219,0.3); color:#3498db;
                                    border-radius:8px; padding:5px 12px; cursor:pointer; font-size:0.8rem; transition:all 0.2s;"
                                    onmouseover="this.style.background='rgba(52,152,219,0.3)'"
                                    onmouseout="this.style.background='rgba(52,152,219,0.15)'">
                                    <i class="fa-solid fa-pen"></i> ØªØ¹Ø¯ÙŠÙ„
                                </button>
                                <button onclick="event.stopPropagation(); deleteCategory('${cat._id}', '${cat.name.replace(/'/g, "\\\'")}')" 
                                    style="background:rgba(231,76,60,0.15); border:1px solid rgba(231,76,60,0.3); color:#e74c3c;
                                    border-radius:8px; padding:5px 12px; cursor:pointer; font-size:0.8rem; transition:all 0.2s;"
                                    onmouseover="this.style.background='rgba(231,76,60,0.3)'"
                                    onmouseout="this.style.background='rgba(231,76,60,0.15)'">
                                    <i class="fa-solid fa-trash"></i> Ø­Ø°Ù
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function addCategory() {
            const name = document.getElementById('catName').value.trim();
            const icon = document.getElementById('catIcon').value.trim() || 'fa-solid fa-folder';
            const color = document.getElementById('catColor').value || '#DAA520';
            const description = document.getElementById('catDesc').value.trim();

            if (!name) return alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…!');

            try {
                const res = await fetch('/api/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name, icon, color, description,
                        parentId: currentParentId
                    })
                });

                if (res.ok) {
                    document.getElementById('catName').value = '';
                    document.getElementById('catDesc').value = '';
                    loadCategories(currentParentId);
                    alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù…!');
                } else {
                    const err = await res.json();
                    alert('âŒ ÙØ´Ù„: ' + (err.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
                }
            } catch (error) {
                console.error('Add category error:', error);
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }

        async function editCategory(id) {
            try {
                // Get current data
                const allRes = await fetch('/api/categories/all');
                const allCats = await allRes.json();
                const cat = allCats.find(c => c._id === id);
                if (!cat) return alert('Ø§Ù„Ù‚Ø³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');

                const newName = prompt('Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…:', cat.name);
                if (newName === null) return; // cancelled

                const newIcon = prompt('Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© (Font Awesome class):', cat.icon || 'fa-solid fa-folder');
                if (newIcon === null) return;

                const newColor = prompt('Ø§Ù„Ù„ÙˆÙ† (hex):', cat.color || '#DAA520');
                if (newColor === null) return;

                const res = await fetch(`/api/categories/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: newName || cat.name,
                        icon: newIcon || cat.icon,
                        color: newColor || cat.color
                    })
                });

                if (res.ok) {
                    loadCategories(currentParentId);
                    alert('âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„!');
                } else {
                    alert('âŒ ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
                }
            } catch (error) {
                console.error('Edit category error:', error);
            }
        }

        async function deleteCategory(id, name) {
            if (!confirm(`âš ï¸ Ø­Ø°Ù "${name}" ÙˆÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ©ØŸ\nÙ‡Ø°Ø§ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!`)) return;

            try {
                const res = await fetch(`/api/categories/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadCategories(currentParentId);
                    alert('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù!');
                } else {
                    alert('âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù');
                }
            } catch (error) {
                console.error('Delete category error:', error);
            }
        }

        // ============ Initialize ============
        window.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            restoreDraft();
            renderQuickIcons();
            await loadCategories(null);
            await loadSections();
            await loadSheikhs();
            await loadLessons();
        });
    </script>
</body>

</html>