<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† - Ø²ÙŠØ²Ùˆ ÙˆØ¨Ù„Ø§Ù„ v2.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #D4AF37;
            --dark: #1a1a2e;
            --darker: #16213e;
            --burgundy: #722F37;
            --green: #27ae60;
            --blue: #3498db;
            --text: #f5f5f5;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--dark);
            color: var(--text);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--darker), var(--dark));
            padding: 20px;
            border-bottom: 2px solid var(--gold);
            margin-bottom: 30px;
        }

        header h1 {
            color: var(--gold);
            font-size: 1.8rem;
        }

        header p {
            color: #999;
            margin-top: 5px;
        }

        .status-bar {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .status-item {
            background: var(--darker);
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .status-item.connected {
            border-color: var(--green);
        }

        .status-item.disconnected {
            border-color: var(--burgundy);
        }

        .panel {
            background: var(--darker);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid rgba(212, 175, 55, 0.2);
            margin-bottom: 20px;
        }

        .panel h2 {
            color: var(--gold);
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--gold);
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gold);
            border-radius: 8px;
            background: var(--dark);
            color: var(--text);
            font-family: inherit;
        }

        textarea {
            min-height: 200px;
            resize: vertical;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: var(--gold);
            color: var(--dark);
        }

        .btn-primary:hover {
            background: #e6c547;
        }

        .btn-danger {
            background: var(--burgundy);
            color: white;
        }

        .btn-success {
            background: var(--green);
            color: white;
        }

        .btn-info {
            background: var(--blue);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .lessons-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .lesson-card {
            background: var(--dark);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        .lesson-card h3 {
            color: var(--gold);
            margin-bottom: 10px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-right: 8px;
        }

        .badge-draft {
            background: rgba(241, 196, 15, 0.2);
            color: #f1c40f;
        }

        .badge-published {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .badge-ai {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }

        .ai-status {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }

        .loading {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .json-preview {
            background: var(--dark);
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85rem;
            max-height: 400px;
            overflow: auto;
            white-space: pre-wrap;
            margin-top: 15px;
            border: 1px solid var(--gold);
        }

        /* Import Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--darker);
            padding: 30px;
            border-radius: 16px;
            border: 2px solid var(--gold);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: var(--gold);
        }

        .close-btn {
            background: var(--burgundy);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .import-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .import-tab {
            padding: 10px 20px;
            background: var(--dark);
            border: 1px solid var(--gold);
            color: var(--text);
            border-radius: 8px;
            cursor: pointer;
        }

        .import-tab.active {
            background: var(--gold);
            color: var(--dark);
        }

        .preview-sections {
            background: var(--dark);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .section-badge {
            display: inline-block;
            padding: 5px 12px;
            margin: 5px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .section-badge.known {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .section-badge.custom {
            background: rgba(155, 89, 182, 0.2);
            color: #9b59b6;
        }

        .error-box {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            padding: 15px;
            border-radius: 8px;
            color: #e74c3c;
            margin-top: 10px;
        }

        .success-box {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
            padding: 15px;
            border-radius: 8px;
            color: #2ecc71;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <header>
        <div class="container">
            <h1>ğŸ•Œ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† - MongoDB v2.0</h1>
            <p>Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø±ÙˆØ³ ÙˆØªØ­Ù„ÙŠÙ„Ù‡Ø§ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
            <div class="status-bar">
                <div class="status-item" id="dbStatus">
                    <span id="dbIcon">ğŸ”„</span> <span id="dbText">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
                </div>
                <div class="status-item">
                    <span>ğŸ“š</span> Ø§Ù„Ø¯Ø±ÙˆØ³: <span id="lessonsCount">0</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Add Lesson Panel -->
        <div class="panel">
            <h2>ğŸ“ Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯</h2>

            <div class="form-group">
                <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³ *</label>
                <input type="text" id="lessonTitle" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­ÙƒØ§Ù… Ø§Ù„Ø¬Ù…Ø¹Ø©">
            </div>

            <div class="form-group">
                <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØ±Ø¹ÙŠ</label>
                <input type="text" id="lessonSubtitle" placeholder="Ù…Ø«Ø§Ù„: Ù…Ù† Ø®Ø·Ø¨Ø© Ø§Ù„Ø´ÙŠØ® Ù…Ø­Ù…Ø¯ ØµØ§Ù„Ø­">
            </div>

            <div class="form-group">
                <label>Ø§Ù„ÙˆØ³ÙˆÙ… (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø©)</label>
                <input type="text" id="lessonTags" placeholder="Ù…Ø«Ø§Ù„: Ø¬Ù…Ø¹Ø©ØŒ ÙÙ‚Ù‡ØŒ Ø³Ù†Ù†">
            </div>

            <div class="form-group">
                <label>Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†ØµÙŠ (Ø§Ù„ØµÙ‚ Ù†Øµ Ø§Ù„Ø¯Ø±Ø³ Ù‡Ù†Ø§) *</label>
                <textarea id="lessonContent" placeholder="Ø§Ù„ØµÙ‚ Ù‡Ù†Ø§ Ù†Øµ Ø§Ù„Ø¯Ø±Ø³ ÙƒØ§Ù…Ù„Ø§Ù‹..."></textarea>
            </div>

            <div class="form-group"
                style="background: linear-gradient(135deg, rgba(142,68,173,0.15), rgba(155,89,182,0.08)); border: 2px solid rgba(155,89,182,0.5); border-radius: 12px; padding: 15px;">
                <label style="color: #9b59b6; font-weight: 700;">ğŸ”’ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ <small
                        style="color:#999;">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ -
                        Ù„Ù„Ø£Ø¯Ù…Ù† ÙˆØ§Ù„Ù€ AI ÙÙ‚Ø·)</small></label>
                <textarea id="lessonRawSource"
                    placeholder="ğŸ“ Ø£Ù„ØµÙ‚ Ù‡Ù†Ø§ Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ø´ÙŠØ® Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø³Ø±ÙŠØ©... (Ù„Ù† ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹)"
                    style="border: 1px solid rgba(155,89,182,0.4); background: rgba(155,89,182,0.05); min-height: 100px; border-radius: 8px;"></textarea>
                <small style="color: #8e44ad; display:block; margin-top:5px;">âš ï¸ ÙŠØªØ­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø· â€¢ Ù„Ø§ ÙŠØ¸Ù‡Ø±
                    ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ â€¢ Ù„Ù„Ù€ AI Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹</small>
            </div>

            <div class="form-group">
                <button class="btn btn-info" onclick="analyzeWithAI()">ğŸ§  ØªØ­Ù„ÙŠÙ„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</button>
                <button class="btn btn-primary" onclick="openImportModal()">ğŸ“‹ Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON/Ù†Øµ</button>
                <button class="btn btn-primary" onclick="saveLesson('draft')">ğŸ’¾ Ø­ÙØ¸ ÙƒÙ…Ø³ÙˆØ¯Ø©</button>
                <button class="btn btn-success" onclick="saveLesson('published')">ğŸš€ Ù†Ø´Ø± Ø§Ù„Ø¯Ø±Ø³</button>
            </div>

            <div class="ai-status" id="aiStatus"></div>
            <div class="json-preview" id="jsonPreview" style="display:none;"></div>
        </div>

        <!-- Lessons List -->
        <div class="panel">
            <h2>ğŸ“š Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h2>
            <button class="btn btn-primary" onclick="loadLessons()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
            <a href="/website" target="_blank" class="btn btn-info">ğŸŒ ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹</a>
            <div class="lessons-grid" id="lessonsGrid">
                <p style="color:#999;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“‹ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ø­ØªÙˆÙ‰ Ø®Ø§Ø±Ø¬ÙŠ</h2>
                <button class="close-btn" onclick="closeImportModal()">Ã—</button>
            </div>

            <!-- ğŸ”’ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ - ØªØµÙ…ÙŠÙ… Ù…Ù…ÙŠØ² Ø¨Ù†ÙØ³Ø¬ÙŠ -->
            <div
                style="background: linear-gradient(135deg, rgba(142,68,173,0.15), rgba(155,89,182,0.08)); border: 2px solid rgba(155,89,182,0.5); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                <label style="color: #9b59b6; font-weight: 700; font-size: 1rem; display: block; margin-bottom: 8px;">
                    ğŸ”’ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ
                    <span style="font-weight: 400; font-size: 0.8rem; color: #999;">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ù„Ù„Ø£Ø¯Ù…Ù† ÙˆØ§Ù„Ù€ AI
                        ÙÙ‚Ø·)</span>
                </label>
                <textarea id="importRawSource" placeholder="ğŸ“ Ø£Ù„ØµÙ‚ Ù‡Ù†Ø§ Ø§Ù„Ù†Øµ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ø´ÙŠØ® Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ø§Ù„Ø³Ø±ÙŠØ©..."
                    style="border: 1px solid rgba(155,89,182,0.4); background: rgba(155,89,182,0.05); min-height: 80px; border-radius: 8px; width: 100%; box-sizing: border-box; padding: 10px; color: var(--text); font-family: inherit;"></textarea>
                <small style="color: #8e44ad; display: block; margin-top: 5px;">âš ï¸ ÙŠØªØ­ÙØ¸ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø· â€¢ Ù„Ø§ ÙŠØ¸Ù‡Ø±
                    ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ â€¢ Ù„Ù„Ù€ AI Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹</small>
            </div>

            <div class="import-tabs">
                <button class="import-tab active" onclick="setImportType('json')">ğŸ“¦ JSON Ø¬Ø§Ù‡Ø²</button>
                <button class="import-tab" onclick="setImportType('text')">ğŸ“ Ù†Øµ Ø¹Ø§Ø¯ÙŠ</button>
            </div>

            <div class="form-group">
                <label id="importLabel">Ø§Ù„ØµÙ‚ ÙƒÙˆØ¯ JSON Ù‡Ù†Ø§:</label>
                <textarea id="importContent" placeholder='{ "title": "...", "overview": {...} }'></textarea>
            </div>

            <div id="importResult"></div>
            <div id="previewSections" class="preview-sections" style="display:none;"></div>

            <div style="margin-top: 20px;">
                <button class="btn btn-info" onclick="parseAndPreview()">ğŸ” Ù…Ø¹Ø§ÙŠÙ†Ø© ÙˆØªØ­Ù„ÙŠÙ„</button>
                <button class="btn btn-success" onclick="applyImport()" id="applyBtn" disabled>âœ… ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰
                    Ø§Ù„Ø¯Ø±Ø³</button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal-overlay" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø³Ø®</h2>
                <button class="close-btn" onclick="closeHistoryModal()">Ã—</button>
            </div>
            <h3 id="historyLessonTitle" style="color: var(--gold); margin-bottom: 20px;"></h3>
            <div id="historyList" style="max-height: 400px; overflow-y: auto;">
                <p style="color:#999;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>
        </div>
    </div>

    <script>
        // ============ Configuration ============
        const API_URL = window.location.origin + '/api/lessons';

        const AI_CONFIG = {
            apiKey: 'sk-ElTXsCG5QywR7GfeRqjW1A',
            endpoints: [
                'https://api.tensorix.ai/v1',
                'https://agentrouter.org/v1'
            ],
            model: 'minimax/minimax-m2.1'
        };

        let currentAnalysis = null;

        // ============ Initialize ============
        document.addEventListener('DOMContentLoaded', function () {
            checkAPIConnection();
            loadLessons();
        });

        // ============ Check API Connection ============
        async function checkAPIConnection() {
            const statusDiv = document.getElementById('dbStatus');
            const icon = document.getElementById('dbIcon');
            const text = document.getElementById('dbText');

            try {
                const response = await fetch('/health');
                const data = await response.json();

                if (data.mongodb) {
                    statusDiv.className = 'status-item connected';
                    icon.textContent = 'âœ…';
                    text.textContent = 'MongoDB Ù…ØªØµÙ„';
                } else {
                    statusDiv.className = 'status-item disconnected';
                    icon.textContent = 'âš ï¸';
                    text.textContent = 'MongoDB ØºÙŠØ± Ù…ØªØµÙ„';
                }
            } catch (e) {
                statusDiv.className = 'status-item disconnected';
                icon.textContent = 'âŒ';
                text.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
            }
        }

        // ============ Load Lessons ============
        async function loadLessons() {
            const grid = document.getElementById('lessonsGrid');
            grid.innerHTML = '<p style="color:#999;">ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';

            try {
                const response = await fetch(API_URL);
                const lessons = await response.json();

                document.getElementById('lessonsCount').textContent = lessons.length;

                if (lessons.length === 0) {
                    grid.innerHTML = '<p style="color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±ÙˆØ³ Ø¨Ø¹Ø¯. Ø£Ø¶Ù Ø¯Ø±Ø³Ùƒ Ø§Ù„Ø£ÙˆÙ„!</p>';
                    return;
                }

                grid.innerHTML = lessons.map(lesson => `
                    <div class="lesson-card">
                        <h3>${lesson.title}</h3>
                        <p style="color:#999;">${lesson.subtitle || ''}</p>
                        <div style="margin: 10px 0;">
                            <span class="badge ${lesson.status === 'published' ? 'badge-published' : 'badge-draft'}">
                                ${lesson.status === 'published' ? 'âœ… Ù…Ù†Ø´ÙˆØ±' : 'ğŸ“ Ù…Ø³ÙˆØ¯Ø©'}
                            </span>
                            ${lesson.aiAnalyzed ? '<span class="badge badge-ai">ğŸ§  AI</span>' : ''}
                        </div>
                        <div style="margin-top: 15px;">
                            ${lesson.status !== 'published' ?
                        `<button class="btn btn-success" onclick="publishLesson('${lesson._id}')">ğŸš€ Ù†Ø´Ø±</button>` : ''}
                            <button class="btn btn-info" onclick="showHistory('${lesson._id}', '${lesson.title}')">ğŸ“œ Ø§Ù„Ø³Ø¬Ù„</button>
                            <button class="btn btn-danger" onclick="deleteLesson('${lesson._id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                grid.innerHTML = '<p style="color:#e74c3c;">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³: ' + error.message + '</p>';
            }
        }

        // ============ Save Lesson ============
        async function saveLesson(status) {
            const title = document.getElementById('lessonTitle').value.trim();
            const subtitle = document.getElementById('lessonSubtitle').value.trim();
            const tags = document.getElementById('lessonTags').value.split(',').map(t => t.trim()).filter(t => t);
            const rawContent = document.getElementById('lessonContent').value.trim();
            const rawSource = document.getElementById('lessonRawSource').value.trim();

            if (!title) { alert('Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³!'); return; }
            if (!rawContent && !currentAnalysis) { alert('Ø£Ø¯Ø®Ù„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø³ Ø£Ùˆ Ø­Ù„Ù„Ù‡ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ!'); return; }

            const lessonData = {
                title,
                subtitle,
                tags,
                rawContent,
                status,
                aiAnalyzed: !!currentAnalysis,
                ...(currentAnalysis || {})
            };

            // ğŸ”’ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ - ÙŠØªØ­ÙØ¸ Ø¨Ø³ Ù„Ùˆ ÙÙŠÙ‡ Ù…Ø­ØªÙˆÙ‰
            if (rawSource) {
                lessonData.rawSource = rawSource;
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(lessonData)
                });

                if (!response.ok) throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­ÙØ¸');

                alert(status === 'published' ? 'ğŸš€ ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¯Ø±Ø³!' : 'ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø³ÙˆØ¯Ø©!');

                // Clear form
                document.getElementById('lessonTitle').value = '';
                document.getElementById('lessonSubtitle').value = '';
                document.getElementById('lessonTags').value = '';
                document.getElementById('lessonContent').value = '';
                document.getElementById('lessonRawSource').value = '';
                document.getElementById('aiStatus').style.display = 'none';
                document.getElementById('jsonPreview').style.display = 'none';
                currentAnalysis = null;

                loadLessons();

            } catch (error) {
                alert('âŒ Ø®Ø·Ø£: ' + error.message);
            }
        }

        // ============ Publish Lesson ============
        async function publishLesson(id) {
            try {
                const response = await fetch(`${API_URL}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'published' })
                });
                if (!response.ok) throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù†Ø´Ø±');
                alert('âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¯Ø±Ø³!');
                loadLessons();
            } catch (error) {
                alert('âŒ Ø®Ø·Ø£: ' + error.message);
            }
        }

        // ============ Delete Lesson ============
        async function deleteLesson(id) {
            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ØŸ')) return;

            try {
                const response = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
                alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯Ø±Ø³!');
                loadLessons();
            } catch (error) {
                alert('âŒ Ø®Ø·Ø£: ' + error.message);
            }
        }

        // ============ AI Analysis ============
        async function analyzeWithAI() {
            const title = document.getElementById('lessonTitle').value.trim();
            const rawContent = document.getElementById('lessonContent').value.trim();
            const statusDiv = document.getElementById('aiStatus');
            const previewDiv = document.getElementById('jsonPreview');

            if (!rawContent) { alert('Ø£Ù„ØµÙ‚ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø£ÙˆÙ„Ø§Ù‹!'); return; }

            statusDiv.style.display = 'block';
            statusDiv.style.background = 'rgba(155, 89, 182, 0.2)';
            statusDiv.style.border = '1px solid #9b59b6';
            statusDiv.innerHTML = '<span class="loading">ğŸ”„</span> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...';

            // Rich AI Prompt matching mixed-version structure
            const prompt = `Ø£Ù†Øª Ø®Ø¨ÙŠØ± Ù…Ø­ØªÙˆÙ‰ Ø¥Ø³Ù„Ø§Ù…ÙŠ ÙˆÙ…Ø¨Ø±Ù…Ø¬. Ø­Ù„Ù„ Ù†Øµ Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„ØªØ§Ù„ÙŠ ÙˆØ§Ø³ØªØ®Ø±Ø¬ Ù…Ù†Ù‡ Ø¨ÙŠØ§Ù†Ø§Øª JSON Ù…Ù†Ø¸Ù…Ø© ØªØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¯Ø¹ÙˆÙŠ.

Ø§Ù„Ù†Øµ:
${rawContent.substring(0, 4000)}

Ø£Ø¬Ø¨ Ø¨Ù€ JSON ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ù†Øµ Ø¥Ø¶Ø§ÙÙŠ) Ø¨Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„ØªØ§Ù„ÙŠ:
{
    "overview": {
        "message": "Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© Ù„Ù„Ø¯Ø±Ø³ ÙÙŠ Ø¬Ù…Ù„Ø© Ø£Ùˆ Ø¬Ù…Ù„ØªÙŠÙ†",
        "points": ["Ù†Ù‚Ø·Ø© 1", "Ù†Ù‚Ø·Ø© 2", "Ù†Ù‚Ø·Ø© 3", "..."] 
    },
    "podcast": [
        {"title": "Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø´Ù‡Ø¯ Ø§Ù„Ø£ÙˆÙ„", "content": "Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø´Ù‡Ø¯", "type": "normal"},
        {"title": "Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø´Ù‡Ø¯ Ø§Ù„Ø«Ø§Ù†ÙŠ", "content": "Ù…Ø­ØªÙˆÙ‰", "type": "red"}
    ],
    "characters": [
        {"name": "Ø§Ø³Ù… Ø§Ù„Ø´Ø®ØµÙŠØ©", "role": "ÙˆØµÙ Ù…Ø®ØªØµØ±", "events": ["Ø­Ø¯Ø« 1", "Ø­Ø¯Ø« 2"], "lessons": ["Ø¯Ø±Ø³ Ù…Ø³ØªÙØ§Ø¯"]}
    ],
    "quranHadith": {
        "ayat": [{"text": "Ù†Øµ Ø§Ù„Ø¢ÙŠØ©", "surah": "Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ±Ø©", "meaning": "Ø§Ù„Ù…Ø¹Ù†Ù‰"}],
        "hadith": [{"text": "Ù†Øµ Ø§Ù„Ø­Ø¯ÙŠØ«", "purpose": "Ø§Ù„ØºØ±Ø¶ Ù…Ù†Ù‡"}],
        "duaa": [{"text": "Ù†Øµ Ø§Ù„Ø¯Ø¹Ø§Ø¡", "type": "Ù†ÙˆØ¹Ù‡"}]
    },
    "fiqh": {
        "title": "Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙÙ‚Ù‡ÙŠ",
        "sunan": [{"icon": "ğŸ§¼", "text": "Ø§Ù„Ø³Ù†Ø©"}],
        "warnings": ["ØªØ­Ø°ÙŠØ± 1"],
        "qa": [{"question": "Ø³Ø¤Ø§Ù„", "answer": "Ø¥Ø¬Ø§Ø¨Ø©", "isCorrect": true}]
    },
    "questions": {
        "trueFalse": [{"question": "Ø§Ù„Ø³Ø¤Ø§Ù„", "answer": "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©", "isCorrect": true}]
    },
    "benefits": [{"text": "Ø§Ù„ÙØ§Ø¦Ø¯Ø©", "category": "Ø¥ÙŠÙ…Ø§Ù†ÙŠ", "color": "green"}],
    "stories": [{"title": "Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚ØµØ©", "stages": [{"num": 1, "title": "Ù…Ø±Ø­Ù„Ø©", "content": "Ù…Ø­ØªÙˆÙ‰"}]}]
}

Ù…Ù„Ø§Ø­Ø¸Ø§Øª:
- Ø§Ø³ØªØ®Ø±Ø¬ ÙƒÙ„ Ø§Ù„Ø¢ÙŠØ§Øª ÙˆØ§Ù„Ø£Ø­Ø§Ø¯ÙŠØ« Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø©
- Ø­Ø¯Ø¯ Ø§Ù„Ø´Ø®ØµÙŠØ§Øª Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© Ø¨Ø§Ù„ØªÙØµÙŠÙ„
- Ø§Ø³ØªØ®Ø±Ø¬ Ø§Ù„ÙÙˆØ§Ø¦Ø¯ ÙˆØ§Ù„Ø¹Ø¨Ø±
- Ø£Ù†Ø´Ø¦ Ø£Ø³Ø¦Ù„Ø© ØµØ­/Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰
- Ù„Ùˆ Ù‚Ø³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†ØµØŒ Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±Øº []`;

            try {
                let response, data;

                for (const endpoint of AI_CONFIG.endpoints) {
                    try {
                        response = await fetch(endpoint + '/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + AI_CONFIG.apiKey
                            },
                            body: JSON.stringify({
                                model: AI_CONFIG.model,
                                messages: [{ role: 'user', content: prompt }],
                                temperature: 0.2
                            })
                        });
                        data = await response.json();
                        if (!data.error && data.choices?.[0]?.message?.content) break;
                    } catch (e) { continue; }
                }

                if (!data?.choices?.[0]?.message?.content) {
                    throw new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ API');
                }

                const aiResponse = data.choices[0].message.content;

                // Parse JSON
                const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                const parsed = JSON.parse(jsonMatch ? jsonMatch[0] : aiResponse);

                currentAnalysis = parsed;

                // Success UI
                statusDiv.style.background = 'rgba(46, 204, 113, 0.2)';
                statusDiv.style.border = '1px solid #2ecc71';
                statusDiv.innerHTML = `
                    <h4 style="color:#2ecc71;">âœ… ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!</h4>
                    <p>ğŸ“‹ Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©: ${parsed.overview?.message || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
                    <p>ğŸ“– Ø¢ÙŠØ§Øª: ${parsed.quranHadith?.ayat?.length || 0}</p>
                    <p>ğŸ•Œ Ø£Ø­Ø§Ø¯ÙŠØ«: ${parsed.quranHadith?.hadith?.length || 0}</p>
                    <p>ğŸ‘¥ Ø´Ø®ØµÙŠØ§Øª: ${parsed.characters?.length || 0}</p>
                    <p>â“ Ø£Ø³Ø¦Ù„Ø©: ${parsed.questions?.trueFalse?.length || 0}</p>
                    <p>ğŸ’ ÙÙˆØ§Ø¦Ø¯: ${parsed.benefits?.length || 0}</p>
                    <button class="btn btn-info" onclick="toggleJSON()">ğŸ‘ï¸ Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ JSON</button>
                `;

                previewDiv.textContent = JSON.stringify(parsed, null, 2);

            } catch (err) {
                statusDiv.style.background = 'rgba(231, 76, 60, 0.2)';
                statusDiv.style.border = '1px solid #e74c3c';
                statusDiv.innerHTML = 'âŒ Ø®Ø·Ø£: ' + err.message;
                currentAnalysis = null;
            }
        }

        function toggleJSON() {
            const preview = document.getElementById('jsonPreview');
            preview.style.display = preview.style.display === 'none' ? 'block' : 'none';
        }

        // ============ Smart JSON Importer ============
        let importType = 'json';
        let importedData = null;

        // Known sections with their metadata
        const KNOWN_SECTIONS = {
            overview: { label: 'Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©', icon: 'ğŸ“‹' },
            podcast: { label: 'Ø§Ù„Ø¨ÙˆØ¯ÙƒØ§Ø³Øª', icon: 'ğŸ™ï¸' },
            characters: { label: 'Ø§Ù„Ø´Ø®ØµÙŠØ§Øª', icon: 'ğŸ‘¥' },
            quranHadith: { label: 'Ù‚Ø±Ø¢Ù† ÙˆØ­Ø¯ÙŠØ«', icon: 'ğŸ“–' },
            fiqh: { label: 'Ø£Ø­ÙƒØ§Ù… ÙÙ‚Ù‡ÙŠØ©', icon: 'âš–ï¸' },
            questions: { label: 'Ø£Ø³Ø¦Ù„Ø©', icon: 'â“' },
            benefits: { label: 'ÙÙˆØ§Ø¦Ø¯', icon: 'ğŸ’¡' },
            stories: { label: 'Ù‚ØµØµ', icon: 'ğŸ“š' },
            analysis: { label: 'ØªØ­Ù„ÙŠÙ„', icon: 'ğŸ”' }
        };

        // Guardrails - limits to prevent chaos
        const GUARDRAILS = {
            maxDepth: 5,
            maxKeys: 50,
            maxArrayLength: 100,
            maxStringLength: 50000
        };

        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
            document.getElementById('importContent').value = '';
            document.getElementById('importRawSource').value = '';
            document.getElementById('importResult').innerHTML = '';
            document.getElementById('previewSections').style.display = 'none';
            document.getElementById('applyBtn').disabled = true;
            importedData = null;
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }

        function setImportType(type) {
            importType = type;
            document.querySelectorAll('.import-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            const label = document.getElementById('importLabel');
            const textarea = document.getElementById('importContent');

            if (type === 'json') {
                label.textContent = 'Ø§Ù„ØµÙ‚ ÙƒÙˆØ¯ JSON Ù‡Ù†Ø§:';
                textarea.placeholder = '{ "title": "...", "overview": {...} }';
            } else {
                label.textContent = 'Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§ (Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø¨Ù€ ## Ø£Ùˆ Ø¥ÙŠÙ…ÙˆØ¬ÙŠ):';
                textarea.placeholder = '## Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©\nØ§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©...\n\n## Ø§Ù„Ø¢ÙŠØ§Øª\n- Ø¢ÙŠØ© 1\n- Ø¢ÙŠØ© 2';
            }
        }

        // ============ Normalization Layer ============
        function normalizeContent(rawData, source) {
            const normalized = {
                title: rawData.title || '',
                subtitle: rawData.subtitle || '',
                source: source,
                sections: [],
                metadata: {
                    importedAt: new Date().toISOString(),
                    importMethod: source
                }
            };

            // Check guardrails
            const keyCount = Object.keys(rawData).length;
            if (keyCount > GUARDRAILS.maxKeys) {
                throw new Error(`Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (${keyCount}). Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: ${GUARDRAILS.maxKeys}`);
            }

            for (const [key, value] of Object.entries(rawData)) {
                // Skip metadata fields
                if (['title', 'subtitle', 'tags', 'rawContent', 'status'].includes(key)) continue;
                if (value === null || value === undefined) continue;
                if (Array.isArray(value) && value.length === 0) continue;
                if (typeof value === 'object' && Object.keys(value).length === 0) continue;

                const isKnown = KNOWN_SECTIONS.hasOwnProperty(key);
                const sectionMeta = KNOWN_SECTIONS[key] || { label: key, icon: 'âœ¨' };

                normalized.sections.push({
                    key: key,
                    label: sectionMeta.label,
                    icon: sectionMeta.icon,
                    type: Array.isArray(value) ? 'array' : 'object',
                    isCustom: !isKnown,
                    content: value
                });
            }

            return normalized;
        }

        // ============ Text Parser (Smart) ============
        function parseTextContent(text) {
            const result = {};
            let currentSection = 'Ø¹Ø§Ù…';
            let currentContent = [];

            // Header patterns
            const headerPatterns = [
                /^##\s*(.+)$/,              // ## Ø¹Ù†ÙˆØ§Ù†
                /^#\s*(.+)$/,               // # Ø¹Ù†ÙˆØ§Ù†
                /^[\u{1F4CC}\u{2728}\u{2705}]\s*(.+)$/u,  // ğŸ“Œ or âœ¨ or âœ…
                /^\d+[\.\)]\s*\*\*(.+)\*\*$/,  // 1. **Ø¹Ù†ÙˆØ§Ù†**
            ];

            // Keyword mapping
            const keywordMap = {
                'Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©': 'overview', 'Ù…Ù„Ø®Øµ': 'overview', 'Ø§Ù„Ø®Ù„Ø§ØµØ©': 'overview',
                'Ø¨ÙˆØ¯ÙƒØ§Ø³Øª': 'podcast', 'ÙÙ‚Ø±Ø§Øª': 'podcast',
                'Ø´Ø®ØµÙŠØ§Øª': 'characters', 'Ø§Ù„Ø´Ø®ØµÙŠØ§Øª': 'characters',
                'Ø¢ÙŠØ§Øª': 'quranHadith', 'Ø£Ø­Ø§Ø¯ÙŠØ«': 'quranHadith', 'Ù‚Ø±Ø¢Ù†': 'quranHadith',
                'Ø£Ø­ÙƒØ§Ù…': 'fiqh', 'ÙÙ‚Ù‡': 'fiqh',
                'Ø£Ø³Ø¦Ù„Ø©': 'questions',
                'ÙÙˆØ§Ø¦Ø¯': 'benefits', 'Ø¹Ø¨Ø±': 'benefits',
                'Ù‚ØµØµ': 'stories', 'Ù‚ØµØ©': 'stories'
            };

            const lines = text.split('\n');

            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;

                let isHeader = false;
                for (const pattern of headerPatterns) {
                    const match = trimmed.match(pattern);
                    if (match) {
                        // Save previous section
                        if (currentContent.length > 0) {
                            const key = keywordMap[currentSection] || currentSection;
                            result[key] = currentContent;
                        }
                        currentSection = match[1].trim();
                        currentContent = [];
                        isHeader = true;
                        break;
                    }
                }

                if (!isHeader) {
                    // Clean bullet points
                    const cleanLine = trimmed.replace(/^[-*â€¢]\s*/, '');
                    if (cleanLine) currentContent.push(cleanLine);
                }
            }

            // Save last section
            if (currentContent.length > 0) {
                const key = keywordMap[currentSection] || currentSection;
                result[key] = currentContent;
            }

            return result;
        }

        // ============ Parse and Preview ============
        function parseAndPreview() {
            const content = document.getElementById('importContent').value.trim();
            const resultDiv = document.getElementById('importResult');
            const previewDiv = document.getElementById('previewSections');
            const applyBtn = document.getElementById('applyBtn');

            if (!content) {
                resultDiv.innerHTML = '<div class="error-box">âŒ Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±Øº! Ø§Ù„ØµÙ‚ Ù…Ø­ØªÙˆÙ‰ Ø£ÙˆÙ„Ø§Ù‹.</div>';
                return;
            }

            try {
                let parsed;

                if (importType === 'json') {
                    // Try to parse JSON with Try/Catch
                    try {
                        // Try to extract JSON from text (might have markdown code blocks)
                        const jsonMatch = content.match(/\{[\s\S]*\}/);
                        parsed = JSON.parse(jsonMatch ? jsonMatch[0] : content);
                    } catch (jsonError) {
                        throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù€ JSON: ${jsonError.message}<br><br>ğŸ’¡ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø£Ù‚ÙˆØ§Ø³ ÙˆØ§Ù„ÙÙˆØ§ØµÙ„`);
                    }
                } else {
                    // Parse text
                    parsed = parseTextContent(content);
                }

                // Normalize the data
                importedData = normalizeContent(parsed, importType === 'json' ? 'external-json' : 'text-paste');

                // Show success
                const knownCount = importedData.sections.filter(s => !s.isCustom).length;
                const customCount = importedData.sections.filter(s => s.isCustom).length;

                resultDiv.innerHTML = `
                    <div class="success-box">
                        âœ… ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!<br>
                        ğŸ“‹ Ø£Ù‚Ø³Ø§Ù… Ù…Ø¹Ø±ÙˆÙØ©: ${knownCount}<br>
                        âœ¨ Ø£Ù‚Ø³Ø§Ù… Ø¬Ø¯ÙŠØ¯Ø©: ${customCount}
                    </div>
                `;

                // Show section badges
                let badgesHtml = '<h4 style="color:var(--gold);margin-bottom:10px;">Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ÙƒØªØ´ÙØ©:</h4>';
                importedData.sections.forEach(section => {
                    const badgeClass = section.isCustom ? 'custom' : 'known';
                    badgesHtml += `<span class="section-badge ${badgeClass}">${section.icon} ${section.label}</span>`;
                });

                previewDiv.innerHTML = badgesHtml;
                previewDiv.style.display = 'block';
                applyBtn.disabled = false;

            } catch (error) {
                resultDiv.innerHTML = `<div class="error-box">âŒ ${error.message}</div>`;
                previewDiv.style.display = 'none';
                applyBtn.disabled = true;
                importedData = null;
            }
        }

        // ============ Apply Import ============
        function applyImport() {
            if (!importedData) {
                alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯!');
                return;
            }

            // Convert normalized format back to flat format for saving
            const flatData = {};

            // Copy title if exists
            if (importedData.title) {
                document.getElementById('lessonTitle').value = importedData.title;
            }
            if (importedData.subtitle) {
                document.getElementById('lessonSubtitle').value = importedData.subtitle;
            }

            // Convert sections back to flat structure
            importedData.sections.forEach(section => {
                flatData[section.key] = section.content;
            });

            // Set as current analysis
            currentAnalysis = flatData;

            // Update UI
            const statusDiv = document.getElementById('aiStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.background = 'rgba(155, 89, 182, 0.2)';
            statusDiv.style.border = '1px solid #9b59b6';
            statusDiv.innerHTML = `
                <h4 style="color:#9b59b6;">ğŸ“‹ ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰!</h4>
                <p>Ø§Ù„Ù…ØµØ¯Ø±: ${importedData.source === 'external-json' ? 'JSON Ø®Ø§Ø±Ø¬ÙŠ' : 'Ù†Øµ Ø¹Ø§Ø¯ÙŠ'}</p>
                <p>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: ${importedData.sections.length}</p>
                <p style="color:#2ecc71;">âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø­ÙØ¸ Ø£Ùˆ Ø§Ù„Ù†Ø´Ø±</p>
            `;

            closeImportModal();
            alert('âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!\n\nÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø³ Ø£Ùˆ Ù†Ø´Ø±Ù‡.');

            // ğŸ”’ Ù†Ù‚Ù„ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ Ù…Ù† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù„Ù„ÙÙˆØ±Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            const modalRawSource = document.getElementById('importRawSource').value.trim();
            if (modalRawSource) {
                document.getElementById('lessonRawSource').value = modalRawSource;
            }
        }

        // ============ History Functions ============
        let currentHistoryLessonId = null;

        async function showHistory(lessonId, lessonTitle) {
            currentHistoryLessonId = lessonId;
            document.getElementById('historyLessonTitle').textContent = lessonTitle;
            document.getElementById('historyModal').classList.add('active');
            document.getElementById('historyList').innerHTML = '<p style="color:#999;">ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>';

            try {
                const response = await fetch(API_URL + '/' + lessonId + '/history');
                const versions = await response.json();

                if (versions.length === 0) {
                    document.getElementById('historyList').innerHTML = '<p style="color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø® Ø³Ø§Ø¨Ù‚Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³.</p>';
                    return;
                }

                const sourceLabels = {
                    'initial': 'ğŸ†• Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø£ÙˆÙ„',
                    'manual': 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¯ÙˆÙŠ',
                    'internal-ai': 'ğŸ¤– ØªØ­Ù„ÙŠÙ„ AI Ø¯Ø§Ø®Ù„ÙŠ',
                    'external-json': 'ğŸ“¦ Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON',
                    'text-paste': 'ğŸ“ Ù„ØµÙ‚ Ù†Øµ'
                };

                document.getElementById('historyList').innerHTML = versions.map(v => `
                    <div style="background: var(--dark); padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(212, 175, 55, 0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: var(--gold);">Ø§Ù„Ø¥ØµØ¯Ø§Ø± ${v.version}</strong>
                                <span style="color: #999; margin-right: 10px;">${sourceLabels[v.source] || v.source}</span>
                            </div>
                            <button class="btn btn-info" onclick="revertToVersion(${v.version})" style="padding: 8px 15px; font-size: 0.85rem;">
                                ğŸ”„ Ø§Ø³ØªØ±Ø¬Ø§Ø¹
                            </button>
                        </div>
                        <p style="color: #888; font-size: 0.85rem; margin-top: 8px;">
                            ğŸ“… ${new Date(v.archivedAt).toLocaleString('ar-EG')}
                            ${v.changeNote ? ' | ğŸ“ ' + v.changeNote : ''}
                        </p>
                    </div>
                `).join('');

            } catch (error) {
                document.getElementById('historyList').innerHTML = '<p style="color:#e74c3c;">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„: ' + error.message + '</p>';
            }
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').classList.remove('active');
            currentHistoryLessonId = null;
        }

        async function revertToVersion(version) {
            if (!currentHistoryLessonId) return;

            if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù‡Ø°Ù‡ Ø§Ù„Ù†Ø³Ø®Ø©ØŸ\n\nØ³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹.')) {
                return;
            }

            try {
                const response = await fetch(API_URL + '/' + currentHistoryLessonId + '/revert/' + version, {
                    method: 'POST'
                });
                const result = await response.json();

                if (response.ok) {
                    alert('âœ… ' + result.message);
                    closeHistoryModal();
                    loadLessons();
                } else {
                    alert('âŒ Ø®Ø·Ø£: ' + result.error);
                }
            } catch (error) {
                alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹: ' + error.message);
            }
        }
    </script>
</body>

</html>