<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø²ÙŠØ²Ùˆ ÙˆØ¨Ù„Ø§Ù„ - Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø¯Ø¹ÙˆÙŠØ©</title>
    <meta name="description" content="Ù…Ù†ØµØ© Ø¯Ø¹ÙˆÙŠØ© ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù„Ù†Ø´Ø± Ø§Ù„Ø¹Ù„Ù… Ø§Ù„Ø´Ø±Ø¹ÙŠ">
    <link rel="stylesheet" href="style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@400;500;700&display=swap"
        rel="stylesheet">
    <!-- DOMPurify for XSS Protection -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
</head>

<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loader"></div>
        <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>

    <!-- Header -->
    <header class="main-header">
        <div class="container">
            <div class="header-icon">ğŸ•Œ</div>
            <h1 id="lessonTitle">Ù…Ù†ØµØ© Ø²ÙŠØ²Ùˆ ÙˆØ¨Ù„Ø§Ù„</h1>
            <p class="subtitle" id="lessonSubtitle">Ù…Ù†ØµØ© Ø¯Ø¹ÙˆÙŠØ© ØªØ¹Ù„ÙŠÙ…ÙŠØ©</p>
            <div class="tags" id="lessonTags"></div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="main-nav" id="mainNav">
        <div class="nav-container" id="navContainer">
            <a href="#lessons" class="nav-link active"><span class="nav-icon">ğŸ“š</span><span
                    class="nav-text">Ø§Ù„Ø¯Ø±ÙˆØ³</span></a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Lessons Selector -->
        <section id="lessons" class="section">
            <h2 class="section-title"><span>ğŸ“š</span> Ø§Ø®ØªØ± Ø§Ù„Ø¯Ø±Ø³</h2>
            <div id="lessonsGrid" class="characters-grid">
                <div class="card featured" style="text-align: center; padding: 40px;">
                    <div class="loader" style="margin: 0 auto;"></div>
                    <p style="margin-top: 20px; color: var(--gold);">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³...</p>
                </div>
            </div>
        </section>

        <!-- Dynamic Content Container -->
        <div id="lessonContent"></div>
    </main>

    <!-- Footer -->
    <footer class="main-footer">
        <p>Â© 2024 Ø²ÙŠØ²Ùˆ ÙˆØ¨Ù„Ø§Ù„ - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p>
        <p class="footer-dua">Ø§Ù„Ù„Ù‡Ù… Ø¹Ù„Ù…Ù†Ø§ Ù…Ø§ ÙŠÙ†ÙØ¹Ù†Ø§ ÙˆØ§Ù†ÙØ¹Ù†Ø§ Ø¨Ù…Ø§ Ø¹Ù„Ù…ØªÙ†Ø§</p>
    </footer>

    <!-- Floating Buttons -->
    <button class="scroll-top" id="scrollTop">â¬†ï¸</button>
    <button class="search-btn" id="searchBtn">ğŸ”</button>

    <!-- Search Modal -->
    <div class="search-modal" id="searchModal">
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰...">
            <button onclick="closeSearch()">âœ•</button>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ============ Configuration ============
        const API_URL = window.location.origin + '/api/lessons';

        let currentLesson = null;
        let allLessons = [];

        // ============ Initialize ============
        document.addEventListener('DOMContentLoaded', async function () {
            await loadLessons();

            // Hide loading screen
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
            }, 800);

            initScrollTop();
            initSearch();
        });

        // ============ Load Lessons from API ============
        async function loadLessons() {
            try {
                // Get ALL lessons (not just published)
                const response = await fetch(API_URL);
                const lessons = await response.json();
                allLessons = lessons;

                if (lessons.length === 0) {
                    showEmptyState();
                } else {
                    renderLessonsGrid(lessons);
                    // Auto-select first lesson (most recent)
                    selectLessonByIndex(0);
                }
            } catch (error) {
                console.error('Error loading lessons:', error);
                showErrorState();
            }
        }

        function showEmptyState() {
            document.getElementById('lessonsGrid').innerHTML = `
                <div class="card featured" style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                    <h3>ğŸ•Œ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±ÙˆØ³ Ù…Ù†Ø´ÙˆØ±Ø© Ø¨Ø¹Ø¯</h3>
                    <p style="color: var(--gray);">Ø£Ø¶Ù Ø¯Ø±ÙˆØ³ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† ÙˆØ§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
                    <a href="/admin" style="color: var(--gold); text-decoration: underline; margin-top: 15px; display: inline-block;">ğŸ”§ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</a>
                </div>
            `;
        }

        function showErrorState() {
            document.getElementById('lessonsGrid').innerHTML = `
                <div class="card warning" style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                    <h3>âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</h3>
                    <p style="color: var(--gray);">ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ MongoDB ÙˆØ§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</p>
                    <button onclick="location.reload()" style="background: var(--gold); color: var(--black); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-top: 15px;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                </div>
            `;
        }

        function renderLessonsGrid(lessons) {
            const grid = document.getElementById('lessonsGrid');
            grid.innerHTML = lessons.map((lesson, index) => `
                <div class="character-card ${['gold', 'blue', 'purple', 'yellow'][index % 4]}" 
                     onclick="selectLessonByIndex(${index})"
                     style="cursor: pointer;" id="lesson-card-${index}">
                    <div class="char-header">
                        <span class="char-icon">ğŸ“–</span>
                        <div>
                            <h4>${lesson.title}</h4>
                            <span class="char-type">${lesson.subtitle || 'Ø¯Ø±Ø³ Ø¥Ø³Ù„Ø§Ù…ÙŠ'}</span>
                        </div>
                    </div>
                    ${lesson.aiAnalyzed ? '<div class="char-lessons"><span>âœ… ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</span></div>' : ''}
                </div>
            `).join('');
        }

        // ============ Select Lesson by Index ============
        function selectLessonByIndex(index) {
            if (index < 0 || index >= allLessons.length) return;

            const lesson = allLessons[index];
            selectLesson(lesson);

            // Highlight selected card
            document.querySelectorAll('.character-card').forEach((card, i) => {
                card.classList.remove('selected');
                if (i === index) card.classList.add('selected');
            });
        }

        // ============ Select and Render Lesson ============
        function selectLesson(lesson) {
            currentLesson = lesson;

            // Update header
            document.getElementById('lessonTitle').textContent = lesson.title;
            document.getElementById('lessonSubtitle').textContent = lesson.subtitle || 'Ø¯Ø±Ø³ Ø¥Ø³Ù„Ø§Ù…ÙŠ';

            // Update tags
            if (lesson.tags && lesson.tags.length > 0) {
                document.getElementById('lessonTags').innerHTML = lesson.tags.map(tag =>
                    `<span class="tag">${tag}</span>`
                ).join('');
            }

            // Build navigation
            buildNavigation(lesson);

            // Render content
            renderLessonContent(lesson);

            // Scroll to content
            document.getElementById('lessonContent').scrollIntoView({ behavior: 'smooth' });
        }

        function buildNavigation(lesson) {
            const nav = document.getElementById('navContainer');
            const sections = [];

            // Known sections to skip when detecting dynamic ones
            const knownKeys = ['title', 'subtitle', 'tags', 'rawContent', 'status', 'aiAnalyzed',
                'overview', 'podcast', 'characters', 'quranHadith', 'fiqh',
                'questions', 'benefits', 'stories', 'analysis', '_id', 'createdAt', 'updatedAt', '__v'];

            // Check available known sections
            sections.push({ id: 'lessons', icon: 'ğŸ“š', name: 'Ø§Ù„Ø¯Ø±ÙˆØ³' });

            if (lesson.overview?.message || lesson.overview?.points?.length) {
                sections.push({ id: 'overview', icon: 'ğŸ“‹', name: 'Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©' });
            }
            if (lesson.podcast?.length) {
                sections.push({ id: 'podcast', icon: 'ğŸ™ï¸', name: 'Ø§Ù„Ø¨ÙˆØ¯ÙƒØ§Ø³Øª' });
            }
            if (lesson.characters?.length) {
                sections.push({ id: 'characters', icon: 'ğŸ‘¥', name: 'Ø§Ù„Ø´Ø®ØµÙŠØ§Øª' });
            }
            if (lesson.quranHadith?.ayat?.length || lesson.quranHadith?.hadith?.length || lesson.quranHadith?.duaa?.length) {
                sections.push({ id: 'quran', icon: 'ğŸ“–', name: 'Ø§Ù„Ø¢ÙŠØ§Øª ÙˆØ§Ù„Ø£Ø­Ø§Ø¯ÙŠØ«' });
            }
            if (lesson.fiqh?.rewards?.length || lesson.fiqh?.sunan?.length || lesson.fiqh?.warnings?.length || lesson.fiqh?.qa?.length) {
                sections.push({ id: 'fiqh', icon: 'ğŸ•Œ', name: 'Ø§Ù„Ø£Ø­ÙƒØ§Ù…' });
            }
            if (lesson.questions?.trueFalse?.length) {
                sections.push({ id: 'questions', icon: 'â“', name: 'Ø§Ù„Ø£Ø³Ø¦Ù„Ø©' });
            }
            if (lesson.benefits?.length) {
                sections.push({ id: 'benefits', icon: 'ğŸ’', name: 'Ø§Ù„ÙÙˆØ§Ø¦Ø¯' });
            }
            if (lesson.stories?.length) {
                sections.push({ id: 'stories', icon: 'ğŸ“š', name: 'Ø§Ù„Ù‚ØµØµ' });
            }
            if (lesson.analysis?.map?.length || lesson.analysis?.actionPlan || lesson.analysis?.conclusion) {
                sections.push({ id: 'analysis', icon: 'ğŸ”', name: 'Ø§Ù„ØªØ­Ù„ÙŠÙ„' });
            }

            // Add dynamic/custom sections to navigation
            for (const [key, value] of Object.entries(lesson)) {
                if (knownKeys.includes(key)) continue;
                if (value === null || value === undefined) continue;
                if (Array.isArray(value) && value.length === 0) continue;
                if (typeof value === 'object' && Object.keys(value).length === 0) continue;

                // Generate readable label
                const label = key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1');
                sections.push({ id: key, icon: 'âœ¨', name: label });
            }

            nav.innerHTML = sections.map((s, i) => `
                <a href="#${s.id}" class="nav-link ${i === 0 ? 'active' : ''}">
                    <span class="nav-icon">${s.icon}</span>
                    <span class="nav-text">${s.name}</span>
                </a>
            `).join('');

            initNavigation();
        }

        function renderLessonContent(lesson) {
            const container = document.getElementById('lessonContent');
            let html = '';

            // Overview Section
            if (lesson.overview?.message || lesson.overview?.points?.length) {
                html += renderOverview(lesson.overview);
            }

            // Podcast Section
            if (lesson.podcast?.length) {
                html += renderPodcast(lesson.podcast);
            }

            // Characters Section
            if (lesson.characters?.length) {
                html += renderCharacters(lesson.characters);
            }

            // Quran & Hadith Section
            if (lesson.quranHadith?.ayat?.length || lesson.quranHadith?.hadith?.length) {
                html += renderQuranHadith(lesson.quranHadith);
            }

            // Fiqh Section
            if (lesson.fiqh?.rewards?.length || lesson.fiqh?.sunan?.length || lesson.fiqh?.warnings?.length) {
                html += renderFiqh(lesson.fiqh);
            }

            // Questions Section
            if (lesson.questions?.trueFalse?.length) {
                html += renderQuestions(lesson.questions);
            }

            // Benefits Section
            if (lesson.benefits?.length) {
                html += renderBenefits(lesson.benefits);
            }

            // Stories Section
            if (lesson.stories?.length) {
                html += renderStories(lesson.stories);
            }

            // Analysis Section
            if (lesson.analysis?.map?.length || lesson.analysis?.actionPlan || lesson.analysis?.conclusion) {
                html += renderAnalysis(lesson.analysis);
            }

            // ============ DYNAMIC SECTIONS (Custom/Unknown) ============
            // Render any additional sections not handled above
            const knownKeys = ['title', 'subtitle', 'tags', 'rawContent', 'status', 'aiAnalyzed',
                'overview', 'podcast', 'characters', 'quranHadith', 'fiqh',
                'questions', 'benefits', 'stories', 'analysis', '_id', 'createdAt', 'updatedAt', '__v'];

            for (const [key, value] of Object.entries(lesson)) {
                if (knownKeys.includes(key)) continue;
                if (value === null || value === undefined) continue;
                if (Array.isArray(value) && value.length === 0) continue;
                if (typeof value === 'object' && Object.keys(value).length === 0) continue;

                html += renderDynamicSection(key, value);
            }

            container.innerHTML = html;
        }

        // ============ Dynamic Section Renderer (for custom sections) ============
        // Sanitize helper for XSS protection
        function sanitize(text) {
            if (typeof DOMPurify !== 'undefined') {
                return DOMPurify.sanitize(String(text));
            }
            // Fallback: basic HTML entity encoding
            return String(text).replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[m]));
        }

        function renderDynamicSection(key, data) {
            // Generate a readable label from the key
            const label = sanitize(key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1'));
            const icon = 'âœ¨'; // Default icon for custom sections

            let contentHtml = '';

            if (Array.isArray(data)) {
                // Render array as cards or list
                contentHtml = data.map((item, i) => {
                    if (typeof item === 'object' && item !== null) {
                        // Render object items as cards
                        const title = item.title || item.name || item.text || '';
                        const content = item.content || item.description || item.meaning || '';
                        const subItems = [];

                        for (const [k, v] of Object.entries(item)) {
                            if (['title', 'name', 'text', 'content', 'description', 'meaning'].includes(k)) continue;
                            if (typeof v === 'string' || typeof v === 'number') {
                                subItems.push('<span class="badge">' + k + ': ' + v + '</span>');
                            }
                        }

                        return '<div class="card">' +
                            (title ? '<h4>' + title + '</h4>' : '') +
                            (content ? '<p>' + content + '</p>' : '') +
                            (subItems.length ? '<div class="badges">' + subItems.join(' ') + '</div>' : '') +
                            '</div>';
                    } else {
                        // Simple string/number items as list
                        return '<li>' + item + '</li>';
                    }
                }).join('');

                // Wrap simple items in a list
                if (typeof data[0] !== 'object') {
                    contentHtml = '<ul class="styled-list">' + contentHtml + '</ul>';
                } else {
                    contentHtml = '<div class="cards-grid">' + contentHtml + '</div>';
                }
            } else if (typeof data === 'object') {
                // Render object as key-value pairs
                const items = [];
                for (const [k, v] of Object.entries(data)) {
                    if (Array.isArray(v)) {
                        items.push('<div class="sub-section"><h4>' + k + '</h4><ul class="styled-list">' +
                            v.map(item => '<li>' + (typeof item === 'object' ? (item.text || JSON.stringify(item)) : item) + '</li>').join('') +
                            '</ul></div>');
                    } else if (typeof v === 'object' && v !== null) {
                        items.push('<div class="card"><h4>' + k + '</h4><p>' + (v.text || v.content || JSON.stringify(v)) + '</p></div>');
                    } else {
                        items.push('<p><strong>' + k + ':</strong> ' + v + '</p>');
                    }
                }
                contentHtml = items.join('');
            } else {
                // Simple value
                contentHtml = '<p>' + data + '</p>';
            }

            return '<section id="' + key + '" class="section dynamic-section">' +
                '<h2 class="section-title"><span>' + icon + '</span> ' + label + '</h2>' +
                '<div class="card featured">' + contentHtml + '</div>' +
                '</section>';
        }


        // ============ Render Sections ============
        function renderOverview(overview) {
            return `
                <section id="overview" class="section">
                    <h2 class="section-title"><span>ğŸ“‹</span> Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h2>
                    
                    ${overview.message ? `
                    <div class="card featured">
                        <h3>ğŸ¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</h3>
                        <p class="highlight-text">"${overview.message}"</p>
                    </div>
                    ` : ''
                }

                    ${(overview.lessonMap || overview.mapItems)?.length ? `
                    <div class="card">
                        <h3>ğŸ—ºï¸ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¯Ø±Ø³</h3>
                        <div class="grid-2">
                            ${(overview.lessonMap || overview.mapItems).map(item => `
                                <div class="mini-card">
                                    <div class="mini-icon">${item.icon || 'ğŸ“Œ'}</div>
                                    <h4>${item.title}</h4>
                                    <p>${item.description}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''
                }

                    ${overview.points?.length ? `
                    <div class="card">
                        <h3>ğŸ“Œ Ù…Ù„Ø®Øµ ${overview.points.length} Ù†Ù‚Ø§Ø· Ø±Ø¦ÙŠØ³ÙŠØ©</h3>
                        <div class="points-list">
                            ${overview.points.map((point, i) => {
                    const pointText = typeof point === 'object' ? (point.text || point.title || '') : point;
                    const pointIcon = typeof point === 'object' ? (point.icon || 'ğŸŒŸ') : 'ğŸŒŸ';
                    const pointNum = typeof point === 'object' ? (point.num || i + 1) : i + 1;
                    return `
                                <div class="point">
                                    <span class="point-num">${pointNum}</span>
                                    <span class="point-icon">${pointIcon}</span>
                                    <span>${pointText}</span>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                    ` : ''
                }
                </section>
            `;
        }

        function renderPodcast(podcast) {
            return `
                <section id="podcast" class="section">
                    <h2 class="section-title"><span>ğŸ™ï¸</span> Ø§Ù„Ø¨ÙˆØ¯ÙƒØ§Ø³Øª</h2>
                    <div class="timeline">
                        ${podcast.map((item, i) => `
                            <div class="timeline-item ${item.type === 'red' ? 'red' : ''}">
                                <div class="timeline-badge">${i + 1}</div>
                                <div class="timeline-content">
                                    <h4>${item.title}</h4>
                                    <p>${item.content}</p>
                                    ${item.quote ? `<div class="quote">"${item.quote}"</div>` : ''}
                                    ${item.highlight ? `<div class="highlight-box">${item.highlight}</div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </section>
            `;
        }

        function renderCharacters(characters) {
            const colors = ['gold', 'blue', 'yellow', 'purple'];
            const icons = ['â­', 'ğŸŒŸ', 'ğŸ’›', 'ğŸƒ', 'ğŸ‘¤'];

            return `
                <section id="characters" class="section">
                    <h2 class="section-title"><span>ğŸ‘¥</span> Ø§Ù„Ø´Ø®ØµÙŠØ§Øª</h2>
                    <div class="characters-grid">
                        ${characters.map((char, i) => `
                            <div class="character-card ${char.color || colors[i % colors.length]}">
                                <div class="char-header">
                                    <span class="char-icon">${char.icon || icons[i % icons.length]}</span>
                                    <div>
                                        <h4>${char.name}</h4>
                                        <span class="char-type">${char.type || char.role || ''}</span>
                                    </div>
                                </div>
                                ${char.events?.length ? `
                                <ul class="char-events">
                                    ${char.events.map(e => `<li>${e}</li>`).join('')}
                                </ul>
                                ` : ''}
                                ${char.lessons?.length ? `
                                <div class="char-lessons">
                                    ${char.lessons.map(l => `<span>${l}</span>`).join('')}
                                </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </section>
            `;
        }

        function renderQuranHadith(qh) {
            return `
                <section id="quran" class="section">
                    <h2 class="section-title"><span>ğŸ“–</span> Ø§Ù„Ø¢ÙŠØ§Øª ÙˆØ§Ù„Ø£Ø­Ø§Ø¯ÙŠØ«</h2>
                    
                    ${qh.ayat?.length ? `
                    <div class="card">
                        <h3>ğŸ“— Ø§Ù„Ø¢ÙŠØ§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ©</h3>
                        <div class="ayat-list">
                            ${qh.ayat.map(ayah => `
                                <div class="ayah-card" onclick="copyText(this)">
                                    <p class="ayah-text">${ayah.text}</p>
                                    <div class="ayah-info">
                                        <span class="surah">${ayah.surah}</span>
                                        <span class="meaning">${ayah.meaning || ''}</span>
                                    </div>
                                    <span class="copy-hint">ğŸ“‹ Ø§Ø¶ØºØ· Ù„Ù„Ù†Ø³Ø®</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''
                }

                    ${qh.hadith?.length ? `
                    <div class="card">
                        <h3>ğŸ“• Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ« Ø§Ù„Ù†Ø¨ÙˆÙŠØ©</h3>
                        <div class="hadith-list">
                            ${qh.hadith.map(h => `
                                <div class="hadith-card" onclick="copyText(this)">
                                    <p class="hadith-text">"${h.text}"</p>
                                    <p class="hadith-purpose">ğŸ¯ ${h.purpose || ''}</p>
                                    <span class="copy-hint">ğŸ“‹ Ø§Ø¶ØºØ· Ù„Ù„Ù†Ø³Ø®</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''
                }

                    ${qh.duaa?.length ? `
                    <div class="card">
                        <h3>ğŸ¤² Ø§Ù„Ø£Ø¯Ø¹ÙŠØ©</h3>
                        <div class="dua-list">
                            ${qh.duaa.map(d => `
                                <div class="dua-card" onclick="copyText(this)">
                                    <p class="dua-text">${d.text}</p>
                                    <span class="dua-type">${d.type || ''}</span>
                                    <span class="copy-hint">ğŸ“‹ Ø§Ø¶ØºØ· Ù„Ù„Ù†Ø³Ø®</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''
                }
                </section>
            `;
        }

        function renderFiqh(fiqh) {
            return `
                <section id="fiqh" class="section">
                    <h2 class="section-title"><span>ğŸ•Œ</span> ${fiqh.title || 'Ø§Ù„Ø£Ø­ÙƒØ§Ù… Ø§Ù„ÙÙ‚Ù‡ÙŠØ©'}</h2>
                    
                    ${fiqh.rewards?.length ? `
                    <div class="card">
                        <h3>ğŸ Ø«ÙˆØ§Ø¨ Ø§Ù„ØªØ¨ÙƒÙŠØ±</h3>
                        <div class="rewards-grid">
                            ${fiqh.rewards.map(r => `
                                <div class="reward-item ${r.color || 'gold'}">
                                    <span class="reward-time">${r.time}</span>
                                    <span class="reward-value">${r.icon || ''} ${r.reward || r.value}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''
                }

                    ${fiqh.sunan?.length ? `
                    <div class="card">
                        <h3>âœ… Ø§Ù„Ø³Ù†Ù†</h3>
                        <div class="sunan-grid">
                            ${fiqh.sunan.map(s => `
                                <div class="sunan-item">
                                    <span>${s.icon || 'âœ¨'}</span>
                                    ${s.text || s}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''
                }

                    ${fiqh.warnings?.length ? `
                    <div class="card warning">
                        <h3>ğŸš« Ø§Ù„Ù…Ø­Ø°ÙˆØ±Ø§Øª</h3>
                        <ul class="warning-list">
                            ${fiqh.warnings.map(w => `<li>${w}</li>`).join('')}
                        </ul>
                        ${fiqh.warningHadith ? `<div class="hadith-box">"${fiqh.warningHadith}"</div>` : ''}
                    </div>
                    ` : ''
                }

                    ${fiqh.qa?.length ? `
                    <div class="card">
                        <h3>â“ Ù…Ø³Ø§Ø¦Ù„ ÙÙ‚Ù‡ÙŠØ©</h3>
                        <div class="fiqh-qa">
                            ${fiqh.qa.map(q => {
                    const question = q.question || q.q;
                    const answer = q.answer || q.a;
                    const isCorrect = q.isCorrect === true || q.correct === true;
                    return `
                                <div class="fiqh-item">
                                    <div class="fiqh-q">${question}</div>
                                    <div class="fiqh-a">${isCorrect ? 'âœ…' : 'âŒ'} ${answer}</div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                    ` : ''
                }
                </section>
            `;
        }

        function renderQuestions(questions) {
            return `
                <section id="questions" class="section">
                    <h2 class="section-title"><span>â“</span> Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h2>
                    
                    ${questions.trueFalse?.length ? `
                    <div class="card">
                        <h3>âœ… ØµØ­ Ø£Ù… Ø®Ø·Ø£</h3>
                        <div class="quiz-list">
                            ${questions.trueFalse.map(q => {
                // Handle both boolean and string answers
                const isCorrect = q.isCorrect === true || q.answer === true || q.answer === 'ØµØ­' || q.answer === 'ØµØ­ÙŠØ­';
                const answerText = typeof q.answer === 'boolean'
                    ? (q.answer ? 'ØµØ­ÙŠØ­ âœ“' : 'Ø®Ø·Ø£ âœ—')
                    : (q.answer || (isCorrect ? 'ØµØ­ÙŠØ­' : 'Ø®Ø·Ø£'));
                const explanation = q.explanation || '';
                return `
                                <div class="quiz-item">
                                    <span class="quiz-q">${q.question}</span>
                                    <span class="quiz-a ${isCorrect ? 'correct' : 'wrong'}">
                                        ${isCorrect ? 'âœ…' : 'âŒ'} ${answerText}
                                    </span>
                                    ${explanation ? `<p class="quiz-explanation" style="color:#888;font-size:0.9em;margin-top:5px;">ğŸ’¡ ${explanation}</p>` : ''}
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                    ` : ''
                }
                </section>
            `;
        }

        function renderBenefits(benefits) {
            const colors = ['green', 'blue', 'purple', 'red', 'yellow'];

            return `
                <section id="benefits" class="section">
                    <h2 class="section-title"><span>ğŸ’</span> Ø§Ù„ÙÙˆØ§Ø¦Ø¯</h2>
                    <div class="benefits-table">
                        <div class="benefits-header">
                            <span>#</span>
                            <span>Ø§Ù„ÙØ§Ø¦Ø¯Ø©</span>
                            <span>Ø§Ù„ØªØµÙ†ÙŠÙ</span>
                        </div>
                        ${benefits.map((b, i) => `
                            <div class="benefit-row">
                                <span>${i + 1}</span>
                                <span>${b.text || b}</span>
                                <span class="benefit-tag ${b.color || colors[i % colors.length]}">${b.category || 'Ø¹Ø§Ù…Ø©'}</span>
                            </div>
                        `).join('')}
                    </div>
                </section>
            `;
        }

        function renderStories(stories) {
            return `
                <section id="stories" class="section">
                    <h2 class="section-title"><span>ğŸ“š</span> Ø§Ù„Ù‚ØµØµ</h2>
                    ${stories.map(story => `
                        <div class="story-card">
                            <h3>ğŸ“– ${story.title}</h3>
                            <div class="story-stages">
                                ${story.stages?.map(stage => `
                                    <div class="stage">
                                        <span class="stage-num">${stage.num}</span>
                                        <div class="stage-content">
                                            <h4>${stage.title}</h4>
                                            <p>${stage.content}</p>
                                        </div>
                                    </div>
                                `).join('') || `<p>${story.content || ''}</p>`}
                            </div>
                        </div>
                    `).join('')
                }
                </section>
            `;
        }

        function renderAnalysis(analysis) {
            return `
                <section id="analysis" class="section">
                    <h2 class="section-title"><span>ğŸ”</span> Ø§Ù„ØªØ­Ù„ÙŠÙ„</h2>
                    
                    ${analysis.map?.length ? `
                    <div class="card">
                        <h3>ğŸ—ºï¸ Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„</h3>
                        <div class="grid-2">
                            ${analysis.map.map(item => `
                                <div class="mini-card">
                                    <div class="mini-icon">${item.icon || 'ğŸ“Œ'}</div>
                                    <h4>${item.title}</h4>
                                    <p>${item.content}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${analysis.actionPlan ? `
                    <div class="card">
                        <h3>ğŸ“‹ Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„</h3>
                        ${analysis.actionPlan.immediate?.length ? `
                            <div class="action-section">
                                <h4 style="color: #e74c3c;">âš¡ ÙÙˆØ±ÙŠ</h4>
                                <ul class="styled-list">${analysis.actionPlan.immediate.map(a => `<li>${a}</li>`).join('')}</ul>
                            </div>
                        ` : ''}
                        ${analysis.actionPlan.shortTerm?.length ? `
                            <div class="action-section">
                                <h4 style="color: #f39c12;">ğŸ“… Ù‚Ø±ÙŠØ¨ Ø§Ù„Ù…Ø¯Ù‰</h4>
                                <ul class="styled-list">${analysis.actionPlan.shortTerm.map(a => `<li>${a}</li>`).join('')}</ul>
                            </div>
                        ` : ''}
                        ${analysis.actionPlan.longTerm?.length ? `
                            <div class="action-section">
                                <h4 style="color: #27ae60;">ğŸ¯ Ø¨Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø¯Ù‰</h4>
                                <ul class="styled-list">${analysis.actionPlan.longTerm.map(a => `<li>${a}</li>`).join('')}</ul>
                            </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    ${analysis.conclusion ? `
                    <div class="card featured">
                        <h3>ğŸ“ Ø§Ù„Ø®Ù„Ø§ØµØ©</h3>
                        <p class="highlight-text">"${analysis.conclusion}"</p>
                    </div>
                    ` : ''}
                </section>
            `;
        }

        // ============ Navigation ============
        function initNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');

            navLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();

                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');

                    const targetId = this.getAttribute('href').substring(1);
                    const targetSection = document.getElementById(targetId);

                    if (targetSection) {
                        const navHeight = document.querySelector('.main-nav').offsetHeight;
                        const targetPosition = targetSection.offsetTop - navHeight - 10;

                        window.scrollTo({
                            top: targetPosition,
                            behavior: 'smooth'
                        });
                    }
                });
            });

            // Scroll tracking
            window.addEventListener('scroll', () => {
                const sections = document.querySelectorAll('.section');
                let current = '';
                const navHeight = document.querySelector('.main-nav')?.offsetHeight || 60;

                sections.forEach(section => {
                    const sectionTop = section.offsetTop - navHeight - 50;
                    if (window.scrollY >= sectionTop) {
                        current = section.getAttribute('id');
                    }
                });

                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href') === '#' + current) {
                        link.classList.add('active');
                    }
                });
            });
        }

        // ============ Utilities ============
        function copyText(element) {
            const text = element.querySelector('.ayah-text, .hadith-text, .dua-text')?.textContent || element.textContent;
            navigator.clipboard.writeText(text.trim()).then(() => {
                showToast('ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¨Ù†Ø¬Ø§Ø­! ğŸ“‹');
            });
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        function initScrollTop() {
            const scrollTopBtn = document.getElementById('scrollTop');
            window.addEventListener('scroll', () => {
                if (window.scrollY > 500) {
                    scrollTopBtn.classList.add('visible');
                } else {
                    scrollTopBtn.classList.remove('visible');
                }
            });

            scrollTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }

        function initSearch() {
            const searchBtn = document.getElementById('searchBtn');
            const searchModal = document.getElementById('searchModal');
            const searchInput = document.getElementById('searchInput');

            searchBtn.addEventListener('click', () => {
                searchModal.classList.add('active');
                searchInput.focus();
            });

            searchModal.addEventListener('click', (e) => {
                if (e.target === searchModal) closeSearch();
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeSearch();
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    searchModal.classList.add('active');
                    searchInput.focus();
                }
            });
        }

        function closeSearch() {
            document.getElementById('searchModal').classList.remove('active');
            document.getElementById('searchInput').value = '';
        }
    </script>
</body>

</html>