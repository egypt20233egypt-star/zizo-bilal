<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø²ÙŠØ²Ùˆ ÙˆØ¨Ù„Ø§Ù„ - Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø¯Ø¹ÙˆÙŠØ©</title>
    <meta name="description" content="Ù…Ù†ØµØ© Ø¯Ø¹ÙˆÙŠØ© ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ù„Ù†Ø´Ø± Ø§Ù„Ø¹Ù„Ù… Ø§Ù„Ø´Ø±Ø¹ÙŠ">
    <link rel="stylesheet" href="style.css">
    <style>
        /* ============ ğŸ° Phase 2.5: Royal Islamic Card Design ============ */
        /* âš ï¸ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø§Ù„ÙÙ„Ø§Øª) Ù…Ø­ÙÙˆØ¸ ÙÙŠ git - Ù…Ù…ÙƒÙ† ØªØ±Ø¬Ø¹Ù„Ù‡ Ø¨Ù€ git checkout */

        /* === Ø§Ù„Ø´Ø¨ÙƒØ© === */
        .dynamic-section .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 18px;
            margin-top: 14px;
        }

        /* === Ø§Ù„ÙƒØ§Ø±Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ - Glassmorphism + Islamic Pattern === */
        .dynamic-section .card {
            background: linear-gradient(145deg, rgba(26, 26, 42, 0.92), rgba(16, 16, 28, 0.96));
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(212, 175, 55, 0.18);
            border-radius: 16px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            animation: cardFadeIn 0.4s ease both;
        }

        /* Ø²Ø®Ø±ÙØ© Ø¥Ø³Ù„Ø§Ù…ÙŠØ© Ø®ÙÙŠÙØ© Ø¬Ø¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© */
        .dynamic-section .card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M20 0L40 20L20 40L0 20Z' fill='none' stroke='%23d4af37' stroke-opacity='0.03' stroke-width='0.5'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
        }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø§Ù„Ø°Ù‡Ø¨ÙŠ */
        .dynamic-section .card::before {
            content: '';
            position: absolute;
            top: 8px;
            right: 0;
            width: 3px;
            height: calc(100% - 16px);
            background: linear-gradient(to bottom, #DAA520, #B8860B, rgba(218, 165, 32, 0.3));
            border-radius: 3px;
            z-index: 1;
        }

        /* Hover - ØªÙˆÙ‡Ø¬ Ø°Ù‡Ø¨ÙŠ Ù†Ø§Ø¹Ù… */
        .dynamic-section .card:hover {
            transform: translateY(-4px);
            border-color: rgba(212, 175, 55, 0.4);
            box-shadow: 0 8px 30px rgba(212, 175, 55, 0.1),
                0 2px 10px rgba(0, 0, 0, 0.3);
        }

        /* Ø¸Ù‡ÙˆØ± ØªØ¯Ø±ÙŠØ¬ÙŠ Ù„Ù„ÙƒØ±ÙˆØª */
        @keyframes cardFadeIn {
            from {
                opacity: 0;
                transform: translateY(12px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* === Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ÙƒØ±ÙˆØª === */
        .dynamic-section .card h4 {
            color: #DAA520;
            font-size: 1.05em;
            margin-bottom: 10px;
            font-weight: 700;
            font-family: 'Tajawal', sans-serif;
            padding-bottom: 8px;
            border-bottom: 1px dashed rgba(212, 175, 55, 0.2);
            position: relative;
            z-index: 1;
        }

        /* === Ø§Ù„Ù†ØµÙˆØµ === */
        .dynamic-section .card p {
            color: #d4d4d4;
            line-height: 1.8;
            font-size: 0.95em;
            position: relative;
            z-index: 1;
        }

        /* === Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ù‚Ø© === */
        .dynamic-section .styled-list {
            list-style: none;
            padding: 0;
            position: relative;
            z-index: 1;
        }

        .dynamic-section .styled-list li {
            padding: 10px 16px;
            margin: 5px 0;
            background: rgba(212, 175, 55, 0.04);
            border-radius: 10px;
            border-right: 3px solid rgba(218, 165, 32, 0.5);
            color: #e0e0e0;
            line-height: 1.7;
            transition: background 0.25s ease, border-color 0.25s ease;
        }

        .dynamic-section .styled-list li:hover {
            background: rgba(212, 175, 55, 0.1);
            border-right-color: #DAA520;
        }

        /* === Ø§Ù„Ø´Ø§Ø±Ø§Øª (Badges) === */
        .dynamic-section .badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            position: relative;
            z-index: 1;
        }

        .dynamic-section .badge {
            background: rgba(212, 175, 55, 0.08);
            color: #e8c84a;
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            border: 1px solid rgba(212, 175, 55, 0.15);
            display: inline-block;
            transition: background 0.2s ease;
        }

        .dynamic-section .badge:hover {
            background: rgba(212, 175, 55, 0.15);
        }

        /* === Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ÙØ±Ø¹ÙŠØ© === */
        .dynamic-section .sub-section {
            margin-top: 12px;
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border-right: 3px solid rgba(212, 175, 55, 0.25);
            position: relative;
            z-index: 1;
        }

        .dynamic-section .sub-section strong {
            color: #DAA520;
            display: block;
            margin-bottom: 6px;
            font-family: 'Tajawal', sans-serif;
        }

        /* === Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù… === */
        .dynamic-section .section-title {
            font-size: 1.4em;
            color: #fff;
            margin-bottom: 18px;
            padding-bottom: 10px;
            border-bottom: 2px solid transparent;
            background-image: linear-gradient(var(--bg, #0d0d1a), var(--bg, #0d0d1a)),
                linear-gradient(90deg, #DAA520, transparent);
            background-origin: padding-box, border-box;
            background-clip: padding-box, border-box;
        }

        .dynamic-section .section-title span {
            font-size: 1.2em;
            margin-left: 6px;
        }

        /* === Responsive === */
        @media (max-width: 600px) {
            .dynamic-section .cards-grid {
                grid-template-columns: 1fr;
                gap: 14px;
            }

            .dynamic-section .card {
                padding: 16px;
            }
        }
    </style>
    <link
        href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@400;500;700&display=swap"
        rel="stylesheet">
    <!-- DOMPurify for XSS Protection -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
</head>

<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loader"></div>
        <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>

    <!-- Header -->
    <header class="main-header">
        <div class="container">
            <div class="header-icon">ğŸ•Œ</div>
            <h1 id="lessonTitle">Ù…Ù†ØµØ© Ø²ÙŠØ²Ùˆ ÙˆØ¨Ù„Ø§Ù„</h1>
            <p class="subtitle" id="lessonSubtitle">Ù…Ù†ØµØ© Ø¯Ø¹ÙˆÙŠØ© ØªØ¹Ù„ÙŠÙ…ÙŠØ©</p>
            <div class="tags" id="lessonTags"></div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="main-nav" id="mainNav">
        <div class="nav-container" id="navContainer">
            <a href="#lessons" class="nav-link active"><span class="nav-icon">ğŸ“š</span><span
                    class="nav-text">Ø§Ù„Ø¯Ø±ÙˆØ³</span></a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Lessons Selector -->
        <section id="lessons" class="section">
            <h2 class="section-title"><span>ğŸ“š</span> Ø§Ø®ØªØ± Ø§Ù„Ø¯Ø±Ø³</h2>
            <div id="lessonsGrid" class="characters-grid">
                <div class="card featured" style="text-align: center; padding: 40px;">
                    <div class="loader" style="margin: 0 auto;"></div>
                    <p style="margin-top: 20px; color: var(--gold);">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³...</p>
                </div>
            </div>
        </section>

        <!-- Dynamic Content Container -->
        <div id="lessonContent"></div>
    </main>

    <!-- Footer -->
    <footer class="main-footer">
        <p>Â© 2024 Ø²ÙŠØ²Ùˆ ÙˆØ¨Ù„Ø§Ù„ - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p>
        <p class="footer-dua">Ø§Ù„Ù„Ù‡Ù… Ø¹Ù„Ù…Ù†Ø§ Ù…Ø§ ÙŠÙ†ÙØ¹Ù†Ø§ ÙˆØ§Ù†ÙØ¹Ù†Ø§ Ø¨Ù…Ø§ Ø¹Ù„Ù…ØªÙ†Ø§</p>
    </footer>

    <!-- Floating Buttons -->
    <button class="scroll-top" id="scrollTop">â¬†ï¸</button>
    <button class="search-btn" id="searchBtn">ğŸ”</button>

    <!-- Search Modal -->
    <div class="search-modal" id="searchModal">
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰...">
            <button onclick="closeSearch()">âœ•</button>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ============ Configuration ============
        const API_URL = window.location.origin + '/api/lessons';

        let currentLesson = null;
        let allLessons = [];

        // ============ Initialize ============
        document.addEventListener('DOMContentLoaded', async function () {
            await loadLessons();

            // Hide loading screen
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
            }, 800);

            initScrollTop();
            initSearch();
        });

        // ============ Load Lessons from API ============
        async function loadLessons() {
            try {
                // Get ALL lessons (not just published)
                const response = await fetch(API_URL);
                const lessons = await response.json();
                allLessons = lessons;

                if (lessons.length === 0) {
                    showEmptyState();
                } else {
                    renderLessonsGrid(lessons);
                    // Auto-select first lesson (most recent)
                    selectLessonByIndex(0);
                }
            } catch (error) {
                console.error('Error loading lessons:', error);
                showErrorState();
            }
        }

        function showEmptyState() {
            document.getElementById('lessonsGrid').innerHTML = `
                <div class="card featured" style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                    <h3>ğŸ•Œ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±ÙˆØ³ Ù…Ù†Ø´ÙˆØ±Ø© Ø¨Ø¹Ø¯</h3>
                    <p style="color: var(--gray);">Ø£Ø¶Ù Ø¯Ø±ÙˆØ³ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† ÙˆØ§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
                    <a href="/admin" style="color: var(--gold); text-decoration: underline; margin-top: 15px; display: inline-block;">ğŸ”§ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</a>
                </div>
            `;
        }

        function showErrorState() {
            document.getElementById('lessonsGrid').innerHTML = `
                <div class="card warning" style="text-align: center; padding: 40px; grid-column: 1 / -1;">
                    <h3>âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</h3>
                    <p style="color: var(--gray);">ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ MongoDB ÙˆØ§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</p>
                    <button onclick="location.reload()" style="background: var(--gold); color: var(--black); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-top: 15px;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                </div>
            `;
        }

        // ============ ğŸ“– Ù‚Ø§Ù…ÙˆØ³ ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Section Labels Map) ============
        const SECTION_LABELS = {
            // Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            metadata: { name: 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø±Ø³', icon: 'ğŸ“‹' },
            overview: { name: 'Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©', icon: 'ğŸ“‹' },
            podcast: { name: 'Ø§Ù„Ø¨ÙˆØ¯ÙƒØ§Ø³Øª', icon: 'ğŸ™ï¸' },
            characters: { name: 'Ø§Ù„Ø´Ø®ØµÙŠØ§Øª', icon: 'ğŸ‘¥' },
            quranHadith: { name: 'Ø§Ù„Ø¢ÙŠØ§Øª ÙˆØ§Ù„Ø£Ø­Ø§Ø¯ÙŠØ«', icon: 'ğŸ“–' },
            fiqh: { name: 'Ø§Ù„Ø£Ø­ÙƒØ§Ù… Ø§Ù„ÙÙ‚Ù‡ÙŠØ©', icon: 'ğŸ•Œ' },
            questions: { name: 'Ø§Ù„Ø£Ø³Ø¦Ù„Ø©', icon: 'â“' },
            benefits: { name: 'Ø§Ù„ÙÙˆØ§Ø¦Ø¯', icon: 'ğŸ’' },
            stories: { name: 'Ø§Ù„Ù‚ØµØµ', icon: 'ğŸ“š' },
            analysis: { name: 'Ø§Ù„ØªØ­Ù„ÙŠÙ„', icon: 'ğŸ”' },
            // Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (13+ Ù‚Ø³Ù…)
            lessonMap: { name: 'Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¯Ø±Ø³', icon: 'ğŸ—ºï¸' },
            mainPoints: { name: 'Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', icon: 'ğŸ“Œ' },
            comprehensiveSummary: { name: 'Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ø§Ù…Ù„', icon: 'ğŸ“‹' },
            rulings: { name: 'Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ø£Ø­ÙƒØ§Ù…', icon: 'âš–ï¸' },
            fatawa: { name: 'Ø§Ù„ÙØªØ§ÙˆÙ‰ ÙˆØ§Ù„Ù…Ø³Ø§Ø¦Ù„', icon: 'â“' },
            kidsCorner: { name: 'Ø¨Ø³ØªØ§Ù† Ø§Ù„Ø£Ø·ÙØ§Ù„', icon: 'ğŸ¨' },
            practicalApplications: { name: 'Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', icon: 'ğŸ¯' },
            terminology: { name: 'Ø´Ø±Ø­ Ø§Ù„Ù…ØµØ·Ù„Ø­Ø§Øª', icon: 'ğŸ“–' },
            scholarQuotes: { name: 'Ø£Ù‚ÙˆØ§Ù„ Ø§Ù„Ø¹Ù„Ù…Ø§Ø¡', icon: 'ğŸ“œ' },
            realLifeScenarios: { name: 'Ø±Ø¨Ø· Ø¨Ø§Ù„ÙˆØ§Ù‚Ø¹', icon: 'ğŸŒ' },
            etiquettes: { name: 'Ø§Ù„Ø¢Ø¯Ø§Ø¨ ÙˆØ§Ù„Ø³Ù„ÙˆÙƒÙŠØ§Øª', icon: 'ğŸ©' },
            mindMap: { name: 'Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø°Ù‡Ù†ÙŠØ©', icon: 'ğŸ§ ' },
            flashcards: { name: 'Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø­ÙØ¸', icon: 'ğŸƒ' },
            socialMedia: { name: 'Ù„Ù„Ø³ÙˆØ´ÙŠØ§Ù„ Ù…ÙŠØ¯ÙŠØ§', icon: 'ğŸ“±' },
            commonMistakes: { name: 'Ø£Ø®Ø·Ø§Ø¡ Ø´Ø§Ø¦Ø¹Ø©', icon: 'âš ï¸' },
            ideas: { name: 'Ø§Ù„Ø£ÙÙƒØ§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', icon: 'ğŸ’¡' },
            advice: { name: 'Ø§Ù„Ù†ØµØ§Ø¦Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', icon: 'ğŸ¯' },
            prosAndCons: { name: 'Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ ÙˆØ§Ù„Ø³Ù„Ø¨ÙŠ', icon: 'ğŸ’' },
            // Ø£Ù‚Ø³Ø§Ù… Ø²ÙŠØ²Ùˆ Ø§Ù„Ø®Ø§ØµØ©
            suggestions: { name: 'Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ÙˆÙ…Ù‚ØªØ±Ø­Ø§Øª', icon: 'ğŸ’¡' },
            opinion: { name: 'Ø§Ù„Ø±Ø£ÙŠ ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„', icon: 'ğŸ‘ï¸' },
            proTips: { name: 'Ù„Ù…Ø³Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©', icon: 'ğŸ‘”' },
            innovation: { name: 'Ø±ÙƒÙ† Ø§Ù„Ø§Ø¨ØªÙƒØ§Ø±', icon: 'ğŸš€' },
            strategy: { name: 'Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠØ© ÙˆØ§Ù„Ø®Ø·Ø·', icon: 'â™Ÿï¸' },
            bestPractice: { name: 'Ø§Ù„Ø£ÙØ¶Ù„ ÙˆØ§Ù„Ø£Ø­Ø³Ù†', icon: 'ğŸ†' },
            smartInsights: { name: 'Ù„Ù…Ø³Ø§Øª Ø°ÙƒÙŠØ©', icon: 'ğŸ§ ' },
            flexibility: { name: 'Ø§Ù„Ù…Ø±ÙˆÙ†Ø© ÙˆØ§Ù„Ø¨Ø¯Ø§Ø¦Ù„', icon: 'ğŸ”„' },
            dynamicFlow: { name: 'Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© ÙˆØ§Ù„ØªØ·ÙˆØ±', icon: 'ğŸŒŠ' },
            conclusion: { name: 'Ø§Ù„Ø®Ù„Ø§ØµØ©', icon: 'ğŸ' },
            // Ø£Ù‚Ø³Ø§Ù… Ø§ÙƒØªÙØ´ÙØª Ù…Ù† Ø§Ù„Ù€ JSON
            bookmarks: { name: 'Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©', icon: 'ğŸ”–' },
            weeklyPlan: { name: 'Ø®Ø·Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹', icon: 'ğŸ“†' },
            visualization: { name: 'Ù…Ø´Ù‡Ø¯ ØªØ®ÙŠÙ„ÙŠ', icon: 'ğŸ¬' },
            beforeAfter: { name: 'Ù‚Ø¨Ù„ ÙˆØ¨Ø¹Ø¯', icon: 'ğŸ”„' },
            progressLadder: { name: 'Ø³Ù„Ù… Ø§Ù„ØªØ¯Ø±Ø¬', icon: 'ğŸªœ' },
            badges: { name: 'Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²', icon: 'ğŸ†' },
            imaginaryDialogues: { name: 'Ø­ÙˆØ§Ø±Ø§Øª Ù…ØªØ®ÙŠÙ„Ø©', icon: 'ğŸ’¬' },
            habitLink: { name: 'Ø±Ø¨Ø· Ø¨Ø§Ù„Ø¹Ø§Ø¯Ø§Øª', icon: 'ğŸ”—' },
            funStats: { name: 'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù…ØªØ¹Ø©', icon: 'ğŸ“Š' },
            faqs: { name: 'Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©', icon: 'â“' },
            relatedTopics: { name: 'Ù…ÙˆØ§Ø¶ÙŠØ¹ Ù…Ø±ØªØ¨Ø·Ø©', icon: 'ğŸ”—' },
            references: { name: 'Ø±ÙˆØ§Ø¨Ø· ÙˆÙ…Ø±Ø§Ø¬Ø¹', icon: 'ğŸ“š' },
            timeline: { name: 'Ø§Ù„ØªØ³Ù„Ø³Ù„ Ø§Ù„Ø²Ù…Ù†ÙŠ', icon: 'ğŸ“…' },
            // Ø£Ù‚Ø³Ø§Ù… Ø§ÙƒØªÙØ´ÙØª Ù…Ù† API v3.6
            practicalApplication: { name: 'Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„ÙŠ', icon: 'ğŸ†' },
            commonMistakes: { name: 'Ø£Ø®Ø·Ø§Ø¡ Ø´Ø§Ø¦Ø¹Ø©', icon: 'âš ï¸' },
        };

        // ============ ğŸ“– Ù‚Ø§Ù…ÙˆØ³ ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ (Sub-Key Labels) ============
        const SUB_KEY_LABELS = {
            ageRange: 'Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø¹Ù…Ø±ÙŠØ©',
            learningOutcome: 'Ù…Ø§Ø°Ø§ ÙŠØªØ¹Ù„Ù… Ø§Ù„Ø·ÙÙ„',
            activity: 'Ø§Ù„Ù†Ø´Ø§Ø·',
            duration: 'Ø§Ù„Ù…Ø¯Ø©',
            tools: 'Ø§Ù„Ø£Ø¯ÙˆØ§Øª',
            steps: 'Ø§Ù„Ø®Ø·ÙˆØ§Øª',
            rule: 'Ø§Ù„Ø­ÙƒÙ…',
            evidence: 'Ø§Ù„Ø¯Ù„ÙŠÙ„',
            explanation: 'Ø§Ù„Ø´Ø±Ø­',
            source: 'Ø§Ù„Ù…ØµØ¯Ø±',
            scholar: 'Ø§Ù„Ø¹Ø§Ù„Ù…',
            quote: 'Ø§Ù„Ù‚ÙˆÙ„',
            scenario: 'Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ',
            application: 'Ø§Ù„ØªØ·Ø¨ÙŠÙ‚',
            mistake: 'Ø§Ù„Ø®Ø·Ø£',
            correction: 'Ø§Ù„ØªØµØ­ÙŠØ­',
            term: 'Ø§Ù„Ù…ØµØ·Ù„Ø­',
            definition: 'Ø§Ù„ØªØ¹Ø±ÙŠÙ',
            meaning: 'Ø§Ù„Ù…Ø¹Ù†Ù‰',
            category: 'Ø§Ù„ØªØµÙ†ÙŠÙ',
            priority: 'Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©',
            status: 'Ø§Ù„Ø­Ø§Ù„Ø©',
            type: 'Ø§Ù„Ù†ÙˆØ¹',
            role: 'Ø§Ù„Ø¯ÙˆØ±',
            lesson: 'Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ù…Ø³ØªÙØ§Ø¯',
            benefit: 'Ø§Ù„ÙØ§Ø¦Ø¯Ø©',
            warning: 'Ø§Ù„ØªØ­Ø°ÙŠØ±',
            tip: 'Ù†ØµÙŠØ­Ø©',
            note: 'Ù…Ù„Ø§Ø­Ø¸Ø©',
            reference: 'Ø§Ù„Ù…Ø±Ø¬Ø¹',
            icon: 'Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©',
            num: 'Ø§Ù„Ø±Ù‚Ù…',
            color: 'Ø§Ù„Ù„ÙˆÙ†',
            image: 'Ø§Ù„ØµÙˆØ±Ø©',
            link: 'Ø§Ù„Ø±Ø§Ø¨Ø·',
            hashtag: 'Ù‡Ø§Ø´ØªØ§Ø¬',
            platform: 'Ø§Ù„Ù…Ù†ØµØ©',
            postText: 'Ù†Øµ Ø§Ù„Ù…Ù†Ø´ÙˆØ±',
            front: 'Ø§Ù„ÙˆØ¬Ù‡',
            back: 'Ø§Ù„Ø®Ù„Ù',
            question: 'Ø§Ù„Ø³Ø¤Ø§Ù„',
            answer: 'Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©',
            isCorrect: 'ØµØ­ÙŠØ­ØŸ',
            // Ù…ÙØ§ØªÙŠØ­ Ø¥Ø¶Ø§ÙÙŠØ© Ø§ÙƒØªÙØ´ÙØª Ù…Ù† JSON
            topic: 'Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹',
            connection: 'Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø·',
            posts: 'Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª',
            branches: 'Ø§Ù„ÙØ±ÙˆØ¹',
            items: 'Ø§Ù„Ø¹Ù†Ø§ØµØ±',
            center: 'Ø§Ù„Ù…Ø­ÙˆØ±',
            habit: 'Ø§Ù„Ø¹Ø§Ø¯Ø©',
            action: 'Ø§Ù„ÙØ¹Ù„',
            stat: 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©',
            equals: 'ÙŠØ¹Ø§Ø¯Ù„',
            q: 'Ø§Ù„Ø³Ø¤Ø§Ù„',
            a: 'Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©',
            day: 'Ø§Ù„ÙŠÙˆÙ…',
            task: 'Ø§Ù„Ù…Ù‡Ù…Ø©',
            level: 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰',
            goal: 'Ø§Ù„Ù‡Ø¯Ù',
            reward: 'Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©',
            condition: 'Ø§Ù„Ø´Ø±Ø·',
            aspect: 'Ø§Ù„Ø¬Ø§Ù†Ø¨',
            before: 'Ù‚Ø¨Ù„',
            after: 'Ø¨Ø¹Ø¯',
            result: 'Ø§Ù„Ù†ØªÙŠØ¬Ø©',
            scene: 'Ø§Ù„Ù…Ø´Ù‡Ø¯',
            speaker: 'Ø§Ù„Ù…ØªØ­Ø¯Ø«',
            dialogue: 'Ø§Ù„Ø­ÙˆØ§Ø±',
            dialogues: 'Ø§Ù„Ø­ÙˆØ§Ø±Ø§Øª',
            event: 'Ø§Ù„Ø­Ø¯Ø«',
            details: 'Ø§Ù„ØªÙØ§ØµÙŠÙ„',
            practice: 'Ø§Ù„Ø¹Ù…Ù„',
            whyWrong: 'Ù„Ù…Ø§Ø°Ø§ Ø®Ø·Ø£',
            consequence: 'Ø§Ù„Ù†ØªÙŠØ¬Ø©',
            prohibition: 'Ø§Ù„Ù†Ù‡ÙŠ',
            degree: 'Ø§Ù„Ø¯Ø±Ø¬Ø©',
            oneLine: 'Ø¨Ø§Ø®ØªØµØ§Ø±',
            quickSummary: 'Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø³Ø±ÙŠØ¹',
            keyPoints: 'Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
            mainTakeaway: 'Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ',
            dashboard: 'Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©',
            doThis: 'Ø§ÙØ¹Ù„ âœ…',
            dontDoThis: 'Ù„Ø§ ØªÙØ¹Ù„ âŒ',
            rewards: 'Ø§Ù„Ø«ÙˆØ§Ø¨',
            correctPractices: 'Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ØµØ­ÙŠØ­Ø©',
            wrongPractices: 'Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©',
            important: 'Ø§Ù„Ù…Ù‡Ù…',
            days: 'Ø§Ù„Ø£ÙŠØ§Ù…',
            levels: 'Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª',
            habits: 'Ø§Ù„Ø¹Ø§Ø¯Ø§Øª',
            stats: 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª',
            list: 'Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©',
            cards: 'Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª',
            topics: 'Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹',
            comparisons: 'Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø§Øª',
            events: 'Ø§Ù„Ø£Ø­Ø¯Ø§Ø«',
            books: 'Ø§Ù„ÙƒØªØ¨',
            author: 'Ø§Ù„Ù…Ø¤Ù„Ù',
            hadithSources: 'Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ«',
            sunan: 'Ø§Ù„Ø³Ù†Ù†',
            hashtags: 'Ø§Ù„Ù‡Ø§Ø´ØªØ§Ø¬Ø§Øª',
            content: 'Ø§Ù„Ù…Ø­ØªÙˆÙ‰',
            moral: 'Ø§Ù„Ø¹Ø¨Ø±Ø©',
            challenge: 'Ø§Ù„ØªØ­Ø¯ÙŠ',
            discussion: 'Ù„Ù„Ù†Ù‚Ø§Ø´',
            reflection: 'Ù„Ù„ØªØ£Ù…Ù„',
            keyInsight: 'Ø§Ù„Ø¨ØµÙŠØ±Ø©',
            visualDescription: 'Ø§Ù„ÙˆØµÙ Ø§Ù„Ø¨ØµØ±ÙŠ',
            situation: 'Ø§Ù„Ù…ÙˆÙ‚Ù',
            wrong: 'Ø§Ù„Ø®Ø·Ø£',
            right: 'Ø§Ù„ØµØ­',
            etiquette: 'Ø§Ù„Ø£Ø¯Ø¨',
            how: 'ÙƒÙŠÙ',
            ruling: 'Ø§Ù„Ø­ÙƒÙ…',
            song: 'Ø§Ù„Ø£Ù†Ø´ÙˆØ¯Ø©',
            // Ù…ÙØ§ØªÙŠØ­ Ø§ÙƒØªÙØ´ÙØª Ù…Ù† practicalApplications
            daily: 'ÙŠÙˆÙ…ÙŠ',
            weekly: 'Ø£Ø³Ø¨ÙˆØ¹ÙŠ',
            monthly: 'Ø´Ù‡Ø±ÙŠ',
            forFamily: 'Ù„Ù„Ø£Ø³Ø±Ø©',
            time: 'Ø§Ù„ÙˆÙ‚Øª',
            when: 'Ù…ØªÙ‰',
            // Ù…ÙØ§ØªÙŠØ­ Ø§ÙƒØªÙØ´ÙØª Ù…Ù† terminology
            origin: 'Ø§Ù„Ø£ØµÙ„',
            context: 'Ø§Ù„Ø³ÙŠØ§Ù‚',
            opposite: 'Ø§Ù„Ø¹ÙƒØ³',
            cause: 'Ø§Ù„Ø³Ø¨Ø¨',
            // Ù…ÙØ§ØªÙŠØ­ Ù…Ù† lessonMap Ùˆ kidsCorner
            mainTopic: 'Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ',
            subtopics: 'Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø§Ù„ÙØ±Ø¹ÙŠØ©',
            simpleSummary: 'Ù…Ù„Ø®Øµ Ø¨Ø³ÙŠØ·',
            funFacts: 'Ø­Ù‚Ø§Ø¦Ù‚ Ù…Ù…ØªØ¹Ø©',
            // Ù…ÙØ§ØªÙŠØ­ Ù…Ù† questions
            review: 'Ù…Ø±Ø§Ø¬Ø¹Ø©',
            thinking: 'ØªÙÙƒÙŠØ±',
            hint: 'ØªÙ„Ù…ÙŠØ­',
            // Ù…ÙØ§ØªÙŠØ­ Ù…Ù† characters
            bio: 'Ù†Ø¨Ø°Ø©',
            whyMentioned: 'Ù„Ù…Ø§Ø°Ø§ Ø°ÙÙƒØ±',
            traits: 'Ø§Ù„ØµÙØ§Øª',
            lessons: 'Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…Ø³ØªÙØ§Ø¯Ø©',
            stage: 'Ø§Ù„Ù…Ø±Ø­Ù„Ø©',
            // Ù…ÙØ§ØªÙŠØ­ Ù…Ù† benefits
            creed: 'Ø¹Ù‚ÙŠØ¯Ø©',
            manners: 'Ø£Ø®Ù„Ø§Ù‚',
            spiritual: 'Ø±ÙˆØ­Ø§Ù†ÙŠ',
            // Ù…ÙØ§ØªÙŠØ­ Ù…Ù† quranHadith
            surah: 'Ø§Ù„Ø³ÙˆØ±Ø©',
            ayahNumber: 'Ø±Ù‚Ù… Ø§Ù„Ø¢ÙŠØ©',
            authenticity: 'Ø§Ù„Ø«Ø­Ù‚ÙŠÙ‚',
            narrator: 'Ø§Ù„Ø±Ø§ÙˆÙŠ',
            purpose: 'Ø§Ù„ØºØ±Ø¶',
            dua: 'Ø§Ù„Ø£Ø¯Ø¹ÙŠØ©',
            ayat: 'Ø§Ù„Ø¢ÙŠØ§Øª',
            hadith: 'Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ«',
            // Ù…ÙØ§ØªÙŠØ­ Ø¹Ø§Ù…Ø©
            title: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†',
            subtitle: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØ±Ø¹ÙŠ',
            difficulty: 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰',
            readingTime: 'ÙˆÙ‚Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©',
            date: 'Ø§Ù„ØªØ§Ø±ÙŠØ®',
            scenarios: 'Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª',
            prohibitions: 'Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø§Øª',
            toddlers: 'Ù„Ù„ØµØºØ§Ø± Ø¬Ø¯Ø§Ù‹',
            kids: 'Ù„Ù„Ø£Ø·ÙØ§Ù„',
            teens: 'Ù„Ù„Ù…Ø±Ø§Ù‡Ù‚ÙŠÙ†',
            women: 'Ù„Ù„Ù†Ø³Ø§Ø¡',
            adults: 'Ù„Ù„ÙƒØ¨Ø§Ø±',
            // Ù…ÙØ§ØªÙŠØ­ Ø±Ø¨Ø· Ø¨Ø§Ù„ÙˆØ§Ù‚Ø¹ + Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² (v3.5)
            situation: 'ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ù',
            wrong: 'âŒ Ø§Ù„Ø®Ø·Ø£',
            right: 'âœ… Ø§Ù„ØµØ­',
            lesson: 'ğŸ’¡ Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ù…Ø³ØªÙØ§Ø¯',
            condition: 'ğŸ¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨',
            // Ù…ÙØ§ØªÙŠØ­ Ù…Ù† podcast
            hook: 'Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ø§Ù„Ø¬Ø°Ø§Ø¨Ø©',
            intro: 'Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©',
            mainContent: 'Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ',
            callToAction: 'Ø¯Ø¹ÙˆØ© Ù„Ù„Ø¹Ù…Ù„',
            estimatedDuration: 'Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©',
            tone: 'Ø§Ù„Ù†Ø¨Ø±Ø©',
            conclusion: 'Ø§Ù„Ø®Ø§ØªÙ…Ø©',
            // Ù…ÙØ§ØªÙŠØ­ Ù…Ù† stories
            stages: 'Ø§Ù„Ù…Ø±Ø§Ø­Ù„',
            story: 'Ø§Ù„Ù‚ØµØ©',
            // Ù…ÙØ§ØªÙŠØ­ Ù…Ù† commonMistakes
            severity: 'Ø§Ù„Ø®Ø·ÙˆØ±Ø©',
            reason: 'Ø§Ù„Ø³Ø¨Ø¨',
            // Ù…ÙØ§ØªÙŠØ­ Ù…Ù† socialMedia
            tweet: 'ØªØºØ±ÙŠØ¯Ø©',
            whatsappStatus: 'Ø­Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨',
            designQuote: 'Ø§Ù‚ØªØ¨Ø§Ø³ ØªØµÙ…ÙŠÙ…ÙŠ',
            instagramCaption: 'Ù†Øµ Ø§Ù†Ø³ØªØ¬Ø±Ø§Ù…',
            // Ù…ÙØ§ØªÙŠØ­ Ù…Ù† analysis
            finalConclusion: 'Ø§Ù„Ø®Ù„Ø§ØµØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©',
            lessonAxes: 'Ù…Ø­Ø§ÙˆØ± Ø§Ù„Ø¯Ø±Ø³',
            axis: 'Ø§Ù„Ù…Ø­ÙˆØ±',
            connections: 'Ø§Ù„Ø±ÙˆØ§Ø¨Ø·',
            previousTopics: 'Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø³Ø§Ø¨Ù‚Ø©',
            nextTopics: 'Ù…ÙˆØ§Ø¶ÙŠØ¹ Ù‚Ø§Ø¯Ù…Ø©',
            requiredKnowledge: 'Ù…Ø¹Ø±ÙØ© Ù…Ø·Ù„ÙˆØ¨Ø©',
            strengths: 'Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©',
            expectedImpact: 'Ø§Ù„Ø£Ø«Ø± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹',
            emotional: 'Ø§Ù„Ø£Ø«Ø± Ø§Ù„Ø¹Ø§Ø·ÙÙŠ',
            behavioral: 'Ø§Ù„Ø£Ø«Ø± Ø§Ù„Ø³Ù„ÙˆÙƒÙŠ',
            // Ù…ÙØ§ØªÙŠØ­ Ù…Ù† practicalApplication
            immediate: 'ÙÙˆØ±ÙŠ',
            shortTerm: 'Ù‚Ø±ÙŠØ¨ Ø§Ù„Ù…Ø¯Ù‰',
            longTerm: 'Ø¨Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø¯Ù‰',
            weeklyChallenge: 'ØªØ­Ø¯ÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹',
            checklist: 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
            // Ù…ÙØ§ØªÙŠØ­ Ù…Ù† rulings
            correctPractices: 'Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©',
            prohibitions: 'Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø§Øª',
            // Ù…ÙØ§ØªÙŠØ­ Ø¥Ø¶Ø§ÙÙŠØ©
            description: 'Ø§Ù„ÙˆØµÙ',
            name: 'Ø§Ù„Ø§Ø³Ù…',
            text: 'Ø§Ù„Ù†Øµ',
            duration: 'Ø§Ù„Ù…Ø¯Ø©',
        };

        function renderLessonsGrid(lessons) {
            const grid = document.getElementById('lessonsGrid');
            grid.innerHTML = lessons.map((lesson, index) => `
                <div class="character-card ${['gold', 'blue', 'purple', 'yellow'][index % 4]}" 
                     onclick="selectLessonByIndex(${index})"
                     style="cursor: pointer;" id="lesson-card-${index}">
                    <div class="char-header">
                        <span class="char-icon">ğŸ“–</span>
                        <div>
                            <h4>${lesson.title}</h4>
                            <span class="char-type">${lesson.subtitle || 'Ø¯Ø±Ø³ Ø¥Ø³Ù„Ø§Ù…ÙŠ'}</span>
                        </div>
                    </div>
                    ${lesson.aiAnalyzed ? '<div class="char-lessons"><span>âœ… ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</span></div>' : ''}
                </div>
            `).join('');
        }

        // ============ Select Lesson by Index ============
        function selectLessonByIndex(index) {
            if (index < 0 || index >= allLessons.length) return;

            const lesson = allLessons[index];
            selectLesson(lesson);

            // Highlight selected card
            document.querySelectorAll('.character-card').forEach((card, i) => {
                card.classList.remove('selected');
                if (i === index) card.classList.add('selected');
            });
        }

        // ============ Select and Render Lesson ============
        function selectLesson(lesson) {
            currentLesson = lesson;

            // Update header
            document.getElementById('lessonTitle').textContent = lesson.title;
            document.getElementById('lessonSubtitle').textContent = lesson.subtitle || 'Ø¯Ø±Ø³ Ø¥Ø³Ù„Ø§Ù…ÙŠ';

            // Update tags
            if (lesson.tags && lesson.tags.length > 0) {
                document.getElementById('lessonTags').innerHTML = lesson.tags.map(tag =>
                    `<span class="tag">${tag}</span>`
                ).join('');
            }

            // Build navigation
            buildNavigation(lesson);

            // Render content
            renderLessonContent(lesson);

            // Scroll to content
            document.getElementById('lessonContent').scrollIntoView({ behavior: 'smooth' });
        }

        function buildNavigation(lesson) {
            const nav = document.getElementById('navContainer');
            const sections = [];

            // Known sections to skip when detecting dynamic ones
            const knownKeys = ['title', 'subtitle', 'tags', 'rawContent', 'rawSource', 'status', 'aiAnalyzed',
                'overview', 'podcast', 'characters', 'quranHadith', 'fiqh',
                'questions', 'benefits', 'stories', 'analysis', '_id', 'createdAt', 'updatedAt', '__v'];

            // Check available known sections
            sections.push({ id: 'lessons', icon: 'ğŸ“š', name: 'Ø§Ù„Ø¯Ø±ÙˆØ³' });

            if (lesson.overview?.message || lesson.overview?.points?.length) {
                sections.push({ id: 'overview', icon: 'ğŸ“‹', name: 'Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©' });
            }
            if (lesson.podcast?.length) {
                sections.push({ id: 'podcast', icon: 'ğŸ™ï¸', name: 'Ø§Ù„Ø¨ÙˆØ¯ÙƒØ§Ø³Øª' });
            }
            if (lesson.characters?.length) {
                sections.push({ id: 'characters', icon: 'ğŸ‘¥', name: 'Ø§Ù„Ø´Ø®ØµÙŠØ§Øª' });
            }
            if (lesson.quranHadith?.ayat?.length || lesson.quranHadith?.hadith?.length || lesson.quranHadith?.duaa?.length) {
                sections.push({ id: 'quran', icon: 'ğŸ“–', name: 'Ø§Ù„Ø¢ÙŠØ§Øª ÙˆØ§Ù„Ø£Ø­Ø§Ø¯ÙŠØ«' });
            }
            if (lesson.fiqh?.rewards?.length || lesson.fiqh?.sunan?.length || lesson.fiqh?.warnings?.length || lesson.fiqh?.qa?.length) {
                sections.push({ id: 'fiqh', icon: 'ğŸ•Œ', name: 'Ø§Ù„Ø£Ø­ÙƒØ§Ù…' });
            }
            if (lesson.questions?.trueFalse?.length) {
                sections.push({ id: 'questions', icon: 'â“', name: 'Ø§Ù„Ø£Ø³Ø¦Ù„Ø©' });
            }
            if (lesson.benefits?.length) {
                sections.push({ id: 'benefits', icon: 'ğŸ’', name: 'Ø§Ù„ÙÙˆØ§Ø¦Ø¯' });
            }
            if (lesson.stories?.length) {
                sections.push({ id: 'stories', icon: 'ğŸ“š', name: 'Ø§Ù„Ù‚ØµØµ' });
            }
            if (lesson.analysis?.map?.length || lesson.analysis?.actionPlan || lesson.analysis?.conclusion) {
                sections.push({ id: 'analysis', icon: 'ğŸ”', name: 'Ø§Ù„ØªØ­Ù„ÙŠÙ„' });
            }

            // Add dynamic/custom sections to navigation (Ù…Ø¹ Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©)
            for (const [key, value] of Object.entries(lesson)) {
                if (knownKeys.includes(key)) continue;
                if (value === null || value === undefined) continue;
                if (Array.isArray(value) && value.length === 0) continue;
                if (typeof value === 'object' && Object.keys(value).length === 0) continue;

                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ø¹Ø±Ø¨ÙŠ + Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯
                const sectionInfo = SECTION_LABELS[key];
                const label = sectionInfo ? sectionInfo.name : key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1');
                const icon = sectionInfo ? sectionInfo.icon : 'âœ¨';
                if (!sectionInfo) console.warn(`âš ï¸ Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯ Ù…Ø´ ÙÙŠ Ø§Ù„Ù‚Ø§Ù…ÙˆØ³: "${key}" - Ø¶ÙŠÙÙ‡ ÙÙŠ SECTION_LABELS`);
                sections.push({ id: key, icon: icon, name: label });
            }

            nav.innerHTML = sections.map((s, i) => `
                <a href="#${s.id}" class="nav-link ${i === 0 ? 'active' : ''}">
                    <span class="nav-icon">${s.icon}</span>
                    <span class="nav-text">${s.name}</span>
                </a>
            `).join('');

            initNavigation();
        }

        function renderLessonContent(lesson) {
            const container = document.getElementById('lessonContent');
            let html = '';

            // Overview Section
            if (lesson.overview?.message || lesson.overview?.points?.length) {
                html += renderOverview(lesson.overview);
            }

            // Podcast Section
            if (lesson.podcast?.length) {
                html += renderPodcast(lesson.podcast);
            }

            // Characters Section
            if (lesson.characters?.length) {
                html += renderCharacters(lesson.characters);
            }

            // Quran & Hadith Section
            if (lesson.quranHadith?.ayat?.length || lesson.quranHadith?.hadith?.length) {
                html += renderQuranHadith(lesson.quranHadith);
            }

            // Fiqh Section
            if (lesson.fiqh?.rewards?.length || lesson.fiqh?.sunan?.length || lesson.fiqh?.warnings?.length) {
                html += renderFiqh(lesson.fiqh);
            }

            // Questions Section
            if (lesson.questions?.trueFalse?.length) {
                html += renderQuestions(lesson.questions);
            }

            // Benefits Section
            if (lesson.benefits?.length) {
                html += renderBenefits(lesson.benefits);
            }

            // Stories Section
            if (lesson.stories?.length) {
                html += renderStories(lesson.stories);
            }

            // Analysis Section
            if (lesson.analysis?.map?.length || lesson.analysis?.actionPlan || lesson.analysis?.conclusion) {
                html += renderAnalysis(lesson.analysis);
            }

            // ============ DYNAMIC SECTIONS (Custom/Unknown) ============
            // Render any additional sections not handled above
            const knownKeys = ['title', 'subtitle', 'tags', 'rawContent', 'status', 'aiAnalyzed',
                'overview', 'podcast', 'characters', 'quranHadith', 'fiqh',
                'questions', 'benefits', 'stories', 'analysis', '_id', 'createdAt', 'updatedAt', '__v'];

            for (const [key, value] of Object.entries(lesson)) {
                if (knownKeys.includes(key)) continue;
                if (value === null || value === undefined) continue;
                if (Array.isArray(value) && value.length === 0) continue;
                if (typeof value === 'object' && Object.keys(value).length === 0) continue;

                html += renderDynamicSection(key, value);
            }

            container.innerHTML = html;
        }

        // ============ Dynamic Section Renderer (Ù…Ø¹ Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©) ============
        // Sanitize helper for XSS protection
        function sanitize(text) {
            if (typeof DOMPurify !== 'undefined') {
                return DOMPurify.sanitize(String(text));
            }
            // Fallback: basic HTML entity encoding
            return String(text).replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[m]));
        }

        // ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„Ø¹Ø±Ø¨ÙŠ
        function translateKey(key) {
            return SUB_KEY_LABELS[key] || key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1');
        }

        // Ø¹Ø±Ø¶ Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ø¨Ø´ÙƒÙ„ Ø°ÙƒÙŠ (recursive)
        function smartRenderValue(value) {
            if (value === null || value === undefined) return '';
            if (typeof value === 'boolean') return value ? 'âœ… Ù†Ø¹Ù…' : 'âŒ Ù„Ø§';
            if (typeof value === 'string' || typeof value === 'number') return String(value);
            if (Array.isArray(value)) {
                if (value.length === 0) return '';
                if (typeof value[0] === 'string' || typeof value[0] === 'number') {
                    return '<ul class="styled-list">' + value.map(v => '<li>' + v + '</li>').join('') + '</ul>';
                }
                // Array of objects
                return value.map(item => smartRenderObject(item)).join('');
            }
            if (typeof value === 'object') {
                return smartRenderObject(value);
            }
            return String(value);
        }

        // Ø¹Ø±Ø¶ Object ÙƒÙƒØ§Ø±Øª Ø¬Ù…ÙŠÙ„ Ù…Ø¹ ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
        function smartRenderObject(obj) {
            if (!obj || typeof obj !== 'object') return String(obj || '');

            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            const title = obj.title || obj.name || obj.term || obj.question || obj.mistake || obj.front || '';
            const content = obj.content || obj.description || obj.meaning || obj.definition || obj.explanation
                || obj.answer || obj.correction || obj.back || obj.application || obj.text || '';
            const icon = obj.icon || '';

            // Ù…ÙØ§ØªÙŠØ­ ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†/Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ù†ØªØ¬Ø§Ù‡Ù„Ù‡Ø§ ÙÙŠ Ø§Ù„ØªÙØ§ØµÙŠÙ„)
            const usedKeys = ['title', 'name', 'term', 'question', 'mistake', 'front',
                'content', 'description', 'meaning', 'definition', 'explanation',
                'answer', 'correction', 'back', 'application', 'text', 'icon'];

            // Ø¨Ø§Ù‚ÙŠ Ø§Ù„ØªÙØ§ØµÙŠÙ„
            const details = [];
            for (const [k, v] of Object.entries(obj)) {
                if (usedKeys.includes(k)) continue;
                if (v === null || v === undefined || v === '') continue;

                const label = translateKey(k);

                if (Array.isArray(v)) {
                    if (v.length === 0) continue;
                    if (typeof v[0] === 'string' || typeof v[0] === 'number') {
                        details.push('<div class="sub-section"><strong>' + label + ':</strong><ul class="styled-list">' +
                            v.map(item => '<li>' + item + '</li>').join('') + '</ul></div>');
                    } else {
                        details.push('<div class="sub-section"><strong>' + label + ':</strong>' +
                            v.map(item => smartRenderObject(item)).join('') + '</div>');
                    }
                } else if (typeof v === 'object' && v !== null) {
                    details.push('<div class="sub-section"><strong>' + label + ':</strong>' +
                        smartRenderObject(v) + '</div>');
                } else if (typeof v === 'boolean') {
                    details.push('<span class="badge">' + label + ': ' + (v ? 'âœ… Ù†Ø¹Ù…' : 'âŒ Ù„Ø§') + '</span>');
                } else {
                    details.push('<span class="badge">' + label + ': ' + v + '</span>');
                }
            }

            return '<div class="card">' +
                (icon ? '<span style="font-size:1.3em;margin-left:8px;">' + icon + '</span>' : '') +
                (title ? '<h4>' + title + '</h4>' : '') +
                (content ? '<p>' + content + '</p>' : '') +
                (details.length ? '<div class="badges" style="margin-top:8px;flex-wrap:wrap;gap:6px;">' + details.join(' ') + '</div>' : '') +
                '</div>';
        }

        function renderDynamicSection(key, data) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
            const sectionInfo = SECTION_LABELS[key];
            const label = sectionInfo ? sectionInfo.name : key.charAt(0).toUpperCase() + key.slice(1).replace(/([A-Z])/g, ' $1');
            const icon = sectionInfo ? sectionInfo.icon : 'âœ¨';

            let contentHtml = '';

            if (Array.isArray(data)) {
                if (data.length === 0) {
                    contentHtml = '<p style="color:#888;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…</p>';
                } else if (typeof data[0] === 'string' || typeof data[0] === 'number') {
                    // Ù‚Ø§Ø¦Ù…Ø© Ù†ØµÙˆØµ Ø¨Ø³ÙŠØ·Ø©
                    contentHtml = '<ul class="styled-list">' +
                        data.map(item => '<li>' + item + '</li>').join('') + '</ul>';
                } else {
                    // Ù‚Ø§Ø¦Ù…Ø© Objects â†’ ÙƒØ±ÙˆØª
                    contentHtml = '<div class="cards-grid">' +
                        data.map(item => smartRenderObject(item)).join('') + '</div>';
                }
            } else if (typeof data === 'object' && data !== null) {
                // Object ÙˆØ§Ø­Ø¯ â†’ Ø¹Ø±Ø¶ ÙƒÙ„ Ù…ÙØªØ§Ø­ Ø¨ØªØ±Ø¬Ù…ØªÙ‡
                const items = [];
                for (const [k, v] of Object.entries(data)) {
                    if (v === null || v === undefined || v === '') continue;
                    const subLabel = translateKey(k);

                    if (Array.isArray(v)) {
                        if (v.length === 0) continue;
                        if (typeof v[0] === 'string' || typeof v[0] === 'number') {
                            items.push('<div class="card"><h4>' + subLabel + '</h4>' +
                                '<ul class="styled-list">' + v.map(item => '<li>' + item + '</li>').join('') + '</ul></div>');
                        } else {
                            items.push('<div class="card"><h4>' + subLabel + '</h4>' +
                                v.map(item => smartRenderObject(item)).join('') + '</div>');
                        }
                    } else if (typeof v === 'object' && v !== null) {
                        items.push('<div class="card"><h4>' + subLabel + '</h4>' +
                            smartRenderObject(v) + '</div>');
                    } else if (typeof v === 'boolean') {
                        items.push('<p><strong>' + subLabel + ':</strong> ' + (v ? 'âœ… Ù†Ø¹Ù…' : 'âŒ Ù„Ø§') + '</p>');
                    } else {
                        items.push('<p><strong>' + subLabel + ':</strong> ' + v + '</p>');
                    }
                }
                contentHtml = items.join('');
            } else {
                // Ù‚ÙŠÙ…Ø© Ø¨Ø³ÙŠØ·Ø© (Ù†Øµ/Ø±Ù‚Ù…)
                contentHtml = '<p>' + data + '</p>';
            }

            return '<section id="' + key + '" class="section dynamic-section">' +
                '<h2 class="section-title"><span>' + icon + '</span> ' + label + '</h2>' +
                '<div class="card featured">' + contentHtml + '</div>' +
                '</section>';
        }


        // ============ Render Sections ============
        function renderOverview(overview) {
            return `
                <section id="overview" class="section">
                    <h2 class="section-title"><span>ğŸ“‹</span> Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h2>
                    
                    ${overview.message ? `
                    <div class="card featured">
                        <h3>ğŸ¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</h3>
                        <p class="highlight-text">"${overview.message}"</p>
                    </div>
                    ` : ''
                }

                    ${(overview.lessonMap || overview.mapItems)?.length ? `
                    <div class="card">
                        <h3>ğŸ—ºï¸ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¯Ø±Ø³</h3>
                        <div class="grid-2">
                            ${(overview.lessonMap || overview.mapItems).map(item => `
                                <div class="mini-card">
                                    <div class="mini-icon">${item.icon || 'ğŸ“Œ'}</div>
                                    <h4>${item.title}</h4>
                                    <p>${item.description}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''
                }

                    ${overview.points?.length ? `
                    <div class="card">
                        <h3>ğŸ“Œ Ù…Ù„Ø®Øµ ${overview.points.length} Ù†Ù‚Ø§Ø· Ø±Ø¦ÙŠØ³ÙŠØ©</h3>
                        <div class="points-list">
                            ${overview.points.map((point, i) => {
                    const pointText = typeof point === 'object' ? (point.text || point.title || '') : point;
                    const pointIcon = typeof point === 'object' ? (point.icon || 'ğŸŒŸ') : 'ğŸŒŸ';
                    const pointNum = typeof point === 'object' ? (point.num || i + 1) : i + 1;
                    return `
                                <div class="point">
                                    <span class="point-num">${pointNum}</span>
                                    <span class="point-icon">${pointIcon}</span>
                                    <span>${pointText}</span>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                    ` : ''
                }
                </section>
            `;
        }

        function renderPodcast(podcast) {
            return `
                <section id="podcast" class="section">
                    <h2 class="section-title"><span>ğŸ™ï¸</span> Ø§Ù„Ø¨ÙˆØ¯ÙƒØ§Ø³Øª</h2>
                    <div class="timeline">
                        ${podcast.map((item, i) => `
                            <div class="timeline-item ${item.type === 'red' ? 'red' : ''}">
                                <div class="timeline-badge">${i + 1}</div>
                                <div class="timeline-content">
                                    <h4>${item.title}</h4>
                                    <p>${item.content}</p>
                                    ${item.quote ? `<div class="quote">"${item.quote}"</div>` : ''}
                                    ${item.highlight ? `<div class="highlight-box">${item.highlight}</div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </section>
            `;
        }

        function renderCharacters(characters) {
            const colors = ['gold', 'blue', 'yellow', 'purple'];
            const icons = ['â­', 'ğŸŒŸ', 'ğŸ’›', 'ğŸƒ', 'ğŸ‘¤'];

            return `
                <section id="characters" class="section">
                    <h2 class="section-title"><span>ğŸ‘¥</span> Ø§Ù„Ø´Ø®ØµÙŠØ§Øª</h2>
                    <div class="characters-grid">
                        ${characters.map((char, i) => `
                            <div class="character-card ${char.color || colors[i % colors.length]}">
                                <div class="char-header">
                                    <span class="char-icon">${char.icon || icons[i % icons.length]}</span>
                                    <div>
                                        <h4>${char.name}</h4>
                                        <span class="char-type">${char.type || char.role || ''}</span>
                                    </div>
                                </div>
                                ${char.events?.length ? `
                                <ul class="char-events">
                                    ${char.events.map(e => `<li>${e}</li>`).join('')}
                                </ul>
                                ` : ''}
                                ${char.lessons?.length ? `
                                <div class="char-lessons">
                                    ${char.lessons.map(l => `<span>${l}</span>`).join('')}
                                </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </section>
            `;
        }

        function renderQuranHadith(qh) {
            return `
                <section id="quran" class="section">
                    <h2 class="section-title"><span>ğŸ“–</span> Ø§Ù„Ø¢ÙŠØ§Øª ÙˆØ§Ù„Ø£Ø­Ø§Ø¯ÙŠØ«</h2>
                    
                    ${qh.ayat?.length ? `
                    <div class="card">
                        <h3>ğŸ“— Ø§Ù„Ø¢ÙŠØ§Øª Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ©</h3>
                        <div class="ayat-list">
                            ${qh.ayat.map(ayah => `
                                <div class="ayah-card" onclick="copyText(this)">
                                    <p class="ayah-text">${ayah.text}</p>
                                    <div class="ayah-info">
                                        <span class="surah">${ayah.surah}</span>
                                        <span class="meaning">${ayah.meaning || ''}</span>
                                    </div>
                                    <span class="copy-hint">ğŸ“‹ Ø§Ø¶ØºØ· Ù„Ù„Ù†Ø³Ø®</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''
                }

                    ${qh.hadith?.length ? `
                    <div class="card">
                        <h3>ğŸ“• Ø§Ù„Ø£Ø­Ø§Ø¯ÙŠØ« Ø§Ù„Ù†Ø¨ÙˆÙŠØ©</h3>
                        <div class="hadith-list">
                            ${qh.hadith.map(h => `
                                <div class="hadith-card" onclick="copyText(this)">
                                    <p class="hadith-text">"${h.text}"</p>
                                    <p class="hadith-purpose">ğŸ¯ ${h.purpose || ''}</p>
                                    <span class="copy-hint">ğŸ“‹ Ø§Ø¶ØºØ· Ù„Ù„Ù†Ø³Ø®</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''
                }

                    ${qh.duaa?.length ? `
                    <div class="card">
                        <h3>ğŸ¤² Ø§Ù„Ø£Ø¯Ø¹ÙŠØ©</h3>
                        <div class="dua-list">
                            ${qh.duaa.map(d => `
                                <div class="dua-card" onclick="copyText(this)">
                                    <p class="dua-text">${d.text}</p>
                                    <span class="dua-type">${d.type || ''}</span>
                                    <span class="copy-hint">ğŸ“‹ Ø§Ø¶ØºØ· Ù„Ù„Ù†Ø³Ø®</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''
                }
                </section>
            `;
        }

        function renderFiqh(fiqh) {
            return `
                <section id="fiqh" class="section">
                    <h2 class="section-title"><span>ğŸ•Œ</span> ${fiqh.title || 'Ø§Ù„Ø£Ø­ÙƒØ§Ù… Ø§Ù„ÙÙ‚Ù‡ÙŠØ©'}</h2>
                    
                    ${fiqh.rewards?.length ? `
                    <div class="card">
                        <h3>ğŸ Ø«ÙˆØ§Ø¨ Ø§Ù„ØªØ¨ÙƒÙŠØ±</h3>
                        <div class="rewards-grid">
                            ${fiqh.rewards.map(r => `
                                <div class="reward-item ${r.color || 'gold'}">
                                    <span class="reward-time">${r.time}</span>
                                    <span class="reward-value">${r.icon || ''} ${r.reward || r.value}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''
                }

                    ${fiqh.sunan?.length ? `
                    <div class="card">
                        <h3>âœ… Ø§Ù„Ø³Ù†Ù†</h3>
                        <div class="sunan-grid">
                            ${fiqh.sunan.map(s => `
                                <div class="sunan-item">
                                    <span>${s.icon || 'âœ¨'}</span>
                                    ${s.text || s}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''
                }

                    ${fiqh.warnings?.length ? `
                    <div class="card warning">
                        <h3>ğŸš« Ø§Ù„Ù…Ø­Ø°ÙˆØ±Ø§Øª</h3>
                        <ul class="warning-list">
                            ${fiqh.warnings.map(w => `<li>${w}</li>`).join('')}
                        </ul>
                        ${fiqh.warningHadith ? `<div class="hadith-box">"${fiqh.warningHadith}"</div>` : ''}
                    </div>
                    ` : ''
                }

                    ${fiqh.qa?.length ? `
                    <div class="card">
                        <h3>â“ Ù…Ø³Ø§Ø¦Ù„ ÙÙ‚Ù‡ÙŠØ©</h3>
                        <div class="fiqh-qa">
                            ${fiqh.qa.map(q => {
                    const question = q.question || q.q;
                    const answer = q.answer || q.a;
                    const isCorrect = q.isCorrect === true || q.correct === true;
                    return `
                                <div class="fiqh-item">
                                    <div class="fiqh-q">${question}</div>
                                    <div class="fiqh-a">${isCorrect ? 'âœ…' : 'âŒ'} ${answer}</div>
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                    ` : ''
                }
                </section>
            `;
        }

        function renderQuestions(questions) {
            return `
                <section id="questions" class="section">
                    <h2 class="section-title"><span>â“</span> Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h2>
                    
                    ${questions.trueFalse?.length ? `
                    <div class="card">
                        <h3>âœ… ØµØ­ Ø£Ù… Ø®Ø·Ø£</h3>
                        <div class="quiz-list">
                            ${questions.trueFalse.map(q => {
                // Handle both boolean and string answers
                const isCorrect = q.isCorrect === true || q.answer === true || q.answer === 'ØµØ­' || q.answer === 'ØµØ­ÙŠØ­';
                const answerText = typeof q.answer === 'boolean'
                    ? (q.answer ? 'ØµØ­ÙŠØ­ âœ“' : 'Ø®Ø·Ø£ âœ—')
                    : (q.answer || (isCorrect ? 'ØµØ­ÙŠØ­' : 'Ø®Ø·Ø£'));
                const explanation = q.explanation || '';
                return `
                                <div class="quiz-item">
                                    <span class="quiz-q">${q.question}</span>
                                    <span class="quiz-a ${isCorrect ? 'correct' : 'wrong'}">
                                        ${isCorrect ? 'âœ…' : 'âŒ'} ${answerText}
                                    </span>
                                    ${explanation ? `<p class="quiz-explanation" style="color:#888;font-size:0.9em;margin-top:5px;">ğŸ’¡ ${explanation}</p>` : ''}
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                    ` : ''
                }
                </section>
            `;
        }

        function renderBenefits(benefits) {
            const colors = ['green', 'blue', 'purple', 'red', 'yellow'];

            return `
                <section id="benefits" class="section">
                    <h2 class="section-title"><span>ğŸ’</span> Ø§Ù„ÙÙˆØ§Ø¦Ø¯</h2>
                    <div class="benefits-table">
                        <div class="benefits-header">
                            <span>#</span>
                            <span>Ø§Ù„ÙØ§Ø¦Ø¯Ø©</span>
                            <span>Ø§Ù„ØªØµÙ†ÙŠÙ</span>
                        </div>
                        ${benefits.map((b, i) => `
                            <div class="benefit-row">
                                <span>${i + 1}</span>
                                <span>${b.text || b}</span>
                                <span class="benefit-tag ${b.color || colors[i % colors.length]}">${b.category || 'Ø¹Ø§Ù…Ø©'}</span>
                            </div>
                        `).join('')}
                    </div>
                </section>
            `;
        }

        function renderStories(stories) {
            return `
                <section id="stories" class="section">
                    <h2 class="section-title"><span>ğŸ“š</span> Ø§Ù„Ù‚ØµØµ</h2>
                    ${stories.map(story => `
                        <div class="story-card">
                            <h3>ğŸ“– ${story.title}</h3>
                            <div class="story-stages">
                                ${story.stages?.map(stage => `
                                    <div class="stage">
                                        <span class="stage-num">${stage.num}</span>
                                        <div class="stage-content">
                                            <h4>${stage.title}</h4>
                                            <p>${stage.content}</p>
                                        </div>
                                    </div>
                                `).join('') || `<p>${story.content || ''}</p>`}
                            </div>
                        </div>
                    `).join('')
                }
                </section>
            `;
        }

        function renderAnalysis(analysis) {
            return `
                <section id="analysis" class="section">
                    <h2 class="section-title"><span>ğŸ”</span> Ø§Ù„ØªØ­Ù„ÙŠÙ„</h2>
                    
                    ${analysis.map?.length ? `
                    <div class="card">
                        <h3>ğŸ—ºï¸ Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„</h3>
                        <div class="grid-2">
                            ${analysis.map.map(item => `
                                <div class="mini-card">
                                    <div class="mini-icon">${item.icon || 'ğŸ“Œ'}</div>
                                    <h4>${item.title}</h4>
                                    <p>${item.content}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${analysis.actionPlan ? `
                    <div class="card">
                        <h3>ğŸ“‹ Ø®Ø·Ø© Ø§Ù„Ø¹Ù…Ù„</h3>
                        ${analysis.actionPlan.immediate?.length ? `
                            <div class="action-section">
                                <h4 style="color: #e74c3c;">âš¡ ÙÙˆØ±ÙŠ</h4>
                                <ul class="styled-list">${analysis.actionPlan.immediate.map(a => `<li>${a}</li>`).join('')}</ul>
                            </div>
                        ` : ''}
                        ${analysis.actionPlan.shortTerm?.length ? `
                            <div class="action-section">
                                <h4 style="color: #f39c12;">ğŸ“… Ù‚Ø±ÙŠØ¨ Ø§Ù„Ù…Ø¯Ù‰</h4>
                                <ul class="styled-list">${analysis.actionPlan.shortTerm.map(a => `<li>${a}</li>`).join('')}</ul>
                            </div>
                        ` : ''}
                        ${analysis.actionPlan.longTerm?.length ? `
                            <div class="action-section">
                                <h4 style="color: #27ae60;">ğŸ¯ Ø¨Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø¯Ù‰</h4>
                                <ul class="styled-list">${analysis.actionPlan.longTerm.map(a => `<li>${a}</li>`).join('')}</ul>
                            </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    ${analysis.conclusion ? `
                    <div class="card featured">
                        <h3>ğŸ“ Ø§Ù„Ø®Ù„Ø§ØµØ©</h3>
                        <p class="highlight-text">"${analysis.conclusion}"</p>
                    </div>
                    ` : ''}
                </section>
            `;
        }

        // ============ Navigation ============
        function initNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');

            navLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();

                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');

                    const targetId = this.getAttribute('href').substring(1);
                    const targetSection = document.getElementById(targetId);

                    if (targetSection) {
                        const navHeight = document.querySelector('.main-nav').offsetHeight;
                        const targetPosition = targetSection.offsetTop - navHeight - 10;

                        window.scrollTo({
                            top: targetPosition,
                            behavior: 'smooth'
                        });
                    }
                });
            });

            // Scroll tracking
            window.addEventListener('scroll', () => {
                const sections = document.querySelectorAll('.section');
                let current = '';
                const navHeight = document.querySelector('.main-nav')?.offsetHeight || 60;

                sections.forEach(section => {
                    const sectionTop = section.offsetTop - navHeight - 50;
                    if (window.scrollY >= sectionTop) {
                        current = section.getAttribute('id');
                    }
                });

                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.getAttribute('href') === '#' + current) {
                        link.classList.add('active');
                    }
                });
            });
        }

        // ============ Utilities ============
        function copyText(element) {
            const text = element.querySelector('.ayah-text, .hadith-text, .dua-text')?.textContent || element.textContent;
            navigator.clipboard.writeText(text.trim()).then(() => {
                showToast('ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¨Ù†Ø¬Ø§Ø­! ğŸ“‹');
            });
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        function initScrollTop() {
            const scrollTopBtn = document.getElementById('scrollTop');
            window.addEventListener('scroll', () => {
                if (window.scrollY > 500) {
                    scrollTopBtn.classList.add('visible');
                } else {
                    scrollTopBtn.classList.remove('visible');
                }
            });

            scrollTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }

        function initSearch() {
            const searchBtn = document.getElementById('searchBtn');
            const searchModal = document.getElementById('searchModal');
            const searchInput = document.getElementById('searchInput');

            searchBtn.addEventListener('click', () => {
                searchModal.classList.add('active');
                searchInput.focus();
            });

            searchModal.addEventListener('click', (e) => {
                if (e.target === searchModal) closeSearch();
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeSearch();
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    searchModal.classList.add('active');
                    searchInput.focus();
                }
            });
        }

        function closeSearch() {
            document.getElementById('searchModal').classList.remove('active');
            document.getElementById('searchInput').value = '';
        }
    </script>
</body>

</html>